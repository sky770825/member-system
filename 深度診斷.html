<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ·±åº¦è¨ºæ–·å·¥å…·</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 800px;
    margin: 20px auto;
    padding: 20px;
    background: #f5f5f5;
  }
  
  .card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin: 15px 0;
  }
  
  h1 { color: #667eea; margin-top: 0; }
  h2 { color: #764ba2; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 8px; }
  
  .status {
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
    font-family: monospace;
    white-space: pre-wrap;
    word-break: break-all;
    font-size: 13px;
  }
  
  .success { background: #d4edda; border-left: 4px solid #28a745; }
  .error { background: #f8d7da; border-left: 4px solid #dc3545; }
  .info { background: #d1ecf1; border-left: 4px solid #0c5460; }
  .warning { background: #fff3cd; border-left: 4px solid #ffc107; }
  
  button {
    background: #667eea;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    margin: 5px;
    font-size: 14px;
    font-weight: bold;
  }
  
  button:hover { background: #5568d3; }
  button:disabled { background: #ccc; cursor: not-allowed; }
  
  .btn-success { background: #28a745; }
  .btn-success:hover { background: #218838; }
  
  .btn-danger { background: #dc3545; }
  .btn-danger:hover { background: #c82333; }
</style>
</head>
<body>

<div class="card">
  <h1>ğŸ” æ·±åº¦è¨ºæ–·å·¥å…·</h1>
  <div class="info">
    <strong>ğŸ“ èªªæ˜ï¼š</strong>é€™å€‹å·¥å…·æœƒå®Œæ•´æª¢æŸ¥æ‚¨çš„ LINE ç™»å…¥ã€æœƒå“¡ç‹€æ…‹ã€API é€£æ¥ç­‰æ‰€æœ‰ç’°ç¯€ã€‚
  </div>
  <button onclick="startDiagnosis()">ğŸš€ é–‹å§‹å®Œæ•´è¨ºæ–·</button>
</div>

<div id="results"></div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxh10yJHbTDcwBDTX_V30jRR4CqshDc3pePR0t_rPqCxZg40h636WKIo3-Y--L0cDnP/exec';
let diagResults = [];

function addResult(title, content, type = 'info') {
  const resultsDiv = document.getElementById('results');
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <h2>${title}</h2>
    <div class="status ${type}">${content}</div>
  `;
  resultsDiv.appendChild(card);
  
  diagResults.push({ title, content, type });
}

async function startDiagnosis() {
  document.getElementById('results').innerHTML = '';
  diagResults = [];
  
  addResult('ğŸ” è¨ºæ–·é–‹å§‹', 'é–‹å§‹åŸ·è¡Œå®Œæ•´ç³»çµ±è¨ºæ–·...', 'info');
  
  await step1_CheckLIFF();
  await delay(500);
  await step2_CheckAPI();
  await delay(500);
  await step3_CheckMember();
  await delay(500);
  await step4_TestRegister();
  await delay(500);
  
  generateReport();
}

async function step1_CheckLIFF() {
  addResult('ğŸ“± æ­¥é©Ÿ 1ï¼šæª¢æŸ¥ LIFF åˆå§‹åŒ–', 'æ­£åœ¨æª¢æŸ¥...', 'info');
  
  try {
    await liff.init({ liffId: '2008231108-2PDbO5qk' });
    
    if (!liff.isLoggedIn()) {
      addResult(
        'âŒ LIFF ç™»å…¥ç‹€æ…‹',
        'å°šæœªç™»å…¥ LINE\n\nè«‹ç¨å¾Œï¼Œæ­£åœ¨è·³è½‰åˆ°ç™»å…¥é é¢...',
        'error'
      );
      setTimeout(() => liff.login(), 3000);
      throw new Error('æœªç™»å…¥');
    }
    
    const profile = await liff.getProfile();
    window.lineUserId = profile.userId;
    window.lineProfile = profile;
    
    addResult(
      'âœ… LIFF åˆå§‹åŒ–æˆåŠŸ',
      `LINE User ID: ${profile.userId}\n` +
      `é¡¯ç¤ºåç¨±: ${profile.displayName}\n` +
      `é ­åƒ: ${profile.pictureUrl ? 'æœ‰' : 'ç„¡'}\n` +
      `\nğŸ‰ LIFF å®Œå…¨æ­£å¸¸ï¼`,
      'success'
    );
    
    return true;
  } catch (error) {
    addResult(
      'âŒ LIFF åˆå§‹åŒ–å¤±æ•—',
      `éŒ¯èª¤: ${error.message}\n\n` +
      `å¯èƒ½åŸå› :\n` +
      `1. LIFF ID éŒ¯èª¤\n` +
      `2. Endpoint URL æœªè¨­å®š\n` +
      `3. LINE ç‰ˆæœ¬éèˆŠ`,
      'error'
    );
    return false;
  }
}

async function step2_CheckAPI() {
  addResult('ğŸ”Œ æ­¥é©Ÿ 2ï¼šæª¢æŸ¥ API é€£æ¥', 'æ­£åœ¨æ¸¬è©¦ API...', 'info');
  
  try {
    const response = await fetch(API_URL);
    const data = await response.json();
    
    if (data.message === 'æœªçŸ¥çš„æ“ä½œ') {
      addResult(
        'âœ… API é€£æ¥æ­£å¸¸',
        `HTTP ç‹€æ…‹: 200 OK\n` +
        `å›æ‡‰: ${JSON.stringify(data)}\n` +
        `\nğŸ‰ API å®Œå…¨æ­£å¸¸ï¼`,
        'success'
      );
      return true;
    } else {
      addResult(
        'âš ï¸ API å›æ‡‰ç•°å¸¸',
        `å›æ‡‰: ${JSON.stringify(data, null, 2)}`,
        'warning'
      );
      return false;
    }
  } catch (error) {
    addResult(
      'âŒ API é€£æ¥å¤±æ•—',
      `éŒ¯èª¤: ${error.message}\n\n` +
      `å¯èƒ½åŸå› :\n` +
      `1. API URL éŒ¯èª¤\n` +
      `2. ç¶²è·¯å•é¡Œ\n` +
      `3. CORS å•é¡Œ`,
      'error'
    );
    return false;
  }
}

async function step3_CheckMember() {
  if (!window.lineUserId) {
    addResult('â­ï¸ è·³éæœƒå“¡æª¢æŸ¥', 'å› ç‚º LIFF æœªç™»å…¥', 'warning');
    return false;
  }
  
  addResult('ğŸ‘¤ æ­¥é©Ÿ 3ï¼šæª¢æŸ¥æœƒå“¡ç‹€æ…‹', `æª¢æŸ¥ User ID: ${window.lineUserId}`, 'info');
  
  try {
    const response = await fetch(`${API_URL}?action=profile&lineUserId=${window.lineUserId}`);
    const data = await response.json();
    
    console.log('æœƒå“¡æª¢æŸ¥ API å›æ‡‰:', data);
    
    if (data.success && data.name) {
      addResult(
        'âœ… æ‚¨å·²ç¶“æ˜¯æœƒå“¡ï¼',
        `å§“å: ${data.name}\n` +
        `æ‰‹æ©Ÿ: ${data.phone}\n` +
        `Email: ${data.email || 'æœªè¨­å®š'}\n` +
        `é»æ•¸: ${data.points} é»\n` +
        `æœƒå“¡ç­‰ç´š: ${data.memberLevel}\n` +
        `æ¨è–¦ç¢¼: ${data.referralCode}\n` +
        `è¨»å†Šæ™‚é–“: ${data.createdAt}\n` +
        `\nğŸ‰ æœƒå“¡è³‡æ–™æ­£å¸¸ï¼å¯ä»¥ç›´æ¥ä½¿ç”¨ç³»çµ±ï¼`,
        'success'
      );
      
      document.getElementById('results').innerHTML += `
        <div class="card">
          <button onclick="window.location.href='profile.html'" class="btn-success">
            ğŸ‘¤ å‰å¾€æœƒå“¡ä¸­å¿ƒ
          </button>
        </div>
      `;
      
      return true;
    } else {
      addResult(
        'âŒ æ‚¨é‚„ä¸æ˜¯æœƒå“¡',
        `API å›æ‡‰: ${JSON.stringify(data, null, 2)}\n` +
        `\nğŸ¯ é€™å°±æ˜¯å¾ªç’°çš„åŸå› ï¼\n` +
        `æ‚¨éœ€è¦å®Œæˆè¨»å†Šæµç¨‹ã€‚`,
        'warning'
      );
      
      return false;
    }
  } catch (error) {
    addResult(
      'âŒ æœƒå“¡æª¢æŸ¥å¤±æ•—',
      `éŒ¯èª¤: ${error.message}\n\n` +
      `å¯èƒ½åŸå› :\n` +
      `1. API è«‹æ±‚å¤±æ•—\n` +
      `2. ç¶²è·¯å•é¡Œ\n` +
      `3. å·¥ä½œè¡¨è¨ªå•éŒ¯èª¤`,
      'error'
    );
    return false;
  }
}

async function step4_TestRegister() {
  if (!window.lineUserId) {
    addResult('â­ï¸ è·³éè¨»å†Šæ¸¬è©¦', 'å› ç‚º LIFF æœªç™»å…¥', 'warning');
    return;
  }
  
  addResult('ğŸ“ æ­¥é©Ÿ 4ï¼šæ¸¬è©¦è¨»å†ŠåŠŸèƒ½', 'æ¸¬è©¦æ˜¯å¦èƒ½æ­£å¸¸è¨»å†Š...', 'info');
  
  const testPhone = '0912-' + Math.floor(Math.random() * 1000).toString().padStart(3, '0') + '-' + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
  
  try {
    const url = `${API_URL}?action=register&` +
                `lineUserId=TEST-${Date.now()}&` +
                `name=è¨ºæ–·æ¸¬è©¦&` +
                `phone=${testPhone}&` +
                `email=test@example.com&` +
                `birthday=&` +
                `lineName=æ¸¬è©¦&` +
                `linePicture=&` +
                `referralCode=`;
    
    console.log('æ¸¬è©¦è¨»å†Š URL:', url);
    
    const response = await fetch(url);
    const data = await response.json();
    
    console.log('è¨»å†Šæ¸¬è©¦å›æ‡‰:', data);
    
    if (data.success) {
      addResult(
        'âœ… è¨»å†ŠåŠŸèƒ½æ­£å¸¸',
        `æ¸¬è©¦è¨»å†ŠæˆåŠŸï¼\n` +
        `é»æ•¸: ${data.points}\n` +
        `æœƒå“¡ç­‰ç´š: ${data.memberLevel}\n` +
        `æ¨è–¦ç¢¼: ${data.referralCode}\n` +
        `\nğŸ‰ API å¯ä»¥æ­£å¸¸å¯«å…¥ Google Sheetsï¼\n` +
        `å·¥ä½œè¡¨ã€Œæœƒå“¡è³‡æ–™ã€å¯ä»¥æ­£å¸¸è®€å¯«ï¼`,
        'success'
      );
    } else {
      addResult(
        'âš ï¸ è¨»å†Šæ¸¬è©¦å¤±æ•—',
        `éŒ¯èª¤: ${data.message}\n` +
        `å®Œæ•´å›æ‡‰: ${JSON.stringify(data, null, 2)}`,
        'warning'
      );
    }
  } catch (error) {
    addResult(
      'âŒ è¨»å†Šæ¸¬è©¦å¤±æ•—',
      `éŒ¯èª¤: ${error.message}`,
      'error'
    );
  }
}

function generateReport() {
  const resultsDiv = document.getElementById('results');
  
  const successCount = diagResults.filter(r => r.type === 'success').length;
  const errorCount = diagResults.filter(r => r.type === 'error').length;
  const warningCount = diagResults.filter(r => r.type === 'warning').length;
  
  let diagnosis = '';
  let solution = '';
  
  if (successCount === 4) {
    diagnosis = 'âœ… æ‰€æœ‰æª¢æŸ¥éƒ½é€šéï¼ç³»çµ±å®Œå…¨æ­£å¸¸ï¼';
    solution = 'æ‚¨å¯ä»¥æ­£å¸¸ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ã€‚å¦‚æœé‚„æœ‰å•é¡Œï¼Œè«‹æ¸…é™¤ç€è¦½å™¨å¿«å–å¾Œé‡è©¦ã€‚';
  } else if (errorCount > 0) {
    diagnosis = 'âŒ ç™¼ç¾åš´é‡å•é¡Œï¼';
    solution = 'è«‹æŸ¥çœ‹ä¸Šæ–¹ç´…è‰²çš„éŒ¯èª¤è¨Šæ¯ï¼Œæ ¹æ“šæç¤ºè§£æ±ºå•é¡Œã€‚';
  } else if (warningCount > 0) {
    diagnosis = 'âš ï¸ ç™¼ç¾æ½›åœ¨å•é¡Œ';
    solution = 'æ‚¨å¯èƒ½é‚„æ²’è¨»å†Šï¼Œæˆ–è¨»å†Šè³‡æ–™æœ‰å•é¡Œã€‚è«‹ä½¿ç”¨ä¸‹æ–¹æŒ‰éˆ•å®Œæˆè¨»å†Šã€‚';
  }
  
  resultsDiv.innerHTML += `
    <div class="card" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
      <h2 style="color: white; border-color: white;">ğŸ“Š è¨ºæ–·ç¸½çµ</h2>
      <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin: 10px 0;">
        <strong>æª¢æŸ¥é …ç›®ï¼š</strong> ${diagResults.length}<br>
        <strong>âœ… é€šéï¼š</strong> ${successCount}<br>
        <strong>âŒ å¤±æ•—ï¼š</strong> ${errorCount}<br>
        <strong>âš ï¸ è­¦å‘Šï¼š</strong> ${warningCount}
      </div>
      <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin: 10px 0;">
        <strong>è¨ºæ–·çµæœï¼š</strong><br>${diagnosis}
      </div>
      <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin: 10px 0;">
        <strong>å»ºè­°æ–¹æ¡ˆï¼š</strong><br>${solution}
      </div>
    </div>
  `;
  
  // æ ¹æ“šçµæœé¡¯ç¤ºæ“ä½œæŒ‰éˆ•
  if (warningCount > 0 && window.lineUserId) {
    resultsDiv.innerHTML += `
      <div class="card">
        <h2>ğŸ¯ å»ºè­°æ“ä½œ</h2>
        <button onclick="goRegister()" class="btn-success" style="font-size: 16px; padding: 15px 30px;">
          ğŸ“ å‰å¾€è¨»å†Šé é¢
        </button>
        <button onclick="checkSheets()" style="font-size: 16px; padding: 15px 30px;">
          ğŸ“Š æª¢æŸ¥ Google Sheets
        </button>
      </div>
    `;
  }
}

function goRegister() {
  if (confirm('ç¢ºå®šè¦å‰å¾€è¨»å†Šé é¢å—ï¼Ÿ\n\nè«‹ç¢ºå¯¦å¡«å¯«å®Œæ•´è³‡æ–™ä¸¦å®Œæˆè¨»å†Šæµç¨‹ã€‚')) {
    window.location.href = 'register.html';
  }
}

function checkSheets() {
  window.open('https://docs.google.com/spreadsheets/d/1EdLfJQzYroQ9WMqVEqcDuMpGwiTPj8gxLaMnGp3umDw/edit', '_blank');
}

function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// è‡ªå‹•é–‹å§‹è¨ºæ–·
window.onload = function() {
  setTimeout(startDiagnosis, 500);
};
</script>

</body>
</html>

