<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¨ºæ–·é»æ•¸è¨˜éŒ„é¡¯ç¤º</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: sans-serif; padding: 20px; }
table { width: 100%; border-collapse: collapse; margin: 20px 0; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
th { background-color: #667eea; color: white; }
.correct { background-color: #e8f5e9; }
.wrong { background-color: #ffebee; }
.warning { background-color: #fff3e0; }
.positive { color: green; font-weight: bold; }
.negative { color: red; font-weight: bold; }
h3 { margin-top: 30px; }
</style>
</head>
<body>
<h1>ğŸ” é»æ•¸è¨˜éŒ„è¨ºæ–·å·¥å…·</h1>
<p>é€™å€‹å·¥å…·æœƒé¡¯ç¤ºæ‚¨çš„äº¤æ˜“è¨˜éŒ„ï¼Œä¸¦æ¨™ç¤ºå‡ºå¯èƒ½æœ‰å•é¡Œçš„è¨˜éŒ„ã€‚</p>

<div id="userInfo"></div>
<div id="output"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzMUwqroi_W_5m7rcjVs-U-o6tEo9W0327BeMmU38Rxinmycd5d1HyyF3BnugGvNF6r/exec";

async function diagnose() {
  try {
    await liff.init({ liffId: "2008231108-0rAX3R5d" });
    
    if (!liff.isLoggedIn()) {
      liff.login({ redirectUri: window.location.href });
      return;
    }

    const profile = await liff.getProfile();
    const currentUserId = profile.userId;
    const displayName = profile.displayName;

    document.getElementById('userInfo').innerHTML = `
      <h3>ğŸ‘¤ ç•¶å‰ç”¨æˆ¶</h3>
      <p><strong>å§“åï¼š</strong>${displayName}</p>
      <p><strong>User IDï¼š</strong>${currentUserId}</p>
    `;

    const res = await fetch(`${API_URL}?action=transactions&lineUserId=${currentUserId}&limit=50`);
    const result = await res.json();
    
    console.log('å®Œæ•´äº¤æ˜“è¨˜éŒ„:', result);
    
    if (!result.success || !result.transactions || result.transactions.length === 0) {
      document.getElementById('output').innerHTML = '<p>æ²’æœ‰äº¤æ˜“è¨˜éŒ„</p>';
      return;
    }
      
    let html = '<h3>ğŸ“Š äº¤æ˜“è¨˜éŒ„è©³ç´°åˆ†æ</h3>';
    html += '<table>';
    html += '<tr>';
    html += '<th>åºè™Ÿ</th>';
    html += '<th>æ™‚é–“</th>';
    html += '<th>äº¤æ˜“é¡å‹</th>';
    html += '<th>åŸå§‹é»æ•¸</th>';
    html += '<th>ç•¶å‰ç”¨æˆ¶è§’è‰²</th>';
    html += '<th>å‰ç«¯é¡¯ç¤º</th>';
    html += '<th>æ˜¯å¦æ­£ç¢º</th>';
    html += '<th>è©³æƒ…</th>';
    html += '</tr>';
    
    let problemCount = 0;
    
    result.transactions.forEach((item, index) => {
      // åˆ¤æ–·ç•¶å‰ç”¨æˆ¶æ˜¯ç™¼é€è€…é‚„æ˜¯æ¥æ”¶è€…
      const isSender = item.senderUserId === currentUserId;
      const isReceiver = item.receiverUserId === currentUserId;
      
      let userRole = '';
      if (isSender && isReceiver) {
        userRole = 'è‡ªå·±è½‰çµ¦è‡ªå·±';
      } else if (isSender) {
        userRole = 'ç™¼é€è€…ï¼ˆè½‰å‡ºï¼‰';
      } else if (isReceiver) {
        userRole = 'æ¥æ”¶è€…ï¼ˆè½‰å…¥ï¼‰';
      } else {
        userRole = 'â“ æœªçŸ¥ï¼ˆå¯èƒ½æœ‰å•é¡Œï¼‰';
      }
      
      // å‰ç«¯çš„é¡¯ç¤ºé‚è¼¯
      const isPositive = [
        'transfer_in',
        'register',
        'admin_add',
        'purchase',
        'referral_purchase_reward',
        'referral_withdraw_reward',
        'referral_bonus',
        'referral_reward',
        'mall_sale'
      ].includes(item.type);
      
      const displayPoints = Math.abs(item.points);
      const displaySign = isPositive ? '+' : '-';
      const frontendDisplay = `${displaySign}${displayPoints}`;
      
      // åˆ¤æ–·æ˜¯å¦æ­£ç¢º
      let isCorrect = false;
      let correctReason = '';
      let rowClass = '';
      
      if (item.type === 'transfer_out') {
        // è½‰å‡ºæ‡‰è©²é¡¯ç¤ºç‚ºè² æ•¸
        if (displaySign === '-') {
          isCorrect = true;
          correctReason = 'âœ… æ­£ç¢º';
          rowClass = 'correct';
        } else {
          isCorrect = false;
          correctReason = 'âŒ éŒ¯èª¤ï¼šè½‰å‡ºæ‡‰è©²æ˜¯ -';
          rowClass = 'wrong';
          problemCount++;
        }
      } else if (item.type === 'transfer_in') {
        // è½‰å…¥æ‡‰è©²é¡¯ç¤ºç‚ºæ­£æ•¸
        if (displaySign === '+') {
          isCorrect = true;
          correctReason = 'âœ… æ­£ç¢º';
          rowClass = 'correct';
        } else {
          isCorrect = false;
          correctReason = 'âŒ éŒ¯èª¤ï¼šè½‰å…¥æ‡‰è©²æ˜¯ +';
          rowClass = 'wrong';
          problemCount++;
        }
      } else if (item.type === 'withdraw' || item.type === 'mall_purchase') {
        // æé ˜å’Œè³¼è²·æ‡‰è©²æ˜¯è² æ•¸
        if (displaySign === '-') {
          isCorrect = true;
          correctReason = 'âœ… æ­£ç¢º';
          rowClass = 'correct';
        } else {
          isCorrect = false;
          correctReason = 'âŒ éŒ¯èª¤ï¼šæ”¯å‡ºæ‡‰è©²æ˜¯ -';
          rowClass = 'wrong';
          problemCount++;
        }
      } else {
        // å…¶ä»–æ”¶å…¥é¡å‹æ‡‰è©²æ˜¯æ­£æ•¸
        if (displaySign === '+') {
          isCorrect = true;
          correctReason = 'âœ… æ­£ç¢º';
          rowClass = 'correct';
        } else {
          correctReason = 'âš ï¸ å¯èƒ½æœ‰å•é¡Œ';
          rowClass = 'warning';
        }
      }
      
      // æª¢æŸ¥é¡å‹èˆ‡ç”¨æˆ¶è§’è‰²æ˜¯å¦åŒ¹é…
      if (item.type === 'transfer_out' && !isSender) {
        correctReason += ' | âš ï¸ transfer_out ä½†ç”¨æˆ¶ä¸æ˜¯ç™¼é€è€…';
        rowClass = 'wrong';
        problemCount++;
      }
      if (item.type === 'transfer_in' && !isReceiver) {
        correctReason += ' | âš ï¸ transfer_in ä½†ç”¨æˆ¶ä¸æ˜¯æ¥æ”¶è€…';
        rowClass = 'wrong';
        problemCount++;
      }
      
      const timestamp = new Date(item.createdAt);
      const timeStr = timestamp.toLocaleString('zh-TW');
      
      html += `<tr class="${rowClass}">`;
      html += `<td>${index + 1}</td>`;
      html += `<td>${timeStr}</td>`;
      html += `<td>${item.type}</td>`;
      html += `<td class="${item.points >= 0 ? 'positive' : 'negative'}">${item.points}</td>`;
      html += `<td>${userRole}</td>`;
      html += `<td class="${displaySign === '+' ? 'positive' : 'negative'}">${frontendDisplay}</td>`;
      html += `<td>${correctReason}</td>`;
      html += `<td>${item.senderName || ''} â†’ ${item.receiverName || ''}</td>`;
      html += '</tr>';
    });
    
    html += '</table>';
    
    html += `<h3>ğŸ“Œ è¨ºæ–·ç¸½çµ</h3>`;
    html += `<p>ç¸½å…±æª¢æŸ¥äº† <strong>${result.transactions.length}</strong> ç­†äº¤æ˜“è¨˜éŒ„</p>`;
    if (problemCount === 0) {
      html += `<p style="color: green; font-weight: bold;">âœ… æ²’æœ‰ç™¼ç¾å•é¡Œï¼æ‰€æœ‰è¨˜éŒ„é¡¯ç¤ºæ­£ç¢ºã€‚</p>`;
    } else {
      html += `<p style="color: red; font-weight: bold;">âŒ ç™¼ç¾ ${problemCount} ç­†å¯èƒ½æœ‰å•é¡Œçš„è¨˜éŒ„ï¼</p>`;
      html += `<p>è«‹æª¢æŸ¥æ¨™è¨˜ç‚ºç´…è‰²æˆ–æ©™è‰²çš„è¨˜éŒ„ã€‚</p>`;
    }
    
    document.getElementById('output').innerHTML = html;
    
  } catch (error) {
    document.getElementById('output').innerHTML = '<p style="color:red;">éŒ¯èª¤: ' + error.message + '</p>';
    console.error('è¨ºæ–·éŒ¯èª¤:', error);
  }
}

diagnose();
</script>
</body>
</html>

