<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æœƒå“¡ä¸­å¿ƒ - æˆ‘çš„é»æ•¸èˆ‡è³‡æ–™</title>
<link rel="stylesheet" href="./assets/style.css">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<meta name="description" content="æŸ¥çœ‹æ‚¨çš„æœƒå“¡è³‡æ–™ã€é»æ•¸é¤˜é¡ã€æ¨è–¦çå‹µç­‰è³‡è¨Š">
</head>
<body>
<div class="container" id="profile">
  <div class="loading">
    <div class="spinner"></div>
    <p style="margin-top: 15px; color: #666;">è¼‰å…¥æœƒå“¡è³‡æ–™ä¸­...</p>
  </div>
</div>

<script src="./assets/utils.js?v=20251017"></script>
<script src="./assets/security.js?v=20251017"></script>
<script>
let lineUserId = '';
let memberData = null;

// åˆå§‹åŒ– LIFF
async function initLiff() {
  try {
    const startTime = Date.now();
    console.log('ğŸ” åˆå§‹åŒ– LIFF...');
    
    // ä½¿ç”¨çµ±ä¸€çš„ LIFF Helper
    const profile = await LiffHelper.init(LIFF_CONFIG.profile, {
      redirectOnError: true
    });
    
    if (!profile) return;
    
    lineUserId = profile.userId;
    console.log('âœ… LINE ç™»å…¥æˆåŠŸ:', profile.displayName);
    
    // æª¢æŸ¥å¿«å–
    const cacheKey = `profile_${lineUserId}`;
    const cached = CacheManager.get(cacheKey);
    
    // å¦‚æœæœ‰å¿«å–ï¼Œå…ˆé¡¯ç¤ºå¿«å–è³‡æ–™
    if (cached && cached.success) {
      console.log('ğŸ“¦ ä½¿ç”¨å¿«å–è³‡æ–™');
      renderProfile(cached, profile.pictureUrl, profile.displayName);
    }
    
    // è¼‰å…¥æœ€æ–°è³‡æ–™
    try {
      console.log('ğŸ”„ è¼‰å…¥æœ€æ–°è³‡æ–™...');
      const data = await apiCall('profile', { lineUserId }, { retryCount: 2 });
      
      if (!data.success) {
        throw new Error(data.message || 'è¼‰å…¥å¤±æ•—');
      }
      
      // æ›´æ–°å¿«å–ï¼ˆ5 åˆ†é˜ï¼‰
      CacheManager.set(cacheKey, data, APP_CONFIG?.cache?.profile || 5 * 60 * 1000);
      
      // æ¸²æŸ“æœ€æ–°è³‡æ–™
      renderProfile(data, profile.pictureUrl, profile.displayName);
      
      const loadTime = Date.now() - startTime;
      console.log(`â±ï¸ è¼‰å…¥æ™‚é–“: ${loadTime}ms`);
      
    } catch (error) {
      // å¦‚æœæœ‰å¿«å–ï¼Œç¹¼çºŒä½¿ç”¨å¿«å–è³‡æ–™
      if (cached) {
        console.warn('âš ï¸ è¼‰å…¥æœ€æ–°è³‡æ–™å¤±æ•—ï¼Œä½¿ç”¨å¿«å–è³‡æ–™');
        UIHelper.showMessage('âš ï¸ ä½¿ç”¨å¿«å–è³‡æ–™ï¼Œå¯èƒ½ä¸æ˜¯æœ€æ–°', 'warning', 3000);
      } else {
        throw error;
      }
    }
    
  } catch (error) {
    logError('initLiff', error);
    console.error('âŒ LIFF åˆå§‹åŒ–éŒ¯èª¤:', error);
    
    document.getElementById("profile").innerHTML = `
      <div class="error-card">
        <div class="error-icon">âŒ</div>
        <h3>è¼‰å…¥å¤±æ•—</h3>
        <p>${error.message || 'è«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«å®¢æœ'}</p>
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
          <button class="btn btn-primary" onclick="initLiff()">
            ğŸ”„ é‡æ–°è¼‰å…¥
          </button>
          <button class="btn btn-outline" onclick="window.location.href='index.html'">
            ğŸ  è¿”å›é¦–é 
          </button>
        </div>
      </div>
    `;
  }
}

// æ¸²æŸ“æœƒå“¡è³‡æ–™
function renderProfile(data, pictureUrl, displayName) {
  memberData = data;
  
  // è¨ˆç®—æœƒå“¡ç­‰ç´šé€²åº¦
  const levelInfo = MemberLevelHelper.getProgress(data.points || 0);
  
  document.getElementById("profile").innerHTML = `
    <div class="profile-card">
      <!-- æœƒå“¡è³‡è¨Šé ‚éƒ¨ -->
      <div class="profile-header">
        <img src="${pictureUrl}" alt="é ­åƒ" class="profile-avatar">
        <div class="profile-header-center">
          <h2 style="text-align:left;margin:0;">${data.name || displayName || 'æœƒå“¡'}</h2>
          <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
            ${levelInfo.current.icon} ${levelInfo.current.name}
          </p>
        </div>
        <div class="points-card">
          <div class="points-icon">ğŸ’°</div>
          <div class="points-info">
            <p class="points-label">ç›®å‰é»æ•¸</p>
            <p class="points-value">${Formatter.points(data.points || 0)} <span>é»</span></p>
          </div>
        </div>
      </div>
      
      <!-- æœƒå“¡ç­‰ç´šé€²åº¦ -->
      ${!levelInfo.isMax ? `
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 20px 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-size: 14px; color: #666;">å‡ç´šé€²åº¦</span>
            <span style="font-size: 14px; font-weight: bold; color: #667eea;">
              é‚„éœ€ ${levelInfo.pointsNeeded} é»å‡ç´šåˆ° ${levelInfo.next.icon} ${levelInfo.next.name}
            </span>
          </div>
          <div style="background: #e0e0e0; border-radius: 10px; height: 10px; overflow: hidden;">
            <div style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${levelInfo.progress}%; transition: width 0.5s ease;"></div>
          </div>
        </div>
      ` : `
        <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center; color: white;">
          <strong>ğŸ‰ æ­å–œï¼æ‚¨å·²æ˜¯æœ€é«˜ç­‰ç´šæœƒå“¡</strong>
        </div>
      `}
      
      <!-- åŸºæœ¬è³‡è¨Š -->
      <div class="profile-info">
        <div class="info-item">
          <span class="info-label">ğŸ“± é›»è©±</span>
          <span class="info-value">${data.phone || 'æœªç™»éŒ„'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">ğŸ“§ Email</span>
          <span class="info-value">${data.email || 'æœªç™»éŒ„'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">ğŸ‚ ç”Ÿæ—¥</span>
          <span class="info-value">${data.birthday ? Formatter.date(data.birthday, 'date') : 'æœªç™»éŒ„'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">ğŸ“… è¨»å†Šæ™‚é–“</span>
          <span class="info-value">${data.createdAt ? Formatter.date(data.createdAt) : '-'}</span>
        </div>
      </div>
      
      <!-- é»æ•¸çµ±è¨ˆ -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0;">
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
          <div style="color: #666; font-size: 13px; margin-bottom: 5px;">ç´¯è¨ˆç²å¾—</div>
          <div style="font-size: 20px; font-weight: bold; color: #4CAF50;">
            ${Formatter.points(data.totalEarned || 0)}
          </div>
        </div>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
          <div style="color: #666; font-size: 13px; margin-bottom: 5px;">ç´¯è¨ˆæ¶ˆè²»</div>
          <div style="font-size: 20px; font-weight: bold; color: #FF6B6B;">
            ${Formatter.points(data.totalSpent || 0)}
          </div>
        </div>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
          <div style="color: #666; font-size: 13px; margin-bottom: 5px;">æ¨è–¦äººæ•¸</div>
          <div style="font-size: 20px; font-weight: bold; color: #667eea;">
            ${data.referralCount || 0}
          </div>
        </div>
      </div>
      
      <!-- ğŸ æ¨è–¦å¥½å‹å€å¡Š -->
      <div class="referral-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; margin: 20px 0; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
          <span style="font-size: 28px;">ğŸ</span>
          <div>
            <h3 style="margin: 0; font-size: 18px; font-weight: bold;">é‚€è«‹å¥½å‹è¨»å†Š</h3>
            <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">é›™æ–¹å„å¾— <strong>50 é»</strong> çå‹µï¼</p>
          </div>
        </div>
        
        <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
          <p style="margin: 0 0 8px 0; font-size: 13px; opacity: 0.9;">æ‚¨çš„æ¨è–¦ç¢¼</p>
          <div style="display: flex; align-items: center; gap: 10px;">
            <input type="text" id="referralCodeDisplay" value="${data.referralCode || 'è¼‰å…¥ä¸­...'}" readonly 
                   style="flex: 1; background: rgba(255,255,255,0.9); border: none; border-radius: 6px; padding: 10px 12px; font-size: 18px; font-weight: bold; letter-spacing: 2px; text-align: center; color: #333;">
            <button onclick="copyReferralCode('${data.referralCode}')" 
                    class="btn-icon-copy"
                    style="background: rgba(255,255,255,0.25); border: 2px solid rgba(255,255,255,0.5); border-radius: 6px; padding: 10px 16px; color: white; font-weight: bold; cursor: pointer; transition: all 0.3s;">
              ğŸ“‹
            </button>
          </div>
        </div>
        
        <div style="display: flex; gap: 8px;">
          <button onclick="shareReferralLink('${data.referralCode}', '${data.name}')" class="btn" 
                  style="flex: 1; background: rgba(255,255,255,0.25); border: 2px solid rgba(255,255,255,0.5); color: white; font-weight: bold; padding: 12px;">
            <span style="font-size: 18px;">ğŸ“¤</span> åˆ†äº«é€£çµ
          </button>
          <button onclick="viewReferralLink('${data.referralCode}')" class="btn" 
                  style="flex: 1; background: rgba(255,255,255,0.25); border: 2px solid rgba(255,255,255,0.5); color: white; font-weight: bold; padding: 12px;">
            <span style="font-size: 18px;">ğŸ”—</span> æŸ¥çœ‹é€£çµ
          </button>
        </div>
        
        <p style="margin: 12px 0 0 0; font-size: 12px; opacity: 0.8; text-align: center;">
          å·²æˆåŠŸæ¨è–¦ <strong style="font-size: 16px; color: #FFD700;">${data.referralCount || 0}</strong> äºº
          ${data.referredBy ? ` | ç”± <strong>${data.referredBy}</strong> æ¨è–¦` : ''}
        </p>
      </div>
      
      <!-- æ“ä½œæŒ‰éˆ• -->
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="goTransfer()">
          <span class="btn-icon">ğŸ’¸</span>
          è½‰é»çµ¦å¥½å‹
        </button>
        <button class="btn btn-secondary" onclick="goHistory()">
          <span class="btn-icon">ğŸ“Š</span>
          é»æ•¸è¨˜éŒ„
        </button>
        <button class="btn btn-outline" onclick="editProfile()">
          <span class="btn-icon">âœï¸</span>
          ç·¨è¼¯è³‡æ–™
        </button>
      </div>
      
      <!-- å¿«é€Ÿæ“ä½œ -->
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px;">
        <button class="btn btn-outline" onclick="refreshData()" style="padding: 12px;">
          ğŸ”„ é‡æ–°æ•´ç†
        </button>
        <button class="btn btn-outline" onclick="clearCache()" style="padding: 12px;">
          ğŸ—‘ï¸ æ¸…é™¤å¿«å–
        </button>
      </div>
      
      <!-- ç™»å‡ºæŒ‰éˆ• -->
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
        <button class="btn btn-outline" onclick="handleLogout()" style="width: 100%; padding: 12px; color: #dc3545; border-color: #dc3545;">
          ğŸšª ç™»å‡ºå¸³è™Ÿ
        </button>
      </div>
    </div>
  `;
}

// ğŸ“‹ è¤‡è£½æ¨è–¦ç¢¼
async function copyReferralCode(code) {
  if (!code || code === 'è¼‰å…¥ä¸­...') {
    UIHelper.showMessage('æ¨è–¦ç¢¼å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦', 'warning');
    return;
  }
  
  const success = await ReferralHelper.copyCode(code);
  if (success) {
    console.log('âœ… æ¨è–¦ç¢¼å·²è¤‡è£½:', code);
  }
}

// ğŸ“¤ åˆ†äº«æ¨è–¦é€£çµ
async function shareReferralLink(code, name = '') {
  if (!code || code === 'è¼‰å…¥ä¸­...') {
    UIHelper.showMessage('æ¨è–¦ç¢¼å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦', 'warning');
    return;
  }
  
  const success = await ReferralHelper.share(code, name);
  console.log(success ? 'âœ… åˆ†äº«æˆåŠŸ' : 'âš ï¸ åˆ†äº«å–æ¶ˆ');
}

// ğŸ”— æŸ¥çœ‹æ¨è–¦é€£çµ
async function viewReferralLink(code) {
  if (!code || code === 'è¼‰å…¥ä¸­...') {
    UIHelper.showMessage('æ¨è–¦ç¢¼å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦', 'warning');
    return;
  }
  
  const link = ReferralHelper.getLink(code);
  
  const confirmed = await UIHelper.confirm(
    'æ‚¨çš„æ¨è–¦é€£çµ',
    `å°‡æ­¤é€£çµåˆ†äº«çµ¦å¥½å‹ï¼Œè¨»å†ŠæˆåŠŸå¾Œé›™æ–¹å„å¾— 50 é»ï¼\n\n${link}`,
    { type: 'info', confirmText: 'ğŸ“‹ è¤‡è£½é€£çµ', cancelText: 'é—œé–‰' }
  );
  
  if (confirmed) {
    await ReferralHelper.copyCode(link);
  }
}

// ğŸ”„ é‡æ–°æ•´ç†è³‡æ–™
async function refreshData() {
  UIHelper.showMessage('ğŸ”„ æ­£åœ¨é‡æ–°è¼‰å…¥...', 'info', 1000);
  
  // æ¸…é™¤ç•¶å‰ç”¨æˆ¶çš„å¿«å–
  CacheManager.remove(`profile_${lineUserId}`);
  
  // é‡æ–°è¼‰å…¥é é¢
  setTimeout(() => {
    window.location.reload();
  }, 500);
}

// ğŸ—‘ï¸ æ¸…é™¤å¿«å–
async function clearCache() {
  const confirmed = await UIHelper.confirm(
    'æ¸…é™¤å¿«å–',
    'ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¿«å–è³‡æ–™å—ï¼Ÿ\nä¸‹æ¬¡è¼‰å…¥æ™‚æœƒé‡æ–°å¾æœå‹™å™¨ç²å–ã€‚',
    { type: 'warning', confirmText: 'ç¢ºå®šæ¸…é™¤', cancelText: 'å–æ¶ˆ' }
  );
  
  if (confirmed) {
    CacheManager.clear();
    UIHelper.showMessage('âœ… å¿«å–å·²æ¸…é™¤', 'success');
    
    setTimeout(() => {
      window.location.reload();
    }, 1000);
  }
}

// ğŸšª ç™»å‡ºåŠŸèƒ½
async function handleLogout() {
  const confirmed = await UIHelper.confirm(
    'ç¢ºèªç™»å‡º',
    'ç¢ºå®šè¦ç™»å‡ºå¸³è™Ÿå—ï¼Ÿ\nç™»å‡ºå¾Œéœ€è¦é‡æ–°ç™»å…¥æ‰èƒ½ä½¿ç”¨ç³»çµ±ã€‚',
    { type: 'warning', confirmText: 'ç¢ºå®šç™»å‡º', cancelText: 'å–æ¶ˆ' }
  );
  
  if (confirmed) {
    UIHelper.showMessage('ğŸ‘‹ æ­£åœ¨ç™»å‡º...', 'info', 2000);
    
    setTimeout(() => {
      LiffHelper.logout();
    }, 1000);
  }
}

// å°èˆªå‡½æ•¸
function goTransfer() {
  window.location.href = "transfer.html";
}

function goHistory() {
  window.location.href = "history.html";
}

function editProfile() {
  window.location.href = "edit.html";
}

// é é¢è¼‰å…¥å®Œæˆ
document.addEventListener('DOMContentLoaded', () => {
  console.log('ğŸ“„ æœƒå“¡ä¸­å¿ƒé é¢è¼‰å…¥å®Œæˆ');
});

// åˆå§‹åŒ–
initLiff();
</script>

<style>
/* æœƒå“¡ä¸­å¿ƒé¡å¤–æ¨£å¼ */
.profile-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 4px solid white;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.btn-icon-copy {
  transition: all 0.3s ease;
}

.btn-icon-copy:hover {
  background: rgba(255,255,255,0.4) !important;
  transform: scale(1.05);
}

.btn-icon-copy:active {
  transform: scale(0.95);
}

.error-card {
  text-align: center;
  padding: 40px 20px;
}

.error-icon {
  font-size: 64px;
  margin-bottom: 20px;
}

.error-card h3 {
  margin: 0 0 10px 0;
  font-size: 24px;
  color: #333;
}

.error-card p {
  color: #666;
  margin: 0 0 20px 0;
}
</style>
</body>
</html>
