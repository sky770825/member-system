<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æœƒå“¡ä¸­å¿ƒ</title>
<link rel="stylesheet" href="./assets/style.css">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container" id="profile">
  <div class="loading">
    <div class="spinner"></div>
    <p style="margin-top: 15px; color: #666;">è¼‰å…¥æœƒå“¡è³‡æ–™ä¸­...</p>
  </div>
</div>

<script>
async function initLiff() {
  try {
    // è¨˜éŒ„é–‹å§‹æ™‚é–“
    const startTime = Date.now();
    
    await liff.init({ liffId: "2008231108-2PDbO5qk" });
    
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    
    const profile = await liff.getProfile();
    const lineUserId = profile.userId;
    const displayName = profile.displayName;
    const pictureUrl = profile.pictureUrl;
    
    // æª¢æŸ¥æœ¬åœ°å¿«å–
    const cacheKey = `profile_${lineUserId}`;
    const cached = getCache(cacheKey);
    
    // å¦‚æœæœ‰å¿«å–ï¼Œå…ˆé¡¯ç¤ºå¿«å–è³‡æ–™
    if (cached) {
      console.log('ä½¿ç”¨å¿«å–è³‡æ–™');
      renderProfile(cached, pictureUrl, displayName);
    }
    
    // åŒæ™‚ç™¼é€ API è«‹æ±‚æ›´æ–°æœ€æ–°è³‡æ–™
    const res = await fetch("https://script.google.com/macros/s/AKfycbzzqEQmYZaVF8kgJ9ilFGH8t-ZC5kE_ZjXrp83C-MFyPdl6lnc2k41o__-HKs3AyKi9/exec?action=profile&lineUserId=" + lineUserId);
    const data = await res.json();
    
    // è¨˜éŒ„è¼‰å…¥æ™‚é–“
    const loadTime = Date.now() - startTime;
    console.log(`è¼‰å…¥æ™‚é–“: ${loadTime}ms`);
    
    // æ›´æ–°å¿«å–ï¼ˆ5 åˆ†é˜æœ‰æ•ˆï¼‰
    setCache(cacheKey, data, 5 * 60 * 1000);
    
    // æ¸²æŸ“æœ€æ–°è³‡æ–™
    renderProfile(data, pictureUrl, displayName);
    
  } catch (error) {
    console.error('LIFF åˆå§‹åŒ–éŒ¯èª¤:', error);
    document.getElementById("profile").innerHTML = `
      <div class="error-card">
        <div class="error-icon">âŒ</div>
        <h3>è¼‰å…¥å¤±æ•—</h3>
        <p>è«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«å®¢æœ</p>
        <button class="btn btn-primary" onclick="initLiff()">é‡æ–°è¼‰å…¥</button>
      </div>
    `;
  }
}

// æ¸²æŸ“æœƒå“¡è³‡æ–™
function renderProfile(data, pictureUrl, displayName) {
  document.getElementById("profile").innerHTML = `
    <div class="profile-card">
      <div class="profile-header">
        <img src="${pictureUrl}" alt="é ­åƒ" class="profile-avatar">
        <div class="profile-header-center">
          <h2 style="text-align:left;margin:0;">${data.name || displayName || 'æœƒå“¡'}</h2>
        </div>
        <div class="points-card">
          <div class="points-icon">ğŸ’°</div>
          <div class="points-info">
            <p class="points-label">ç›®å‰é»æ•¸</p>
            <p class="points-value">${data.points || 0} <span>é»</span></p>
          </div>
        </div>
      </div>
      
      <div class="profile-info">
        <div class="info-item">
          <span class="info-label">ğŸ“± é›»è©±</span>
          <span class="info-value">${data.phone || 'æœªç™»éŒ„'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">ğŸ“§ Email</span>
          <span class="info-value">${data.email || 'æœªç™»éŒ„'}</span>
        </div>
      </div>
      
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="goTransfer()">
          <span class="btn-icon">ğŸ’¸</span>
          è½‰é»çµ¦å¥½å‹
        </button>
        <button class="btn btn-secondary" onclick="goHistory()">
          <span class="btn-icon">ğŸ“Š</span>
          é»æ•¸è¨˜éŒ„
        </button>
        <button class="btn btn-outline" onclick="editProfile()">
          <span class="btn-icon">âœï¸</span>
          ç·¨è¼¯è³‡æ–™
        </button>
      </div>
    </div>
  `;
}

// ç°¡å–®çš„æœ¬åœ°å¿«å–
function setCache(key, data, ttl = 5 * 60 * 1000) {
  const item = {
    data: data,
    expiry: Date.now() + ttl
  };
  try {
    localStorage.setItem(key, JSON.stringify(item));
  } catch (e) {
    console.warn('å¿«å–å„²å­˜å¤±æ•—:', e);
  }
}

function getCache(key) {
  try {
    const item = localStorage.getItem(key);
    if (!item) return null;
    
    const parsed = JSON.parse(item);
    if (Date.now() > parsed.expiry) {
      localStorage.removeItem(key);
      return null;
    }
    
    return parsed.data;
  } catch (e) {
    return null;
  }
}

function goTransfer() {
  window.location.href = "transfer.html";
}

function goHistory() {
  window.location.href = "history.html";
}

function editProfile() {
  window.location.href = "edit.html";
}

initLiff();
</script>
</body>
</html>

