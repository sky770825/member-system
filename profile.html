<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>會員中心</title>
<link rel="stylesheet" href="./assets/style.css">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container" id="profile">
  <div class="loading">
    <div class="spinner"></div>
    <p style="margin-top: 15px; color: #666;">載入會員資料中...</p>
  </div>
</div>

<script>
async function initLiff() {
  try {
    // 記錄開始時間
    const startTime = Date.now();
    
    await liff.init({ liffId: "2008231108-2PDbO5qk" });
    
    if (!liff.isLoggedIn()) {
      // 🔧 優化：使用 redirectUri 保留當前頁面
      liff.login({ redirectUri: window.location.href });
      return;
    }
    
    const profile = await liff.getProfile();
    const lineUserId = profile.userId;
    const displayName = profile.displayName;
    const pictureUrl = profile.pictureUrl;
    
    // 檢查本地快取
    const cacheKey = `profile_${lineUserId}`;
    const cached = getCache(cacheKey);
    
    // 如果有快取，先顯示快取資料
    if (cached) {
      console.log('使用快取資料');
      renderProfile(cached, pictureUrl, displayName);
    }
    
    // 同時發送 API 請求更新最新資料
    const res = await fetch("https://script.google.com/macros/s/AKfycbx2TRenhHm1LWkCtLB1BwQtUO6XQM1aNopS6HKOgTmGziu2GYX8ZwgDPv64cRRt6XU4/exec?action=profile&lineUserId=" + lineUserId);
    const data = await res.json();
    
    // 記錄載入時間
    const loadTime = Date.now() - startTime;
    console.log(`載入時間: ${loadTime}ms`);
    
    // 更新快取（5 分鐘有效）
    setCache(cacheKey, data, 5 * 60 * 1000);
    
    // 渲染最新資料
    renderProfile(data, pictureUrl, displayName);
    
  } catch (error) {
    console.error('LIFF 初始化錯誤:', error);
    document.getElementById("profile").innerHTML = `
      <div class="error-card">
        <div class="error-icon">❌</div>
        <h3>載入失敗</h3>
        <p>請稍後再試或聯繫客服</p>
        <button class="btn btn-primary" onclick="initLiff()">重新載入</button>
      </div>
    `;
  }
}

// 渲染會員資料
function renderProfile(data, pictureUrl, displayName) {
  document.getElementById("profile").innerHTML = `
    <div class="profile-card">
      <div class="profile-header">
        <img src="${pictureUrl}" alt="頭像" class="profile-avatar">
        <div class="profile-header-center">
          <h2 style="text-align:left;margin:0;">${data.name || displayName || '會員'}</h2>
        </div>
        <div class="points-card">
          <div class="points-icon">❤️</div>
          <div class="points-info">
            <p class="points-label">公益點數</p>
            <p class="points-value" style="color: #FF6B9D;">${data.points || 0} <span>點</span></p>
          </div>
        </div>
      </div>
      
      <div class="profile-info">
        <div class="info-item">
          <span class="info-label">📱 電話</span>
          <span class="info-value">${data.phone || '未登錄'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">📧 Email</span>
          <span class="info-value">${data.email || '未登錄'}</span>
        </div>
      </div>
      
      <!-- 🎁 推薦好友區塊 -->
      <div class="referral-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; margin: 20px 0; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
          <span style="font-size: 28px;">🎁</span>
          <div>
            <h3 style="margin: 0; font-size: 18px; font-weight: bold;">邀請好友註冊</h3>
            <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">雙方各得 <strong>50 點</strong> 獎勵！</p>
          </div>
        </div>
        
        <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
          <p style="margin: 0 0 8px 0; font-size: 13px; opacity: 0.9;">您的推薦碼</p>
          <div style="display: flex; align-items: center; gap: 10px;">
            <input type="text" id="referralCodeDisplay" value="${data.referralCode || '載入中...'}" readonly 
                   style="flex: 1; background: rgba(255,255,255,0.9); border: none; border-radius: 6px; padding: 10px 12px; font-size: 18px; font-weight: bold; letter-spacing: 2px; text-align: center; color: #333;">
            <button onclick="copyReferralCode('${data.referralCode}')" 
                    style="background: rgba(255,255,255,0.25); border: 2px solid rgba(255,255,255,0.5); border-radius: 6px; padding: 10px 16px; color: white; font-weight: bold; cursor: pointer; transition: all 0.3s;">
              📋 複製
            </button>
          </div>
        </div>
        
        <div style="display: flex; gap: 8px;">
          <button onclick="shareReferralLink('${data.referralCode}')" class="btn" 
                  style="flex: 1; background: rgba(255,255,255,0.25); border: 2px solid rgba(255,255,255,0.5); color: white; font-weight: bold; padding: 12px;">
            <span style="font-size: 18px;">📤</span> 分享連結
          </button>
          <button onclick="viewReferralStats()" class="btn" 
                  style="flex: 1; background: rgba(255,255,255,0.25); border: 2px solid rgba(255,255,255,0.5); color: white; font-weight: bold; padding: 12px;">
            <span style="font-size: 18px;">📊</span> 推薦統計
          </button>
        </div>
        
        <p style="margin: 12px 0 0 0; font-size: 12px; opacity: 0.8; text-align: center;">
          已成功推薦 <strong style="font-size: 16px; color: #FFD700;">${data.referralCount || 0}</strong> 人
        </p>
      </div>
      
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="goTransfer()">
          <span class="btn-icon">❤️</span>
          分享公益點數
        </button>
        <button class="btn btn-secondary" onclick="goHistory()">
          <span class="btn-icon">📊</span>
          點數記錄
        </button>
        <button class="btn btn-outline" onclick="editProfile()">
          <span class="btn-icon">✏️</span>
          編輯資料
        </button>
      </div>
    </div>
  `;
}

// 簡單的本地快取
function setCache(key, data, ttl = 5 * 60 * 1000) {
  const item = {
    data: data,
    expiry: Date.now() + ttl
  };
  try {
    localStorage.setItem(key, JSON.stringify(item));
  } catch (e) {
    console.warn('快取儲存失敗:', e);
  }
}

function getCache(key) {
  try {
    const item = localStorage.getItem(key);
    if (!item) return null;
    
    const parsed = JSON.parse(item);
    if (Date.now() > parsed.expiry) {
      localStorage.removeItem(key);
      return null;
    }
    
    return parsed.data;
  } catch (e) {
    return null;
  }
}

function goTransfer() {
  window.location.href = "transfer.html";
}

function goHistory() {
  window.location.href = "history.html";
}

function editProfile() {
  window.location.href = "edit.html";
}

// 🎁 複製推薦碼
function copyReferralCode(code) {
  if (!code || code === '載入中...') {
    alert('推薦碼尚未載入，請稍後再試');
    return;
  }
  
  // 複製到剪貼簿
  if (navigator.clipboard) {
    navigator.clipboard.writeText(code).then(() => {
      alert('✅ 推薦碼已複製！\n\n' + code);
    }).catch(() => {
      // 降級方案
      fallbackCopyTextToClipboard(code);
    });
  } else {
    fallbackCopyTextToClipboard(code);
  }
}

// 降級複製方案
function fallbackCopyTextToClipboard(text) {
  const textArea = document.createElement("textarea");
  textArea.value = text;
  textArea.style.position = "fixed";
  textArea.style.top = "-999999px";
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  
  try {
    document.execCommand('copy');
    alert('✅ 推薦碼已複製！\n\n' + text);
  } catch (err) {
    alert('❌ 複製失敗，請手動複製：\n\n' + text);
  }
  
  document.body.removeChild(textArea);
}

// 📤 分享推薦連結
function shareReferralLink(code) {
  if (!code || code === '載入中...') {
    alert('推薦碼尚未載入，請稍後再試');
    return;
  }
  
  // 🔗 生成推薦連結（請替換為你的實際網址）
  const baseUrl = window.location.origin + window.location.pathname.replace('profile.html', '');
  const referralLink = `${baseUrl}register.html?ref=${code}`;
  
  // 分享訊息
  const shareMessage = `🎁 邀請你加入會員！\n\n` +
                      `註冊即送 100 點，使用我的推薦碼再送 50 點！\n\n` +
                      `👉 立即註冊：${referralLink}\n\n` +
                      `推薦碼：${code}`;
  
  // 如果在 LINE LIFF 環境中，使用 LINE 分享
  if (typeof liff !== 'undefined' && liff.isInClient()) {
    liff.shareTargetPicker([
      {
        type: 'text',
        text: shareMessage
      }
    ]).then(() => {
      console.log('分享成功');
    }).catch((err) => {
      console.error('分享失敗', err);
      // 降級使用複製連結
      fallbackShare(referralLink, shareMessage);
    });
  } else {
    // 使用 Web Share API 或降級方案
    if (navigator.share) {
      navigator.share({
        title: '邀請好友加入會員',
        text: shareMessage
      }).catch(() => {
        fallbackShare(referralLink, shareMessage);
      });
    } else {
      fallbackShare(referralLink, shareMessage);
    }
  }
}

// 降級分享方案
function fallbackShare(link, message) {
  if (confirm('📋 是否複製推薦連結到剪貼簿？\n\n你可以貼到任何地方分享給好友！')) {
    if (navigator.clipboard) {
      navigator.clipboard.writeText(link).then(() => {
        alert('✅ 推薦連結已複製！\n\n' + link + '\n\n快去分享給好友吧！');
      });
    } else {
      fallbackCopyTextToClipboard(link);
    }
  }
}

// 📊 查看推薦統計
function viewReferralStats() {
  alert('📊 推薦統計功能開發中...\n\n' +
        '即將顯示：\n' +
        '• 推薦人數\n' +
        '• 獲得獎勵\n' +
        '• 推薦明細');
}

initLiff();
</script>
</body>
</html>

