<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>上架商品</title>
<link rel="stylesheet" href="./assets/style.css">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="card-header">
      <h1>🏪 上架我的商品</h1>
      <p style="color: #667eea; font-weight: 600;">每位會員限上架 1 個商品</p>
    </div>
    
    <!-- 商品表單 -->
    <form id="productForm" style="display: none;">
      <div class="form-group">
        <label>📦 商品名稱 *</label>
        <input type="text" id="productName" class="form-control" 
               placeholder="例：iPhone 15 Pro Max" required maxlength="100">
      </div>
      
      <div class="form-group">
        <label>📝 商品描述 *</label>
        <textarea id="productDesc" class="form-control" rows="4" 
                  placeholder="請詳細描述您的商品（規格、狀況、購買時間等）" 
                  required maxlength="500"></textarea>
        <small style="color: #999;">最多 500 字</small>
      </div>
      
      <div class="form-group">
        <label>🖼️ 商品圖片網址 *</label>
        <input type="url" id="productImage" class="form-control" 
               placeholder="https://example.com/image.jpg" required>
        <small style="color: #999;">請使用 https:// 開頭的圖片網址</small>
      </div>
      
      <div class="form-group">
        <label>💰 售價（點數）*</label>
        <input type="number" id="productPoints" class="form-control" 
               placeholder="100" required min="1" max="100000">
        <small style="color: #999;">買家需支付的點數</small>
      </div>
      
      <div class="form-group">
        <label>💵 參考原價（元）</label>
        <input type="number" id="originalPrice" class="form-control" 
               placeholder="1000" min="0">
        <small style="color: #999;">選填，僅供參考</small>
      </div>
      
      <div class="form-group">
        <label>📂 商品分類 *</label>
        <select id="productCategory" class="form-control" required>
          <option value="">請選擇分類</option>
          <option value="physical">實體商品</option>
          <option value="virtual">虛擬商品</option>
          <option value="charity">公益捐贈</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>📦 庫存數量 *</label>
        <input type="number" id="productStock" class="form-control" 
               placeholder="1" required min="1" max="100" value="1">
        <small style="color: #999;">輸入 -1 表示不限量</small>
      </div>
      
      <div class="form-group">
        <label>🏷️ 商品標籤</label>
        <input type="text" id="productTags" class="form-control" 
               placeholder="例：全新、未拆封、保固中" maxlength="100">
        <small style="color: #999;">多個標籤用逗號分隔</small>
      </div>
      
      <!-- 重要提示 -->
      <div style="background: linear-gradient(135deg, #FFF3CD, #FFE69C); border: 2px solid #FFB800; border-radius: 12px; padding: 20px; margin: 20px 0;">
        <h3 style="margin: 0 0 10px 0; color: #856404;">📢 重要說明</h3>
        <ul style="margin: 0; padding-left: 20px; color: #856404;">
          <li>商品上架後會顯示您的姓名和電話</li>
          <li>買家購買時，點數會直接轉到您的帳戶</li>
          <li>請確保您能提供商品給買家</li>
          <li>每位會員限上架 1 個商品</li>
          <li>商品上架後需要管理員審核</li>
        </ul>
      </div>
      
      <button type="submit" class="btn btn-primary btn-large">
        <span class="btn-icon">✅</span>
        提交上架申請
      </button>
      
      <button type="button" class="btn btn-back" onclick="goBack()">
        ← 返回會員中心
      </button>
    </form>
    
    <!-- 已上架商品顯示 -->
    <div id="existingProduct" style="display: none;">
      <div style="background: linear-gradient(135deg, #E8EAF6, #C5CAE9); border: 2px solid #667eea; border-radius: 12px; padding: 20px; margin: 20px 0;">
        <h3 style="margin: 0 0 15px 0; color: #667eea;">📦 您的商品</h3>
        <div id="productInfo"></div>
      </div>
      
      <button class="btn btn-secondary" onclick="editProduct()">
        <span class="btn-icon">✏️</span>
        編輯商品
      </button>
      
      <button class="btn btn-back" onclick="goBack()">
        ← 返回會員中心
      </button>
    </div>
    
    <!-- 載入中 -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p style="margin-top: 15px; color: #666;">載入中...</p>
    </div>
    
    <div id="message" class="message" style="display:none;"></div>
  </div>
</div>

<style>
.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  font-size: 15px;
  font-weight: 600;
  color: #333;
  margin-bottom: 8px;
}

.form-control {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 15px;
  transition: all 0.3s ease;
  box-sizing: border-box;
}

.form-control:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

textarea.form-control {
  resize: vertical;
  font-family: inherit;
}

select.form-control {
  cursor: pointer;
}

small {
  display: block;
  margin-top: 5px;
  font-size: 13px;
}

.product-preview {
  background: white;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
}

.product-preview img {
  width: 100%;
  max-width: 300px;
  border-radius: 8px;
  margin: 10px 0;
}

.status-badge {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 16px;
  font-size: 13px;
  font-weight: 600;
  margin: 10px 0;
}

.status-badge.pending {
  background: #fff3cd;
  color: #856404;
}

.status-badge.active {
  background: #d1e7dd;
  color: #0f5132;
}

.status-badge.rejected {
  background: #f8d7da;
  color: #721c24;
}
</style>

<script src="./assets/auth.js"></script>
<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzMUwqroi_W_5m7rcjVs-U-o6tEo9W0327BeMmU38Rxinmycd5d1HyyF3BnugGvNF6r/exec';

let currentUserId = '';
let currentUser = null;
let existingProduct = null;

async function initLiff() {
  try {
    // 使用認證工具初始化
    const authResult = await AUTH.init();
    
    if (!authResult.success) {
      return;
    }
    
    currentUserId = authResult.user.userId;
    
    // 獲取會員資料
    const res = await fetch(`${API_URL}?action=profile&lineUserId=${currentUserId}`);
    const data = await res.json();
    
    // 🔧 檢查會員是否存在，不存在則跳轉到首頁註冊
    if (!data || !data.success || data.success === false) {
      console.log('❌ 會員不存在，跳轉到首頁註冊');
      alert('您還不是會員，請先註冊！\n\n將為您跳轉到註冊頁面...');
      window.location.href = 'index.html';
      return;
    }
    
    if (data.success) {
      currentUser = data;
      
      // 檢查是否已上架商品
      await checkExistingProduct();
    } else {
      showMessage('❌ 無法獲取會員資料', 'error');
    }
    
    document.getElementById('loading').style.display = 'none';
    
  } catch (error) {
    console.error('LIFF 初始化錯誤:', error);
    showMessage('❌ 載入失敗，請重新整理頁面', 'error');
    document.getElementById('loading').style.display = 'none';
  }
}

// 檢查是否已上架商品
async function checkExistingProduct() {
  try {
    const res = await fetch(`${API_URL}?action=my-product&lineUserId=${currentUserId}`);
    const data = await res.json();
    
    if (data.success && data.product) {
      // 已有商品
      existingProduct = data.product;
      displayExistingProduct(data.product);
    } else {
      // 尚未上架，顯示表單
      document.getElementById('productForm').style.display = 'block';
    }
  } catch (error) {
    console.error('檢查商品錯誤:', error);
    // 出錯時顯示表單
    document.getElementById('productForm').style.display = 'block';
  }
}

// 顯示已上架的商品
function displayExistingProduct(product) {
  const container = document.getElementById('productInfo');
  
  let statusBadge = '';
  let statusText = '';
  if (product.isActive) {
    statusBadge = '<span class="status-badge active">✅ 已上架</span>';
    statusText = '商品已在商城顯示';
  } else {
    statusBadge = '<span class="status-badge pending">⏳ 審核中</span>';
    statusText = '等待管理員審核';
  }
  
  container.innerHTML = `
    <div class="product-preview">
      <img src="${product.imageUrl}" alt="${product.productName}" onerror="this.src='https://via.placeholder.com/300x200?text=商品圖片'">
      
      <h3 style="margin: 10px 0;">${product.productName}</h3>
      <p style="color: #666; margin: 10px 0;">${product.description}</p>
      
      <div style="margin: 15px 0;">
        <div style="font-size: 24px; font-weight: 800; color: #FFB800;">
          ${product.points} <span style="font-size: 14px; color: #856404;">點</span>
        </div>
        ${product.originalPrice > 0 ? `<div style="font-size: 13px; color: #999; text-decoration: line-through;">原價 NT$ ${product.originalPrice}</div>` : ''}
      </div>
      
      <div style="margin: 10px 0;">
        <strong>分類：</strong>
        <span>${product.category === 'physical' ? '實體商品' : product.category === 'virtual' ? '虛擬商品' : '公益捐贈'}</span>
      </div>
      
      <div style="margin: 10px 0;">
        <strong>庫存：</strong>
        <span>${product.stock === -1 ? '不限量' : product.stock + ' 件'}</span>
      </div>
      
      ${product.tags ? `<div style="margin: 10px 0;"><strong>標籤：</strong> ${product.tags}</div>` : ''}
      
      <div style="margin: 15px 0;">
        ${statusBadge}
        <p style="color: #666; margin-top: 5px;">${statusText}</p>
      </div>
      
      <div style="margin: 15px 0; font-size: 13px; color: #999;">
        <div>已售：${product.soldCount || 0} 件</div>
        <div>上架時間：${new Date(product.createdAt).toLocaleString('zh-TW')}</div>
      </div>
    </div>
  `;
  
  document.getElementById('existingProduct').style.display = 'block';
}

// 編輯商品（重新填寫表單）
function editProduct() {
  if (!existingProduct) return;
  
  // 填入現有資料
  document.getElementById('productName').value = existingProduct.productName || '';
  document.getElementById('productDesc').value = existingProduct.description || '';
  document.getElementById('productImage').value = existingProduct.imageUrl || '';
  document.getElementById('productPoints').value = existingProduct.points || '';
  document.getElementById('originalPrice').value = existingProduct.originalPrice || '';
  document.getElementById('productCategory').value = existingProduct.category || '';
  document.getElementById('productStock').value = existingProduct.stock || 1;
  document.getElementById('productTags').value = existingProduct.tags || '';
  
  // 切換顯示
  document.getElementById('existingProduct').style.display = 'none';
  document.getElementById('productForm').style.display = 'block';
}

// 提交表單
document.getElementById('productForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  // 收集表單資料
  const productData = {
    productName: document.getElementById('productName').value.trim(),
    description: document.getElementById('productDesc').value.trim(),
    imageUrl: document.getElementById('productImage').value.trim(),
    points: parseInt(document.getElementById('productPoints').value),
    originalPrice: parseInt(document.getElementById('originalPrice').value) || 0,
    category: document.getElementById('productCategory').value,
    stock: parseInt(document.getElementById('productStock').value),
    tags: document.getElementById('productTags').value.trim()
  };
  
  // 驗證
  if (!productData.productName || productData.productName.length < 2) {
    showMessage('❌ 請輸入有效的商品名稱（至少 2 個字）', 'error');
    return;
  }
  
  if (!productData.description || productData.description.length < 10) {
    showMessage('❌ 商品描述太短，請詳細描述（至少 10 個字）', 'error');
    return;
  }
  
  if (!productData.imageUrl || !productData.imageUrl.startsWith('http')) {
    showMessage('❌ 請輸入有效的圖片網址', 'error');
    return;
  }
  
  if (productData.points < 1 || productData.points > 100000) {
    showMessage('❌ 售價必須在 1-100000 點之間', 'error');
    return;
  }
  
  if (!productData.category) {
    showMessage('❌ 請選擇商品分類', 'error');
    return;
  }
  
  if (productData.stock < -1 || productData.stock === 0) {
    showMessage('❌ 庫存數量無效（輸入 -1 表示不限量，或輸入正整數）', 'error');
    return;
  }
  
  // 確認提交
  const confirmMsg = existingProduct 
    ? '確認要更新商品資訊嗎？\n更新後需要重新審核。'
    : '確認要上架這個商品嗎？\n上架後需要管理員審核才會在商城顯示。';
  
  if (!confirm(confirmMsg)) {
    return;
  }
  
  // 提交
  try {
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="btn-icon">⏳</span> 提交中...';
    
    const params = new URLSearchParams({
      action: existingProduct ? 'update-product' : 'upload-product',
      lineUserId: currentUserId,
      ...productData
    });
    
    const res = await fetch(`${API_URL}?${params.toString()}`);
    const data = await res.json();
    
    if (data.success) {
      showMessage('🎉 ' + (existingProduct ? '商品更新成功！' : '商品上架成功！') + '\n等待管理員審核後即可在商城顯示', 'success');
      
      setTimeout(() => {
        location.reload();
      }, 2000);
    } else {
      showMessage('❌ ' + (data.message || '提交失敗'), 'error');
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span class="btn-icon">✅</span> ' + (existingProduct ? '更新商品' : '提交上架申請');
    }
  } catch (error) {
    console.error('提交錯誤:', error);
    showMessage('❌ 系統錯誤: ' + error.message, 'error');
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<span class="btn-icon">✅</span> ' + (existingProduct ? '更新商品' : '提交上架申請');
  }
});

function showMessage(msg, type) {
  const messageDiv = document.getElementById('message');
  messageDiv.textContent = msg;
  messageDiv.className = `message ${type}`;
  messageDiv.style.display = 'block';
  
  if (type === 'success') {
    setTimeout(() => {
      messageDiv.style.display = 'none';
    }, 5000);
  }
}

function goBack() {
  window.location.href = 'profile.html';
}

initLiff();
</script>
</body>
</html>

