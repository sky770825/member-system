<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç³»çµ±å¥åº·æª¢æŸ¥</title>
<link rel="stylesheet" href="./assets/style.css">
<style>
  .health-container {
    max-width: 900px;
    margin: 20px auto;
    padding: 20px;
  }
  
  .check-item {
    background: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
  }
  
  .check-icon {
    font-size: 32px;
    width: 40px;
    text-align: center;
  }
  
  .check-info {
    flex: 1;
  }
  
  .check-name {
    font-weight: bold;
    font-size: 16px;
    margin-bottom: 5px;
  }
  
  .check-status {
    font-size: 14px;
    color: #666;
  }
  
  .check-action {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: bold;
  }
  
  .status-checking { background: #FFF3CD; color: #856404; }
  .status-success { background: #D4EDDA; color: #155724; }
  .status-warning { background: #FFF3CD; color: #856404; }
  .status-error { background: #F8D7DA; color: #721C24; }
  
  .summary-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    text-align: center;
  }
  
  .summary-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-top: 20px;
  }
  
  .stat-item {
    text-align: center;
  }
  
  .stat-value {
    font-size: 32px;
    font-weight: bold;
    display: block;
  }
  
  .stat-label {
    font-size: 14px;
    opacity: 0.9;
  }
</style>
</head>
<body>
<div class="health-container">
  <div class="summary-card">
    <h1 style="margin: 0 0 10px 0;">ğŸ¥ ç³»çµ±å¥åº·æª¢æŸ¥</h1>
    <p style="margin: 0; opacity: 0.9;">æª¢æŸ¥ç³»çµ±å„é …åŠŸèƒ½æ˜¯å¦æ­£å¸¸é‹ä½œ</p>
    
    <div class="summary-stats">
      <div class="stat-item">
        <span class="stat-value" id="totalChecks">0</span>
        <span class="stat-label">ç¸½æª¢æŸ¥é …ç›®</span>
      </div>
      <div class="stat-item">
        <span class="stat-value" id="passedChecks" style="color: #4CAF50;">0</span>
        <span class="stat-label">é€šé</span>
      </div>
      <div class="stat-item">
        <span class="stat-value" id="warningChecks" style="color: #FFC107;">0</span>
        <span class="stat-label">è­¦å‘Š</span>
      </div>
      <div class="stat-item">
        <span class="stat-value" id="failedChecks" style="color: #dc3545;">0</span>
        <span class="stat-label">å¤±æ•—</span>
      </div>
    </div>
  </div>
  
  <div id="checkResults"></div>
  
  <div style="text-align: center; margin-top: 30px;">
    <button class="btn btn-primary btn-large" onclick="runHealthCheck()">
      <span class="btn-icon">ğŸ”„</span>
      é‡æ–°æª¢æŸ¥
    </button>
    <button class="btn btn-outline btn-large" onclick="window.location.href='index.html'">
      <span class="btn-icon">ğŸ </span>
      è¿”å›é¦–é 
    </button>
  </div>
</div>

<script src="./assets/utils.js"></script>
<script>
const checks = [
  {
    id: 'api-connection',
    name: 'API é€£ç·šæ¸¬è©¦',
    description: 'æª¢æŸ¥ Google Apps Script API æ˜¯å¦å¯é€£ç·š',
    test: async () => {
      try {
        const startTime = Date.now();
        const data = await apiCall('admin-stats', {}, { timeout: 10000, retryCount: 1 });
        const latency = Date.now() - startTime;
        
        if (data.success) {
          return { 
            status: latency < 2000 ? 'success' : 'warning',
            message: `API é€£ç·šæ­£å¸¸ (å»¶é²: ${latency}ms)`
          };
        } else {
          return { status: 'error', message: 'API å›æ‡‰ç•°å¸¸' };
        }
      } catch (error) {
        return { status: 'error', message: `API é€£ç·šå¤±æ•—: ${error.message}` };
      }
    }
  },
  {
    id: 'liff-sdk',
    name: 'LINE LIFF SDK',
    description: 'æª¢æŸ¥ LINE LIFF SDK æ˜¯å¦æ­£ç¢ºè¼‰å…¥',
    test: async () => {
      if (typeof liff !== 'undefined') {
        return { status: 'success', message: 'LIFF SDK å·²è¼‰å…¥' };
      } else {
        return { status: 'error', message: 'LIFF SDK æœªè¼‰å…¥' };
      }
    }
  },
  {
    id: 'utils-library',
    name: 'å·¥å…·å‡½æ•¸åº«',
    description: 'æª¢æŸ¥ utils.js æ˜¯å¦æ­£ç¢ºè¼‰å…¥',
    test: async () => {
      const requiredFunctions = [
        'apiCall', 'CacheManager', 'LiffHelper', 
        'UIHelper', 'Validator', 'Formatter', 
        'ReferralHelper', 'MemberLevelHelper'
      ];
      
      const missing = requiredFunctions.filter(fn => typeof window[fn] === 'undefined');
      
      if (missing.length === 0) {
        return { status: 'success', message: 'å·¥å…·å‡½æ•¸åº«å®Œæ•´' };
      } else {
        return { status: 'warning', message: `ç¼ºå°‘å‡½æ•¸: ${missing.join(', ')}` };
      }
    }
  },
  {
    id: 'cache-system',
    name: 'å¿«å–ç³»çµ±',
    description: 'æª¢æŸ¥ LocalStorage å¿«å–æ˜¯å¦å¯ç”¨',
    test: async () => {
      try {
        const testKey = 'health_check_test';
        const testData = { test: true, timestamp: Date.now() };
        
        CacheManager.set(testKey, testData, 1000);
        const retrieved = CacheManager.get(testKey);
        CacheManager.remove(testKey);
        
        if (retrieved && retrieved.test === true) {
          return { status: 'success', message: 'å¿«å–ç³»çµ±æ­£å¸¸' };
        } else {
          return { status: 'warning', message: 'å¿«å–è®€å¯«ç•°å¸¸' };
        }
      } catch (error) {
        return { status: 'error', message: `å¿«å–ç³»çµ±éŒ¯èª¤: ${error.message}` };
      }
    }
  },
  {
    id: 'validation',
    name: 'è³‡æ–™é©—è­‰',
    description: 'æª¢æŸ¥é©—è­‰å™¨æ˜¯å¦æ­£å¸¸é‹ä½œ',
    test: async () => {
      try {
        const tests = [
          { fn: () => Validator.phone('0912-345-678'), expected: true },
          { fn: () => Validator.phone('invalid'), expected: false },
          { fn: () => Validator.email('test@example.com'), expected: true },
          { fn: () => Validator.email('invalid'), expected: false },
          { fn: () => Validator.referralCode('A3K8M2'), expected: true },
          { fn: () => Validator.referralCode('invalid'), expected: false }
        ];
        
        const results = tests.map(t => t.fn() === t.expected);
        const passed = results.filter(r => r).length;
        
        if (passed === tests.length) {
          return { status: 'success', message: 'é©—è­‰å™¨é‹ä½œæ­£å¸¸' };
        } else {
          return { status: 'warning', message: `${passed}/${tests.length} å€‹æ¸¬è©¦é€šé` };
        }
      } catch (error) {
        return { status: 'error', message: `é©—è­‰å™¨éŒ¯èª¤: ${error.message}` };
      }
    }
  },
  {
    id: 'formatting',
    name: 'æ ¼å¼åŒ–åŠŸèƒ½',
    description: 'æª¢æŸ¥æ ¼å¼åŒ–å·¥å…·æ˜¯å¦æ­£å¸¸',
    test: async () => {
      try {
        const phoneTest = Formatter.phone('0912345678') === '0912-345-678';
        const pointsTest = Formatter.points(1000) === '1,000';
        const dateTest = Formatter.date('2025-01-01') !== '-';
        
        if (phoneTest && pointsTest && dateTest) {
          return { status: 'success', message: 'æ ¼å¼åŒ–å·¥å…·æ­£å¸¸' };
        } else {
          return { status: 'warning', message: 'éƒ¨åˆ†æ ¼å¼åŒ–åŠŸèƒ½ç•°å¸¸' };
        }
      } catch (error) {
        return { status: 'error', message: `æ ¼å¼åŒ–éŒ¯èª¤: ${error.message}` };
      }
    }
  },
  {
    id: 'member-level',
    name: 'æœƒå“¡ç­‰ç´šç³»çµ±',
    description: 'æª¢æŸ¥æœƒå“¡ç­‰ç´šè¨ˆç®—æ˜¯å¦æ­£å¸¸',
    test: async () => {
      try {
        const bronze = MemberLevelHelper.getLevel(100);
        const silver = MemberLevelHelper.getLevel(500);
        const gold = MemberLevelHelper.getLevel(1000);
        const platinum = MemberLevelHelper.getLevel(5000);
        
        if (bronze.name.includes('éŠ…') && silver.name.includes('éŠ€') &&
            gold.name.includes('é‡‘') && platinum.name.includes('ç™½é‡‘')) {
          return { status: 'success', message: 'æœƒå“¡ç­‰ç´šç³»çµ±æ­£å¸¸' };
        } else {
          return { status: 'warning', message: 'ç­‰ç´šè¨ˆç®—å¯èƒ½æœ‰èª¤' };
        }
      } catch (error) {
        return { status: 'error', message: `ç­‰ç´šç³»çµ±éŒ¯èª¤: ${error.message}` };
      }
    }
  },
  {
    id: 'referral-helper',
    name: 'æ¨è–¦ç³»çµ±',
    description: 'æª¢æŸ¥æ¨è–¦é€£çµç”Ÿæˆæ˜¯å¦æ­£å¸¸',
    test: async () => {
      try {
        const testCode = 'A3K8M2';
        const link = ReferralHelper.getLink(testCode);
        
        if (link && link.includes(testCode) && link.includes('register.html')) {
          return { status: 'success', message: 'æ¨è–¦ç³»çµ±æ­£å¸¸' };
        } else {
          return { status: 'warning', message: 'æ¨è–¦é€£çµæ ¼å¼ç•°å¸¸' };
        }
      } catch (error) {
        return { status: 'error', message: `æ¨è–¦ç³»çµ±éŒ¯èª¤: ${error.message}` };
      }
    }
  },
  {
    id: 'system-pages',
    name: 'ç³»çµ±é é¢',
    description: 'æª¢æŸ¥æ ¸å¿ƒé é¢æª”æ¡ˆæ˜¯å¦å­˜åœ¨',
    test: async () => {
      const pages = [
        'index.html', 'register.html', 'profile.html', 
        'transfer.html', 'admin.html'
      ];
      
      // é€™å€‹æ¸¬è©¦åœ¨å‰ç«¯ç„¡æ³•å®Œå…¨åŸ·è¡Œï¼Œåªèƒ½ç¢ºèªç•¶å‰é é¢å­˜åœ¨
      return { 
        status: 'success', 
        message: `æ ¸å¿ƒé é¢ï¼š${pages.join(', ')}` 
      };
    }
  },
  {
    id: 'response-time',
    name: 'API éŸ¿æ‡‰æ™‚é–“',
    description: 'æ¸¬è©¦ API éŸ¿æ‡‰é€Ÿåº¦',
    test: async () => {
      try {
        const startTime = Date.now();
        await apiCall('admin-stats', {}, { timeout: 5000, retryCount: 0 });
        const responseTime = Date.now() - startTime;
        
        let status = 'success';
        let message = `éŸ¿æ‡‰æ™‚é–“: ${responseTime}ms (å„ªç§€)`;
        
        if (responseTime > 2000) {
          status = 'warning';
          message = `éŸ¿æ‡‰æ™‚é–“: ${responseTime}ms (è¼ƒæ…¢)`;
        }
        
        if (responseTime > 5000) {
          status = 'error';
          message = `éŸ¿æ‡‰æ™‚é–“: ${responseTime}ms (è¶…æ™‚)`;
        }
        
        return { status, message };
      } catch (error) {
        return { status: 'error', message: `éŸ¿æ‡‰æ¸¬è©¦å¤±æ•—: ${error.message}` };
      }
    }
  }
];

async function runHealthCheck() {
  const resultsDiv = document.getElementById('checkResults');
  resultsDiv.innerHTML = '';
  
  let passed = 0;
  let warnings = 0;
  let failed = 0;
  
  // æ›´æ–°ç¸½æ•¸
  document.getElementById('totalChecks').textContent = checks.length;
  document.getElementById('passedChecks').textContent = '...';
  document.getElementById('warningChecks').textContent = '...';
  document.getElementById('failedChecks').textContent = '...';
  
  for (const check of checks) {
    // å»ºç«‹æª¢æŸ¥é …ç›® UI
    const checkDiv = document.createElement('div');
    checkDiv.className = 'check-item';
    checkDiv.innerHTML = `
      <div class="check-icon">â³</div>
      <div class="check-info">
        <div class="check-name">${check.name}</div>
        <div class="check-status">æª¢æŸ¥ä¸­...</div>
      </div>
      <div class="check-action status-checking">æª¢æŸ¥ä¸­</div>
    `;
    resultsDiv.appendChild(checkDiv);
    
    // åŸ·è¡Œæ¸¬è©¦
    try {
      const result = await check.test();
      
      // æ›´æ–° UI
      const icon = checkDiv.querySelector('.check-icon');
      const status = checkDiv.querySelector('.check-status');
      const action = checkDiv.querySelector('.check-action');
      
      if (result.status === 'success') {
        icon.textContent = 'âœ…';
        action.textContent = 'æ­£å¸¸';
        action.className = 'check-action status-success';
        passed++;
      } else if (result.status === 'warning') {
        icon.textContent = 'âš ï¸';
        action.textContent = 'è­¦å‘Š';
        action.className = 'check-action status-warning';
        warnings++;
      } else {
        icon.textContent = 'âŒ';
        action.textContent = 'å¤±æ•—';
        action.className = 'check-action status-error';
        failed++;
      }
      
      status.textContent = result.message;
      
    } catch (error) {
      console.error(`æª¢æŸ¥å¤±æ•— [${check.id}]:`, error);
      
      const icon = checkDiv.querySelector('.check-icon');
      const status = checkDiv.querySelector('.check-status');
      const action = checkDiv.querySelector('.check-action');
      
      icon.textContent = 'âŒ';
      status.textContent = `æª¢æŸ¥å¤±æ•—: ${error.message}`;
      action.textContent = 'å¤±æ•—';
      action.className = 'check-action status-error';
      failed++;
    }
    
    // æ›´æ–°çµ±è¨ˆ
    document.getElementById('passedChecks').textContent = passed;
    document.getElementById('warningChecks').textContent = warnings;
    document.getElementById('failedChecks').textContent = failed;
  }
  
  // é¡¯ç¤ºç¸½çµ
  console.log(`âœ… å¥åº·æª¢æŸ¥å®Œæˆ: ${passed} é€šé, ${warnings} è­¦å‘Š, ${failed} å¤±æ•—`);
  
  if (failed === 0 && warnings === 0) {
    UIHelper.showMessage('ğŸ‰ æ‰€æœ‰æª¢æŸ¥é …ç›®é€šéï¼ç³»çµ±é‹ä½œæ­£å¸¸', 'success', 5000);
  } else if (failed === 0) {
    UIHelper.showMessage(`âš ï¸ æœ‰ ${warnings} å€‹è­¦å‘Šé …ç›®ï¼Œè«‹æ³¨æ„`, 'warning', 5000);
  } else {
    UIHelper.showMessage(`âŒ æœ‰ ${failed} å€‹é …ç›®å¤±æ•—ï¼Œè«‹ä¿®å¾©`, 'error', 5000);
  }
}

// é é¢è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•åŸ·è¡Œ
document.addEventListener('DOMContentLoaded', () => {
  console.log('ğŸ¥ ç³»çµ±å¥åº·æª¢æŸ¥é é¢è¼‰å…¥å®Œæˆ');
  runHealthCheck();
});
</script>
</body>
</html>


