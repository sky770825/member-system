<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>測試 Google Sheets 連接</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 800px;
    margin: 50px auto;
    padding: 20px;
    background: #f5f5f5;
  }
  
  .test-card {
    background: white;
    border-radius: 10px;
    padding: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  h1 {
    color: #333;
    margin-bottom: 30px;
  }
  
  .test-item {
    margin: 20px 0;
    padding: 15px;
    border-left: 4px solid #667eea;
    background: #f8f9fa;
    border-radius: 5px;
  }
  
  .test-name {
    font-weight: bold;
    color: #667eea;
    margin-bottom: 10px;
  }
  
  .test-result {
    font-family: monospace;
    background: #fff;
    padding: 10px;
    border-radius: 5px;
    margin-top: 10px;
    white-space: pre-wrap;
    word-break: break-all;
  }
  
  .success {
    color: #28a745;
    border-left-color: #28a745;
  }
  
  .error {
    color: #dc3545;
    border-left-color: #dc3545;
  }
  
  .info {
    color: #17a2b8;
    border-left-color: #17a2b8;
  }
  
  button {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    margin: 10px 5px;
  }
  
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }
  
  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
</head>
<body>
<div class="test-card">
  <h1>🔍 Google Sheets 連接測試</h1>
  
  <div style="margin-bottom: 30px;">
    <button onclick="testAllConnections()">🚀 開始完整測試</button>
    <button onclick="testSheetAccess()">📋 測試工作表訪問</button>
    <button onclick="testRegisterAPI()">✍️ 測試註冊 API</button>
    <button onclick="clearResults()">🗑️ 清除結果</button>
  </div>
  
  <div id="results"></div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxh10yJHbTDcwBDTX_V30jRR4CqshDc3pePR0t_rPqCxZg40h636WKIo3-Y--L0cDnP/exec';

function addResult(name, result, type = 'info') {
  const resultsDiv = document.getElementById('results');
  const testItem = document.createElement('div');
  testItem.className = `test-item ${type}`;
  testItem.innerHTML = `
    <div class="test-name">${name}</div>
    <div class="test-result">${result}</div>
  `;
  resultsDiv.appendChild(testItem);
}

function clearResults() {
  document.getElementById('results').innerHTML = '';
}

async function testAllConnections() {
  clearResults();
  addResult('🚀 開始測試', '正在進行完整連接測試...', 'info');
  
  await testSheetAccess();
  await new Promise(resolve => setTimeout(resolve, 1000));
  await testRegisterAPI();
  
  addResult('✅ 測試完成', '所有測試已完成，請查看上方結果', 'success');
}

async function testSheetAccess() {
  addResult('📋 測試工作表訪問', '正在測試...', 'info');
  
  try {
    // 使用簡單的測試：直接訪問 API（不帶參數會返回"未知的操作"，但表示連接正常）
    const response = await fetch(`${API_URL}`);
    const data = await response.json();
    
    if (data.success) {
      addResult(
        '✅ 工作表連接成功',
        `Sheet ID: ${data.sheetId || '未返回'}\n` +
        `API 版本: ${data.version || '未知'}\n` +
        `函數檢查: ${JSON.stringify(data.functions, null, 2)}`,
        'success'
      );
    } else {
      addResult(
        '⚠️ 工作表連接異常',
        `錯誤訊息: ${data.message}\n` +
        `完整回應: ${JSON.stringify(data, null, 2)}`,
        'error'
      );
    }
  } catch (error) {
    addResult(
      '❌ 工作表連接失敗',
      `錯誤: ${error.message}\n` +
      `這可能表示:\n` +
      `1. API 部署有問題\n` +
      `2. Google Sheets 權限不足\n` +
      `3. SHEET_ID 設定錯誤`,
      'error'
    );
  }
}

async function testRegisterAPI() {
  addResult('✍️ 測試註冊 API', '正在測試註冊功能...', 'info');
  
  const testData = {
    name: '測試用戶' + Math.floor(Math.random() * 10000),
    phone: '0912-' + Math.floor(Math.random() * 1000).toString().padStart(3, '0') + '-' + Math.floor(Math.random() * 1000).toString().padStart(3, '0'),
    email: 'test' + Date.now() + '@example.com',
    username: 'test' + Date.now(),
    password: 'Test1234',
    referralCode: ''
  };
  
  addResult(
    'ℹ️ 測試資料',
    `姓名: ${testData.name}\n` +
    `手機: ${testData.phone}\n` +
    `Email: ${testData.email}\n` +
    `帳號: ${testData.username}`,
    'info'
  );
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        action: 'register-password',
        ...testData
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      addResult(
        '✅ 註冊 API 正常',
        `註冊成功！\n` +
        `點數: ${data.points}\n` +
        `會員等級: ${data.memberLevel}\n` +
        `推薦碼: ${data.referralCode}\n` +
        `完整回應: ${JSON.stringify(data, null, 2)}`,
        'success'
      );
      
      // 測試是否真的寫入 Sheets
      addResult(
        '🔍 驗證寫入',
        '請前往 Google Sheets 確認是否有新的會員記錄：\n' +
        `LINE用戶ID: WEB-${testData.phone}\n` +
        `姓名: ${testData.name}\n` +
        `手機: ${testData.phone}`,
        'info'
      );
    } else {
      addResult(
        '⚠️ 註冊 API 返回錯誤',
        `錯誤訊息: ${data.message}\n` +
        `完整回應: ${JSON.stringify(data, null, 2)}`,
        'error'
      );
    }
  } catch (error) {
    addResult(
      '❌ 註冊 API 請求失敗',
      `錯誤: ${error.message}\n` +
      `這可能表示:\n` +
      `1. CORS 問題（檢查 API 部署設定）\n` +
      `2. API URL 不正確\n` +
      `3. 網路連接問題`,
      'error'
    );
  }
}

// 自動顯示當前 API URL
window.onload = function() {
  addResult(
    'ℹ️ 當前配置',
    `API URL: ${API_URL}\n` +
    `Sheet ID: 1EdLfJQzYroQ9WMqVEqcDuMpGwiTPj8gxLaMnGp3umDw\n` +
    `工作表名稱: 會員資料, 交易記錄, 推薦關係...`,
    'info'
  );
};
</script>
</body>
</html>

