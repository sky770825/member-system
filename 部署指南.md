# 會員註冊系統 - 完整部署指南

## 📋 目錄
1. [系統架構](#系統架構)
2. [Google Sheets 設定](#google-sheets-設定)
3. [LINE LIFF 設定](#line-liff-設定)
4. [N8N 設定（選擇性）](#n8n-設定)
5. [前端部署](#前端部署)
6. [測試與驗證](#測試與驗證)

---

## 🏗️ 系統架構

```
┌─────────────┐
│   LINE App  │
│   (LIFF)    │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────┐
│     前端靜態頁面 (GitHub Pages)       │
│  - index.html                        │
│  - register.html                     │
│  - profile.html                      │
│  - transfer.html                     │
└──────┬──────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│   Google Apps Script (Web App)      │
│   - API 端點處理                     │
│   - 商業邏輯                         │
└──────┬──────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│      Google Sheets (資料庫)          │
│   - Members 工作表                   │
│   - Transactions 工作表              │
└─────────────────────────────────────┘
```

---

## 📊 Google Sheets 設定

### 步驟 1: 建立 Google Sheets

1. 前往 [Google Sheets](https://sheets.google.com/)
2. 建立一個新的試算表，命名為「會員系統點數移轉」
3. 記下您的 **Sheet ID**（在 URL 中）：
   ```
   https://docs.google.com/spreadsheets/d/[SHEET_ID]/edit
   ```

### 步驟 2: 設定工作表

系統會自動建立以下工作表，但您也可以手動建立：

#### Members 工作表
| A | B | C | D | E | F | G | H | I | J |
|---|---|---|---|---|---|---|---|---|---|
| lineUserId | name | phone | email | birthday | lineName | linePicture | points | createdAt | updatedAt |

#### Transactions 工作表
| A | B | C | D | E | F | G | H | I |
|---|---|---|---|---|---|---|---|---|
| id | type | senderUserId | receiverUserId | senderName | receiverName | points | message | createdAt |

### 步驟 3: 安裝 Apps Script

1. 在 Google Sheets 中，點選 **擴充功能** → **Apps Script**
2. 刪除預設的 `function myFunction() {}`
3. 將 `google-apps-script.js` 的所有內容複製貼上
4. 修改第一行的設定：
   ```javascript
   const SHEET_ID = 'YOUR_GOOGLE_SHEET_ID'; // 替換為您的 Sheet ID
   ```

### 步驟 4: 部署為 Web App

1. 點選 Apps Script 編輯器上方的 **部署** → **新增部署作業**
2. 選擇類型：**網頁應用程式**
3. 設定：
   - **說明**：會員系統 API v1
   - **執行身分**：我
   - **具有應用程式存取權的使用者**：所有人（重要！必須選擇此項）
4. 點選 **部署**
5. **授權應用程式**（第一次部署需要）
6. 複製 **網頁應用程式 URL**，格式如下：
   ```
   https://script.google.com/macros/s/[DEPLOYMENT_ID]/exec
   ```

**⚠️ 重要：CORS 設定**
- 每次修改程式碼後，必須點選「部署」→「管理部署作業」→「編輯」→ 更新「版本」為「新版本」
- 確保「具有應用程式存取權的使用者」設為「所有人」
- Google Apps Script 會自動處理 CORS 標頭，但只有在正確部署後才會生效

### 步驟 5: 測試 Apps Script

在 Apps Script 編輯器中執行以下測試函數：

```javascript
// 測試：建立範例資料
createSampleData();

// 測試：取得統計資料
Logger.log(getStatistics());

// 清除所有資料（小心使用）
// clearAllData();
```

---

## 📱 LINE LIFF 設定

### 步驟 1: 建立 LINE Messaging API Channel

1. 前往 [LINE Developers Console](https://developers.line.biz/console/)
2. 建立 **Provider**（如果還沒有的話）
3. 建立 **Messaging API Channel**
4. 記下：
   - **Channel ID**
   - **Channel Secret**

### 步驟 2: 建立 LIFF App

1. 在 Channel 設定中，找到 **LIFF** 頁籤
2. 點選 **Add**（新增 LIFF）
3. 建立 3 個 LIFF 應用：

#### LIFF 1: 註冊頁面
- **LIFF app name**: 會員註冊
- **Size**: Full
- **Endpoint URL**: `https://YOUR_DOMAIN/register.html`
- **Scope**: `profile`, `openid`
- **Bot link feature**: On (Aggressive)

#### LIFF 2: 會員中心
- **LIFF app name**: 會員中心
- **Size**: Tall
- **Endpoint URL**: `https://YOUR_DOMAIN/profile.html`
- **Scope**: `profile`, `openid`
- **Bot link feature**: On (Aggressive)

#### LIFF 3: 轉點頁面
- **LIFF app name**: 點數轉移
- **Size**: Tall
- **Endpoint URL**: `https://YOUR_DOMAIN/transfer.html`
- **Scope**: `profile`, `openid`
- **Bot link feature**: On (Aggressive)

4. 記下每個 LIFF 的 **LIFF ID**

---

## 🚀 前端部署

### 方案 1: GitHub Pages（推薦，免費）

#### 步驟 1: 準備程式碼

1. 建立 GitHub Repository
2. 上傳所有檔案：
   ```
   ├── index.html
   ├── register.html
   ├── profile.html
   ├── transfer.html
   └── assets/
       └── style.css
   ```

#### 步驟 2: 更新設定

在所有 HTML 檔案中，更新以下設定：

**register.html:**
```javascript
// 第 63 行
await liff.init({ liffId: "YOUR_LIFF_ID_1" }); // 替換為註冊頁面的 LIFF ID

// 第 77, 113 行
const res = await fetch('https://script.google.com/macros/s/[YOUR_DEPLOYMENT_ID]/exec?action=check&lineUserId=' + lineUserId);

// 第 83-86 行
liff.openWindow({ 
  url: "https://YOUR_USERNAME.github.io/YOUR_REPO/profile.html", 
  external: false 
});
```

**profile.html:**
```javascript
// 第 21 行
await liff.init({ liffId: "YOUR_LIFF_ID_2" }); // 替換為會員中心的 LIFF ID

// 第 33 行
const res = await fetch("https://script.google.com/macros/s/[YOUR_DEPLOYMENT_ID]/exec?action=profile&lineUserId=" + lineUserId);

// 第 93, 100, 107 行
url: "https://YOUR_USERNAME.github.io/YOUR_REPO/..."
```

**transfer.html:**
```javascript
// 第 85 行
await liff.init({ liffId: "YOUR_LIFF_ID_3" }); // 替換為轉點頁面的 LIFF ID

// 第 96, 120, 213 行
const res = await fetch('https://script.google.com/macros/s/[YOUR_DEPLOYMENT_ID]/exec?action=...');
```

#### 步驟 3: 啟用 GitHub Pages

1. 前往 Repository → **Settings** → **Pages**
2. **Source**: 選擇 `main` branch
3. **Folder**: `/` (root)
4. 點選 **Save**
5. 等待部署完成（約 1-2 分鐘）
6. 您的網站會部署在：`https://YOUR_USERNAME.github.io/YOUR_REPO/`

#### 步驟 4: 更新 LIFF Endpoint URL

回到 LINE Developers Console，更新每個 LIFF 的 Endpoint URL：
- `https://YOUR_USERNAME.github.io/YOUR_REPO/register.html`
- `https://YOUR_USERNAME.github.io/YOUR_REPO/profile.html`
- `https://YOUR_USERNAME.github.io/YOUR_REPO/transfer.html`

### 方案 2: Vercel（推薦，免費）

1. 前往 [Vercel](https://vercel.com/)
2. 匯入 GitHub Repository
3. 部署完成後會得到網址：`https://YOUR_PROJECT.vercel.app/`
4. 更新 LIFF Endpoint URL

### 方案 3: Zeabur（推薦，付費）

1. 前往 [Zeabur](https://zeabur.com/)
2. 建立新專案
3. 從 GitHub 匯入
4. 自動部署
5. 可以綁定自訂網域

---

## 🔧 N8N 設定（選擇性）

如果您想使用 N8N 作為中間層（進階用法）：

### 步驟 1: 部署 N8N

可以使用以下平台：
- **Zeabur** - 簡單易用
- **Railway** - 簡單部署
- **自架伺服器** - 完全控制

### 步驟 2: 建立 Webhook 流程

建立以下 Workflow：

1. **Webhook Node** → 接收請求
2. **Function Node** → 處理商業邏輯
3. **HTTP Request Node** → 呼叫 Google Apps Script
4. **Respond to Webhook Node** → 回傳結果

### API 端點

- `GET /webhook/profile?lineUserId=xxx`
- `GET /webhook/check?lineUserId=xxx`
- `GET /webhook/check-user?phone=xxx`
- `POST /webhook/register`
- `POST /webhook/transfer`

---

## ✅ 測試與驗證

### 1. 測試 Google Apps Script

```bash
# 使用 curl 測試
curl "https://script.google.com/macros/s/[YOUR_ID]/exec?action=check&lineUserId=TEST001"
```

### 2. 測試 LIFF 頁面

1. 開啟 LINE App
2. 在聊天室中傳送 LIFF URL：
   ```
   https://liff.line.me/[LIFF_ID]
   ```
3. 檢查是否正確開啟

### 3. 完整流程測試

1. **註冊流程**
   - 開啟註冊頁面
   - 填寫資料並提交
   - 檢查 Google Sheets 是否新增資料
   - 確認贈送 100 點

2. **會員中心**
   - 開啟會員中心
   - 確認顯示正確的會員資料和點數

3. **轉點流程**
   - 開啟轉點頁面
   - 輸入收款人手機號碼
   - 選擇轉點數量
   - 確認轉點
   - 檢查雙方點數是否正確更新

---

## 🔐 安全性建議

### 1. Google Apps Script

- 不要在程式碼中暴露敏感資訊
- 使用 Properties Service 儲存設定
- 定期檢查部署版本

### 2. LINE LIFF

- 確保 LIFF URL 使用 HTTPS
- 驗證 LINE User ID 的真實性
- 實作 Rate Limiting

### 3. 資料保護

- 定期備份 Google Sheets
- 設定適當的存取權限
- 記錄重要操作

---

## 📊 監控與維護

### 1. Google Apps Script 日誌

在 Apps Script 編輯器中：
- **執行** → **執行紀錄** 查看所有請求

### 2. Google Sheets 監控

- 定期檢查資料完整性
- 監控異常交易
- 統計分析

### 3. LINE Bot 通知（進階）

可以設定自動通知：
- 新會員註冊
- 大額轉點
- 系統錯誤

---

## 🆘 常見問題

### Q1: CORS 錯誤 - "Access-Control-Allow-Origin" 標頭缺失

**錯誤訊息：**
```
Access to fetch at 'https://script.google.com/...' has been blocked by CORS policy: 
No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

**解決方案：**

1. **確保正確部署** ✅ 最重要！
   - 前往 Apps Script 編輯器
   - 點選「部署」→「管理部署作業」
   - 點選部署項目旁的「編輯」（鉛筆圖示）
   - 在「版本」下拉選單中選擇「新版本」
   - **確保「具有應用程式存取權的使用者」設為「所有人」**
   - 點選「部署」

2. **清除瀏覽器快取**
   - 清除快取和 Cookie
   - 或使用無痕模式測試

3. **等待幾分鐘**
   - Google Apps Script 部署可能需要 1-5 分鐘生效

4. **檢查 URL**
   - 確保使用的是最新的部署 URL
   - URL 格式：`https://script.google.com/macros/s/[DEPLOYMENT_ID]/exec`

5. **驗證代碼已更新**
   - 確保已將最新版本的 `google-apps-script.js` 貼到 Apps Script 編輯器
   - 檢查是否有 `doOptions` 和 `createCorsResponse` 函數

### Q2: Apps Script 回應 403 錯誤
**A:** 重新部署 Web App，確保「具有應用程式存取權的使用者」設為「所有人」

### Q3: LIFF 無法開啟
**A:** 檢查 Endpoint URL 是否正確，確保使用 HTTPS

### Q4: 點數沒有更新
**A:** 檢查 Google Apps Script 的執行紀錄，查看錯誤訊息

### Q5: 手機號碼驗證失敗
**A:** 確保格式為 `0912-345-678`（自動格式化）

### Q6: 轉點失敗
**A:** 檢查：
- 點數是否足夠
- 收款人是否存在
- 是否轉點給自己

---

## 📞 技術支援

如需協助，請提供以下資訊：
1. 錯誤訊息截圖
2. Google Apps Script 執行紀錄
3. 操作步驟說明

---

## 🎯 下一步

完成部署後，您可以：

1. **新增功能**
   - 點數記錄查詢頁面
   - 會員資料編輯功能
   - 點數排行榜
   - 統計報表

2. **整合其他服務**
   - LINE Messaging API（推播通知）
   - 金流串接（購買點數）
   - CRM 系統整合

3. **優化效能**
   - 快取機制
   - 資料分頁
   - 圖片 CDN

---

**祝您部署順利！** 🎉

