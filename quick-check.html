<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¿«é€Ÿæª¢æŸ¥å·¥å…·</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 20px auto;
    padding: 20px;
    background: #f5f5f5;
  }
  
  .card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin: 10px 0;
  }
  
  .status {
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
    font-family: monospace;
    white-space: pre-wrap;
  }
  
  .success { background: #d4edda; border-left: 4px solid #28a745; }
  .error { background: #f8d7da; border-left: 4px solid #dc3545; }
  .info { background: #d1ecf1; border-left: 4px solid #0c5460; }
  
  button {
    background: #667eea;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    margin: 5px;
    font-size: 14px;
  }
  
  button:hover {
    background: #5568d3;
  }
  
  button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
</style>
</head>
<body>

<div class="card">
  <h2 style="color: #667eea; margin-top: 0;">ğŸ” LINE ç™»å…¥è¨ºæ–·å·¥å…·</h2>
  <div id="result"></div>
  
  <div style="margin-top: 20px;">
    <button onclick="checkAgain()" id="checkBtn">ğŸ”„ é‡æ–°æª¢æŸ¥</button>
    <button onclick="forceRegister()" id="regBtn" style="display: none; background: #28a745;">ğŸ“ å¼·åˆ¶è¨»å†Š</button>
    <button onclick="goProfile()" id="profileBtn" style="display: none; background: #17a2b8;">ğŸ‘¤ é€²å…¥æœƒå“¡ä¸­å¿ƒ</button>
  </div>
</div>

<div class="card" style="background: #fff3cd; border-left: 4px solid #ffc107;">
  <h3 style="margin-top: 0;">ğŸ’¡ ä½¿ç”¨èªªæ˜</h3>
  <p style="margin: 5px 0;">é€™å€‹å·¥å…·æœƒå¹«æ‚¨æª¢æŸ¥ï¼š</p>
  <ul style="margin: 10px 0;">
    <li>LINE æ˜¯å¦å·²ç™»å…¥</li>
    <li>æœƒå“¡æ˜¯å¦å·²è¨»å†Š</li>
    <li>API é€£æ¥æ˜¯å¦æ­£å¸¸</li>
  </ul>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxh10yJHbTDcwBDTX_V30jRR4CqshDc3pePR0t_rPqCxZg40h636WKIo3-Y--L0cDnP/exec';
let userId = '';
let userName = '';

async function init() {
  const resultDiv = document.getElementById('result');
  resultDiv.innerHTML = '<div class="status info">â³ æ­£åœ¨åˆå§‹åŒ– LIFF...</div>';
  
  try {
    await liff.init({ liffId: '2008231108-2PDbO5qk' });
    
    if (!liff.isLoggedIn()) {
      resultDiv.innerHTML = `
        <div class="status error">
          âŒ å°šæœªç™»å…¥ LINE
          
          è«‹ç¨å€™ï¼Œæ­£åœ¨è·³è½‰åˆ°ç™»å…¥é é¢...
        </div>
      `;
      setTimeout(() => {
        liff.login();
      }, 2000);
      return;
    }
    
    const profile = await liff.getProfile();
    userId = profile.userId;
    userName = profile.displayName;
    
    resultDiv.innerHTML = `
      <div class="status success">
        âœ… LINE ç™»å…¥æˆåŠŸ
        
        User ID: ${userId}
        é¡¯ç¤ºåç¨±: ${userName}
      </div>
    `;
    
    // è‡ªå‹•æª¢æŸ¥è¨»å†Šç‹€æ…‹
    await checkRegistration();
    
  } catch (error) {
    resultDiv.innerHTML = `
      <div class="status error">
        âŒ LIFF åˆå§‹åŒ–å¤±æ•—
        
        éŒ¯èª¤: ${error.message}
        
        å¯èƒ½åŸå› ï¼š
        1. LIFF ID è¨­å®šéŒ¯èª¤
        2. ç¶²è·¯é€£æ¥å•é¡Œ
        3. LINE ç‰ˆæœ¬éèˆŠ
      </div>
    `;
  }
}

async function checkRegistration() {
  const resultDiv = document.getElementById('result');
  
  resultDiv.innerHTML += '<div class="status info">â³ æª¢æŸ¥è¨»å†Šç‹€æ…‹ä¸­...</div>';
  
  try {
    console.log('æª¢æŸ¥ User ID:', userId);
    
    const response = await fetch(`${API_URL}?action=profile&lineUserId=${userId}`);
    const data = await response.json();
    
    console.log('API å›æ‡‰:', data);
    
    if (data.success && data.name) {
      // å·²è¨»å†Š
      resultDiv.innerHTML = `
        <div class="status success">
          âœ… LINE ç™»å…¥æˆåŠŸ
          User ID: ${userId}
          é¡¯ç¤ºåç¨±: ${userName}
        </div>
        <div class="status success">
          âœ… æ‚¨å·²ç¶“æ˜¯æœƒå“¡äº†ï¼
          
          æœƒå“¡è³‡æ–™ï¼š
          â”œâ”€ å§“åï¼š${data.name}
          â”œâ”€ æ‰‹æ©Ÿï¼š${data.phone}
          â”œâ”€ Emailï¼š${data.email || 'æœªè¨­å®š'}
          â”œâ”€ é»æ•¸ï¼š${data.points} é»
          â”œâ”€ ç­‰ç´šï¼š${data.memberLevel}
          â”œâ”€ æ¨è–¦ç¢¼ï¼š${data.referralCode}
          â””â”€ è¨»å†Šæ™‚é–“ï¼š${data.createdAt}
          
          ğŸ‰ å¯ä»¥ç›´æ¥é€²å…¥æœƒå“¡ä¸­å¿ƒï¼
        </div>
      `;
      
      document.getElementById('profileBtn').style.display = 'inline-block';
      
    } else {
      // æœªè¨»å†Š
      resultDiv.innerHTML = `
        <div class="status success">
          âœ… LINE ç™»å…¥æˆåŠŸ
          User ID: ${userId}
          é¡¯ç¤ºåç¨±: ${userName}
        </div>
        <div class="status error">
          âŒ æ‚¨é‚„ä¸æ˜¯æœƒå“¡
          
          API å›æ‡‰ï¼š
          ${JSON.stringify(data, null, 2)}
          
          ğŸ“ è«‹é»æ“Šä¸‹æ–¹ã€Œå¼·åˆ¶è¨»å†Šã€æŒ‰éˆ•å®Œæˆè¨»å†Š
        </div>
      `;
      
      document.getElementById('regBtn').style.display = 'inline-block';
    }
    
  } catch (error) {
    resultDiv.innerHTML += `
      <div class="status error">
        âŒ API æª¢æŸ¥å¤±æ•—
        
        éŒ¯èª¤: ${error.message}
        
        å¯èƒ½åŸå› ï¼š
        1. API URL ä¸æ­£ç¢º
        2. ç¶²è·¯é€£æ¥å•é¡Œ
        3. CORS å•é¡Œ
        4. API ä¼ºæœå™¨éŒ¯èª¤
        
        å»ºè­°ï¼š
        - æª¢æŸ¥ç¶²è·¯é€£æ¥
        - ç¨å¾Œå†è©¦
        - è¯ç¹«ç®¡ç†å“¡
      </div>
    `;
  }
}

function checkAgain() {
  location.reload();
}

function forceRegister() {
  if (confirm('ç¢ºå®šè¦å‰å¾€è¨»å†Šé é¢å—ï¼Ÿ\n\nè«‹å¡«å¯«å®Œæ•´è³‡æ–™ä»¥å®Œæˆè¨»å†Šã€‚')) {
    window.location.href = 'register.html';
  }
}

function goProfile() {
  window.location.href = 'profile.html';
}

init();
</script>

</body>
</html>

