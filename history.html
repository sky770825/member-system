<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é»æ•¸è¨˜éŒ„</title>
<link rel="stylesheet" href="./assets/style.css">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<meta name="description" content="æŸ¥çœ‹æ‚¨çš„é»æ•¸äº¤æ˜“è¨˜éŒ„">
<style>
  .history-header {
    text-align: center;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 2px solid #f0f0f0;
  }
  
  .history-header h1 {
    font-size: 24px;
    color: var(--text-primary);
    margin: 0 0 5px 0;
  }
  
  .history-header p {
    color: var(--text-secondary);
    font-size: 14px;
    margin: 0;
  }
  
  .filter-section {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
  }
  
  .filter-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }
  
  .filter-select {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
  }
  
  .stats-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .stat-box {
    background: white;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  
  .stat-label {
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
  }
  
  .stat-value {
    font-size: 20px;
    font-weight: bold;
  }
  
  .stat-value.positive {
    color: #4CAF50;
  }
  
  .stat-value.negative {
    color: #FF6B6B;
  }
  
  .transaction-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  .transaction-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: var(--bg-secondary);
    border-radius: 12px;
    transition: var(--transition);
    border-left: 4px solid transparent;
  }
  
  .transaction-item.income {
    border-left-color: #4CAF50;
  }
  
  .transaction-item.expense {
    border-left-color: #FF6B6B;
  }
  
  .transaction-item:hover {
    transform: translateX(5px);
    box-shadow: var(--shadow-md);
  }
  
  .transaction-icon {
    font-size: 28px;
    margin-right: 12px;
  }
  
  .transaction-info {
    flex: 1;
  }
  
  .transaction-type {
    font-weight: 600;
    font-size: 15px;
    color: var(--text-primary);
    margin-bottom: 4px;
  }
  
  .transaction-message {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 4px;
  }
  
  .transaction-time {
    font-size: 12px;
    color: #999;
  }
  
  .transaction-amount {
    font-size: 20px;
    font-weight: bold;
    text-align: right;
  }
  
  .transaction-amount.positive {
    color: #4CAF50;
  }
  
  .transaction-amount.negative {
    color: #FF6B6B;
  }
  
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #999;
  }
  
  .empty-icon {
    font-size: 64px;
    margin-bottom: 15px;
  }
  
  .btn-back {
    background: none;
    border: none;
    color: #667eea;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    padding: 8px 0;
    transition: all 0.3s;
    display: inline-block;
    margin-bottom: 10px;
  }
  
  .btn-back:hover {
    color: #764ba2;
    transform: translateX(-3px);
  }
</style>
</head>
<body>
<div class="container">
  <div class="register-card">
    <button class="btn-back" onclick="goBack()">â† è¿”å›</button>
    
    <div class="history-header">
      <h1>ğŸ“Š é»æ•¸è¨˜éŒ„</h1>
      <p>æŸ¥çœ‹æ‚¨çš„æ‰€æœ‰äº¤æ˜“è¨˜éŒ„</p>
    </div>
    
    <!-- çµ±è¨ˆè³‡è¨Š -->
    <div class="stats-row" id="statsRow" style="display: none;">
      <div class="stat-box">
        <div class="stat-label">ç¸½æ”¶å…¥</div>
        <div class="stat-value positive" id="totalIncome">0</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">ç¸½æ”¯å‡º</div>
        <div class="stat-value negative" id="totalExpense">0</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">äº¤æ˜“ç­†æ•¸</div>
        <div class="stat-value" id="totalCount">0</div>
      </div>
    </div>
    
    <!-- ç¯©é¸åŠŸèƒ½ -->
    <div class="filter-section">
      <div class="filter-row">
        <select class="filter-select" id="typeFilter" onchange="applyFilter()">
          <option value="all">å…¨éƒ¨é¡å‹</option>
          <option value="register">è¨»å†Šè´ˆé€</option>
          <option value="referral">æ¨è–¦çå‹µ</option>
          <option value="transfer_in">æ”¶åˆ°è½‰é»</option>
          <option value="transfer_out">è½‰å‡ºé»æ•¸</option>
          <option value="admin_add">ç®¡ç†å“¡å¢åŠ </option>
          <option value="admin_deduct">ç®¡ç†å“¡æ‰£é™¤</option>
        </select>
        <select class="filter-select" id="sortOrder" onchange="applyFilter()">
          <option value="desc">æœ€æ–°åœ¨å‰</option>
          <option value="asc">æœ€èˆŠåœ¨å‰</option>
        </select>
      </div>
      <button class="btn btn-outline" onclick="exportTransactions()" style="width: 100%;">
        ğŸ“¤ åŒ¯å‡ºè¨˜éŒ„
      </button>
    </div>
    
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>è¼‰å…¥è¨˜éŒ„ä¸­...</p>
    </div>
    
    <ul class="transaction-list" id="transactionList"></ul>
    
    <div id="message" class="message"></div>
  </div>
</div>

<script src="./assets/utils.js?v=20251017"></script>
<script src="./assets/security.js?v=20251017"></script>
<script>
let lineUserId = '';
let allTransactions = [];
let filteredTransactions = [];

// äº¤æ˜“é¡å‹é…ç½®
const transactionTypes = {
  register: { name: 'è¨»å†Šè´ˆé€', icon: 'ğŸ', type: 'income' },
  referral_reward: { name: 'æ¨è–¦çå‹µ', icon: 'ğŸ‰', type: 'income' },
  referral_bonus: { name: 'æ¨è–¦çå‹µ', icon: 'ğŸ‰', type: 'income' },
  transfer_in: { name: 'æ”¶åˆ°è½‰é»', icon: 'ğŸ’°', type: 'income' },
  transfer_out: { name: 'è½‰å‡ºé»æ•¸', icon: 'ğŸ’¸', type: 'expense' },
  admin_add: { name: 'ç®¡ç†å“¡å¢åŠ ', icon: 'â•', type: 'income' },
  admin_deduct: { name: 'ç®¡ç†å“¡æ‰£é™¤', icon: 'â–', type: 'expense' }
};

// åˆå§‹åŒ– LIFF
async function initLiff() {
  try {
    console.log('ğŸ” åˆå§‹åŒ– LIFF...');
    
    const profile = await LiffHelper.init(LIFF_CONFIG.profile, {
      redirectOnError: true
    });
    
    if (!profile) return;
    
    lineUserId = profile.userId;
    console.log('âœ… LINE ç™»å…¥æˆåŠŸ:', profile.displayName);
    
    // è¼‰å…¥äº¤æ˜“è¨˜éŒ„
    await loadTransactions();
    
  } catch (error) {
    logError('initLiff', error);
    console.error('âŒ åˆå§‹åŒ–éŒ¯èª¤:', error);
    
    document.getElementById('loading').innerHTML = `
      <div class="error-icon" style="font-size: 48px; text-align: center; margin-bottom: 15px;">âŒ</div>
      <h3 style="text-align: center; margin: 0 0 10px 0;">è¼‰å…¥å¤±æ•—</h3>
      <p style="text-align: center; color: #666; margin: 0 0 20px 0;">${error.message || 'è«‹ç¨å¾Œå†è©¦'}</p>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button class="btn btn-primary" onclick="initLiff()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
        <button class="btn btn-outline" onclick="goBack()">â†©ï¸ è¿”å›</button>
      </div>
    `;
  }
}

// è¼‰å…¥äº¤æ˜“è¨˜éŒ„
async function loadTransactions() {
  try {
    console.log('ğŸ“¥ è¼‰å…¥äº¤æ˜“è¨˜éŒ„...');
    
    const data = await apiCall('transactions', { 
      lineUserId, 
      limit: 100 
    }, { retryCount: 2 });
    
    if (!data.success) {
      throw new Error(data.message || 'è¼‰å…¥å¤±æ•—');
    }
    
    allTransactions = data.transactions || [];
    console.log(`âœ… è¼‰å…¥äº† ${allTransactions.length} ç­†è¨˜éŒ„`);
    
    // éš±è—è¼‰å…¥ä¸­
    document.getElementById('loading').style.display = 'none';
    
    // é¡¯ç¤ºçµ±è¨ˆ
    calculateStats();
    
    // å¥—ç”¨ç¯©é¸
    applyFilter();
    
  } catch (error) {
    logError('loadTransactions', error, { lineUserId });
    throw error;
  }
}

// è¨ˆç®—çµ±è¨ˆè³‡æ–™
function calculateStats() {
  let totalIncome = 0;
  let totalExpense = 0;
  
  allTransactions.forEach(trans => {
    const points = parseFloat(trans.points) || 0;
    if (points > 0) {
      totalIncome += points;
    } else {
      totalExpense += Math.abs(points);
    }
  });
  
  document.getElementById('totalIncome').textContent = Formatter.points(totalIncome);
  document.getElementById('totalExpense').textContent = Formatter.points(totalExpense);
  document.getElementById('totalCount').textContent = allTransactions.length;
  document.getElementById('statsRow').style.display = 'grid';
}

// å¥—ç”¨ç¯©é¸
function applyFilter() {
  const typeFilter = document.getElementById('typeFilter').value;
  const sortOrder = document.getElementById('sortOrder').value;
  
  // ç¯©é¸
  filteredTransactions = allTransactions.filter(trans => {
    if (typeFilter === 'all') return true;
    return trans.type === typeFilter;
  });
  
  // æ’åº
  filteredTransactions.sort((a, b) => {
    const dateA = new Date(a.createdAt);
    const dateB = new Date(b.createdAt);
    return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
  });
  
  // æ¸²æŸ“
  renderTransactions();
}

// æ¸²æŸ“äº¤æ˜“è¨˜éŒ„
function renderTransactions() {
  const listElement = document.getElementById('transactionList');
  
  if (filteredTransactions.length === 0) {
    listElement.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ“</div>
        <p style="font-size: 16px; margin: 0;">æš«ç„¡äº¤æ˜“è¨˜éŒ„</p>
        <p style="font-size: 14px; color: #999; margin: 10px 0 0 0;">æ‚¨çš„äº¤æ˜“è¨˜éŒ„æœƒé¡¯ç¤ºåœ¨é€™è£¡</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  
  filteredTransactions.forEach(trans => {
    const config = transactionTypes[trans.type] || { name: trans.type, icon: 'ğŸ’«', type: 'income' };
    const points = parseFloat(trans.points) || 0;
    const isIncome = points > 0;
    const itemClass = isIncome ? 'income' : 'expense';
    const amountClass = isIncome ? 'positive' : 'negative';
    const displayPoints = isIncome ? `+${Formatter.points(points)}` : Formatter.points(points);
    
    // çµ„åˆè¨Šæ¯
    let message = trans.message || '';
    if (trans.senderName && trans.type === 'transfer_in') {
      message = `ä¾†è‡ª ${trans.senderName}`;
    } else if (trans.receiverName && trans.type === 'transfer_out') {
      message = `è½‰çµ¦ ${trans.receiverName}`;
    }
    if (trans.message) {
      message += trans.message ? ` - ${trans.message}` : '';
    }
    
    html += `
      <li class="transaction-item ${itemClass}">
        <span class="transaction-icon">${config.icon}</span>
        <div class="transaction-info">
          <div class="transaction-type">${config.name}</div>
          ${message ? `<div class="transaction-message">${message}</div>` : ''}
          <div class="transaction-time">${Formatter.relativeTime(trans.createdAt)}</div>
        </div>
        <div class="transaction-amount ${amountClass}">${displayPoints}</div>
      </li>
    `;
  });
  
  listElement.innerHTML = html;
}

// åŒ¯å‡ºäº¤æ˜“è¨˜éŒ„
function exportTransactions() {
  if (filteredTransactions.length === 0) {
    UIHelper.showMessage('æ²’æœ‰è¨˜éŒ„å¯ä»¥åŒ¯å‡º', 'warning');
    return;
  }
  
  // æº–å‚™ CSV è³‡æ–™
  let csv = 'äº¤æ˜“æ™‚é–“,äº¤æ˜“é¡å‹,å°æ–¹,é»æ•¸è®Šå‹•,èªªæ˜\n';
  
  filteredTransactions.forEach(trans => {
    const config = transactionTypes[trans.type] || { name: trans.type };
    const points = parseFloat(trans.points) || 0;
    const date = Formatter.date(trans.createdAt);
    const other = trans.senderName || trans.receiverName || '-';
    const message = (trans.message || '').replace(/,/g, 'ï¼Œ'); // æ›¿æ›é€—è™Ÿé¿å… CSV éŒ¯èª¤
    
    csv += `${date},${config.name},${other},${points},${message}\n`;
  });
  
  // ä¸‹è¼‰æª”æ¡ˆ
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', `é»æ•¸è¨˜éŒ„_${new Date().toISOString().split('T')[0]}.csv`);
  link.style.visibility = 'hidden';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  UIHelper.showMessage('âœ… è¨˜éŒ„å·²åŒ¯å‡º', 'success');
  console.log('âœ… åŒ¯å‡ºäº†', filteredTransactions.length, 'ç­†è¨˜éŒ„');
}

// è¿”å›
function goBack() {
  LiffHelper.closeWindow();
}

// åˆå§‹åŒ–
initLiff();
</script>
</body>
</html>
