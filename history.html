<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>點數記錄</title>
<link rel="stylesheet" href="./assets/style.css">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<meta name="description" content="查看您的點數交易記錄">
<style>
  .history-header {
    text-align: center;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 2px solid #f0f0f0;
  }
  
  .history-header h1 {
    font-size: 24px;
    color: var(--text-primary);
    margin: 0 0 5px 0;
  }
  
  .history-header p {
    color: var(--text-secondary);
    font-size: 14px;
    margin: 0;
  }
  
  .filter-section {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
  }
  
  .filter-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }
  
  .filter-select {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
  }
  
  .stats-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .stat-box {
    background: white;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  
  .stat-label {
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
  }
  
  .stat-value {
    font-size: 20px;
    font-weight: bold;
  }
  
  .stat-value.positive {
    color: #4CAF50;
  }
  
  .stat-value.negative {
    color: #FF6B6B;
  }
  
  .transaction-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  .transaction-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: var(--bg-secondary);
    border-radius: 12px;
    transition: var(--transition);
    border-left: 4px solid transparent;
  }
  
  .transaction-item.income {
    border-left-color: #4CAF50;
  }
  
  .transaction-item.expense {
    border-left-color: #FF6B6B;
  }
  
  .transaction-item:hover {
    transform: translateX(5px);
    box-shadow: var(--shadow-md);
  }
  
  .transaction-icon {
    font-size: 28px;
    margin-right: 12px;
  }
  
  .transaction-info {
    flex: 1;
  }
  
  .transaction-type {
    font-weight: 600;
    font-size: 15px;
    color: var(--text-primary);
    margin-bottom: 4px;
  }
  
  .transaction-message {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 4px;
  }
  
  .transaction-time {
    font-size: 12px;
    color: #999;
  }
  
  .transaction-amount {
    font-size: 20px;
    font-weight: bold;
    text-align: right;
  }
  
  .transaction-amount.positive {
    color: #4CAF50;
  }
  
  .transaction-amount.negative {
    color: #FF6B6B;
  }
  
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #999;
  }
  
  .empty-icon {
    font-size: 64px;
    margin-bottom: 15px;
  }
  
  .btn-back {
    background: none;
    border: none;
    color: #667eea;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    padding: 8px 0;
    transition: all 0.3s;
    display: inline-block;
    margin-bottom: 10px;
  }
  
  .btn-back:hover {
    color: #764ba2;
    transform: translateX(-3px);
  }
</style>
</head>
<body>
<div class="container">
  <div class="register-card">
    <button class="btn-back" onclick="goBack()">← 返回</button>
    
    <div class="history-header">
      <h1>📊 點數記錄</h1>
      <p>查看您的所有交易記錄</p>
    </div>
    
    <!-- 統計資訊 -->
    <div class="stats-row" id="statsRow" style="display: none;">
      <div class="stat-box">
        <div class="stat-label">總收入</div>
        <div class="stat-value positive" id="totalIncome">0</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">總支出</div>
        <div class="stat-value negative" id="totalExpense">0</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">交易筆數</div>
        <div class="stat-value" id="totalCount">0</div>
      </div>
    </div>
    
    <!-- 篩選功能 -->
    <div class="filter-section">
      <div class="filter-row">
        <select class="filter-select" id="typeFilter" onchange="applyFilter()">
          <option value="all">全部類型</option>
          <option value="register">註冊贈送</option>
          <option value="referral">推薦獎勵</option>
          <option value="transfer_in">收到轉點</option>
          <option value="transfer_out">轉出點數</option>
          <option value="admin_add">管理員增加</option>
          <option value="admin_deduct">管理員扣除</option>
        </select>
        <select class="filter-select" id="sortOrder" onchange="applyFilter()">
          <option value="desc">最新在前</option>
          <option value="asc">最舊在前</option>
        </select>
      </div>
      <button class="btn btn-outline" onclick="exportTransactions()" style="width: 100%;">
        📤 匯出記錄
      </button>
    </div>
    
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>載入記錄中...</p>
    </div>
    
    <ul class="transaction-list" id="transactionList"></ul>
    
    <div id="message" class="message"></div>
  </div>
</div>

<script src="./assets/utils.js?v=20251017"></script>
<script src="./assets/security.js?v=20251017"></script>
<script>
let lineUserId = '';
let allTransactions = [];
let filteredTransactions = [];

// 交易類型配置
const transactionTypes = {
  register: { name: '註冊贈送', icon: '🎁', type: 'income' },
  referral_reward: { name: '推薦獎勵', icon: '🎉', type: 'income' },
  referral_bonus: { name: '推薦獎勵', icon: '🎉', type: 'income' },
  transfer_in: { name: '收到轉點', icon: '💰', type: 'income' },
  transfer_out: { name: '轉出點數', icon: '💸', type: 'expense' },
  admin_add: { name: '管理員增加', icon: '➕', type: 'income' },
  admin_deduct: { name: '管理員扣除', icon: '➖', type: 'expense' }
};

// 初始化 LIFF
async function initLiff() {
  try {
    console.log('🔐 初始化 LIFF...');
    
    const profile = await LiffHelper.init(LIFF_CONFIG.profile, {
      redirectOnError: true
    });
    
    if (!profile) return;
    
    lineUserId = profile.userId;
    console.log('✅ LINE 登入成功:', profile.displayName);
    
    // 載入交易記錄
    await loadTransactions();
    
  } catch (error) {
    logError('initLiff', error);
    console.error('❌ 初始化錯誤:', error);
    
    document.getElementById('loading').innerHTML = `
      <div class="error-icon" style="font-size: 48px; text-align: center; margin-bottom: 15px;">❌</div>
      <h3 style="text-align: center; margin: 0 0 10px 0;">載入失敗</h3>
      <p style="text-align: center; color: #666; margin: 0 0 20px 0;">${error.message || '請稍後再試'}</p>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button class="btn btn-primary" onclick="initLiff()">🔄 重新載入</button>
        <button class="btn btn-outline" onclick="goBack()">↩️ 返回</button>
      </div>
    `;
  }
}

// 載入交易記錄
async function loadTransactions() {
  try {
    console.log('📥 載入交易記錄...');
    
    const data = await apiCall('transactions', { 
      lineUserId, 
      limit: 100 
    }, { retryCount: 2 });
    
    if (!data.success) {
      throw new Error(data.message || '載入失敗');
    }
    
    allTransactions = data.transactions || [];
    console.log(`✅ 載入了 ${allTransactions.length} 筆記錄`);
    
    // 隱藏載入中
    document.getElementById('loading').style.display = 'none';
    
    // 顯示統計
    calculateStats();
    
    // 套用篩選
    applyFilter();
    
  } catch (error) {
    logError('loadTransactions', error, { lineUserId });
    throw error;
  }
}

// 計算統計資料
function calculateStats() {
  let totalIncome = 0;
  let totalExpense = 0;
  
  allTransactions.forEach(trans => {
    const points = parseFloat(trans.points) || 0;
    if (points > 0) {
      totalIncome += points;
    } else {
      totalExpense += Math.abs(points);
    }
  });
  
  document.getElementById('totalIncome').textContent = Formatter.points(totalIncome);
  document.getElementById('totalExpense').textContent = Formatter.points(totalExpense);
  document.getElementById('totalCount').textContent = allTransactions.length;
  document.getElementById('statsRow').style.display = 'grid';
}

// 套用篩選
function applyFilter() {
  const typeFilter = document.getElementById('typeFilter').value;
  const sortOrder = document.getElementById('sortOrder').value;
  
  // 篩選
  filteredTransactions = allTransactions.filter(trans => {
    if (typeFilter === 'all') return true;
    return trans.type === typeFilter;
  });
  
  // 排序
  filteredTransactions.sort((a, b) => {
    const dateA = new Date(a.createdAt);
    const dateB = new Date(b.createdAt);
    return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
  });
  
  // 渲染
  renderTransactions();
}

// 渲染交易記錄
function renderTransactions() {
  const listElement = document.getElementById('transactionList');
  
  if (filteredTransactions.length === 0) {
    listElement.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">📝</div>
        <p style="font-size: 16px; margin: 0;">暫無交易記錄</p>
        <p style="font-size: 14px; color: #999; margin: 10px 0 0 0;">您的交易記錄會顯示在這裡</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  
  filteredTransactions.forEach(trans => {
    const config = transactionTypes[trans.type] || { name: trans.type, icon: '💫', type: 'income' };
    const points = parseFloat(trans.points) || 0;
    const isIncome = points > 0;
    const itemClass = isIncome ? 'income' : 'expense';
    const amountClass = isIncome ? 'positive' : 'negative';
    const displayPoints = isIncome ? `+${Formatter.points(points)}` : Formatter.points(points);
    
    // 組合訊息
    let message = trans.message || '';
    if (trans.senderName && trans.type === 'transfer_in') {
      message = `來自 ${trans.senderName}`;
    } else if (trans.receiverName && trans.type === 'transfer_out') {
      message = `轉給 ${trans.receiverName}`;
    }
    if (trans.message) {
      message += trans.message ? ` - ${trans.message}` : '';
    }
    
    html += `
      <li class="transaction-item ${itemClass}">
        <span class="transaction-icon">${config.icon}</span>
        <div class="transaction-info">
          <div class="transaction-type">${config.name}</div>
          ${message ? `<div class="transaction-message">${message}</div>` : ''}
          <div class="transaction-time">${Formatter.relativeTime(trans.createdAt)}</div>
        </div>
        <div class="transaction-amount ${amountClass}">${displayPoints}</div>
      </li>
    `;
  });
  
  listElement.innerHTML = html;
}

// 匯出交易記錄
function exportTransactions() {
  if (filteredTransactions.length === 0) {
    UIHelper.showMessage('沒有記錄可以匯出', 'warning');
    return;
  }
  
  // 準備 CSV 資料
  let csv = '交易時間,交易類型,對方,點數變動,說明\n';
  
  filteredTransactions.forEach(trans => {
    const config = transactionTypes[trans.type] || { name: trans.type };
    const points = parseFloat(trans.points) || 0;
    const date = Formatter.date(trans.createdAt);
    const other = trans.senderName || trans.receiverName || '-';
    const message = (trans.message || '').replace(/,/g, '，'); // 替換逗號避免 CSV 錯誤
    
    csv += `${date},${config.name},${other},${points},${message}\n`;
  });
  
  // 下載檔案
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', `點數記錄_${new Date().toISOString().split('T')[0]}.csv`);
  link.style.visibility = 'hidden';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  UIHelper.showMessage('✅ 記錄已匯出', 'success');
  console.log('✅ 匯出了', filteredTransactions.length, '筆記錄');
}

// 返回
function goBack() {
  LiffHelper.closeWindow();
}

// 初始化
initLiff();
</script>
</body>
</html>
