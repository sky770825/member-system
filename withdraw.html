<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>提領兌現 - 公益點數系統</title>
<link rel="stylesheet" href="./assets/style.css">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="card-header">
      <h1>💵 提領兌現</h1>
      <p style="color: #E69500; font-weight: 600;">將公益點數轉換為實際獎勵</p>
    </div>
    
    <!-- 當前點數顯示 -->
    <div class="current-points" id="currentPoints" style="border-color: #FFB800;">
      <p class="points-label" style="color: #856404; font-weight: 600;">❤️ 可提領公益點數</p>
      <p class="points-value" style="color: #FFB800; font-weight: 800;">-- <span style="color: #856404; font-size: 20px; font-weight: 600;">點</span></p>
    </div>
    
    <!-- 提領資訊說明 -->
    <div style="background: linear-gradient(135deg, #E8F5E9, #C8E6C9); padding: 16px; border-radius: 12px; border: 2px solid #4CAF50; margin: 20px 0;">
      <h3 style="margin: 0 0 12px 0; color: #2E7D32; font-size: 16px; font-weight: 600;">💡 提領說明</h3>
      <ul style="margin: 0; padding-left: 20px; color: #1B5E20; font-size: 14px; line-height: 1.8;">
        <li>最低提領金額：<strong>100 點</strong></li>
        <li>提領比例：<strong>1 點 = 0.7 元</strong></li>
        <li>處理時間：<strong>1-3 個工作天</strong></li>
        <li>手續費：<strong>15 元</strong></li>
      </ul>
    </div>
    
    <form id="withdrawForm">
      <div class="form-group">
        <label for="withdrawPoints">❤️ 提領點數 *</label>
        <input type="number" id="withdrawPoints" name="withdrawPoints" required placeholder="請輸入提領點數" min="100">
        <small>最少提領 100 點，將自動檢查餘額</small>
      </div>
      
      <!-- 快速選擇 -->
      <div class="quick-amount">
        <p style="margin: 0 0 10px 0; color: #666; font-size: 14px; font-weight: 600;">⚡ 快速選擇：</p>
        <div class="quick-btns">
          <button type="button" class="btn-quick" onclick="setAmount(100)">
            <span style="font-size: 18px; font-weight: 800;">100</span>
          </button>
          <button type="button" class="btn-quick" onclick="setAmount(500)">
            <span style="font-size: 18px; font-weight: 800;">500</span>
          </button>
          <button type="button" class="btn-quick" onclick="setAmount(1000)">
            <span style="font-size: 18px; font-weight: 800;">1000</span>
          </button>
          <button type="button" class="btn-quick" onclick="setAmount(5000)">
            <span style="font-size: 18px; font-weight: 800;">5000</span>
          </button>
          <button type="button" class="btn-quick" onclick="setAmountAll()">
            <span style="font-size: 16px; font-weight: 800;">全部</span>
          </button>
        </div>
      </div>
      
      <div class="form-group">
        <label for="bankName">銀行名稱 *</label>
        <input type="text" id="bankName" name="bankName" required placeholder="例如：台灣銀行">
      </div>
      
      <div class="form-group">
        <label for="bankAccount">銀行帳號 *</label>
        <input type="text" id="bankAccount" name="bankAccount" required placeholder="請輸入完整帳號" maxlength="20">
      </div>
      
      <div class="form-group">
        <label for="accountName">戶名 *</label>
        <input type="text" id="accountName" name="accountName" required placeholder="必須與會員姓名一致">
        <small id="nameHint" style="color: #666;">戶名必須與註冊姓名一致</small>
      </div>
      
      <div class="form-group">
        <label for="notes">備註（選填）</label>
        <textarea id="notes" name="notes" placeholder="特殊需求或備註..." rows="3" maxlength="200"></textarea>
      </div>
      
      <!-- 提領明細 -->
      <div id="withdrawDetail" style="display: none; background: linear-gradient(135deg, #FFF3E0, #FFE0B2); padding: 16px; border-radius: 12px; border: 2px solid #FF9800; margin: 20px 0;">
        <h3 style="margin: 0 0 12px 0; color: #E65100; font-size: 16px; font-weight: 600;">📋 提領明細</h3>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #666;">提領點數：</span>
            <span id="detailPoints" style="font-weight: 700; color: #FF6B00;">--</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #666;">提領金額：</span>
            <span id="detailAmount" style="font-weight: 700; color: #FF6B00;">--</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #666;">匯款銀行：</span>
            <span id="detailBank" style="font-weight: 700; color: #666;">--</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #666;">帳號後4碼：</span>
            <span id="detailAccount" style="font-weight: 700; color: #666;">--</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #666;">預計到帳：</span>
            <span style="font-weight: 700; color: #666;">1-3 個工作天</span>
          </div>
        </div>
      </div>
      
      <button type="submit" class="btn btn-primary btn-large" id="submitBtn">
        <span class="btn-icon">💵</span>
        確認提領
      </button>
    </form>
    
    <button class="btn btn-back" onclick="goBack()">
      ← 返回會員中心
    </button>
    
    <div id="message" class="message" style="display:none;"></div>
  </div>
</div>

<script src="./assets/auth.js"></script>
<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzjGZOfhfd792G7hv-6wbyClTxcvD1n5zsxRQC6yfJatjKG5fTayhyz3EdhUNDDNQ96/exec';

let currentUserId = '';
let currentUserName = '';
let currentPoints = 0;

// 初始化
async function init() {
  try {
    // 使用認證工具初始化
    const authResult = await AUTH.init();
    
    if (!authResult.success) {
      return;
    }
    
    currentUserId = authResult.user.userId;
    
    // 取得會員資料
    const res = await fetch(`${API_URL}?action=profile&lineUserId=${currentUserId}`);
    const data = await res.json();
    
    if (data.success) {
      currentUserName = data.name;
      currentPoints = data.points || 0;
      
      // 顯示當前點數
      document.getElementById('currentPoints').innerHTML = `
        <p class="points-label" style="color: #856404; font-weight: 600;">❤️ 可提領公益點數</p>
        <p class="points-value" style="color: #FFB800; font-weight: 800;">${currentPoints.toLocaleString()} <span style="color: #856404; font-size: 20px; font-weight: 600;">點</span></p>
      `;
      
      // 設定戶名提示
      document.getElementById('nameHint').textContent = `戶名必須是：${currentUserName}`;
      document.getElementById('accountName').value = currentUserName;
      
      // 檢查是否有推薦人（從 profile 資料判斷）
      if (data.referredBy) {
        // 查詢推薦人詳細資訊
        checkReferrer(data.referredBy);
      }
    }
    
  } catch (error) {
    console.error('初始化錯誤:', error);
    showMessage('❌ 載入失敗，請重新整理頁面', 'error');
  }
}

// 檢查推薦人
async function checkReferrer(referralCode) {
  try {
    const res = await fetch(`${API_URL}?action=verify-referral&referralCode=${referralCode}`);
    const data = await res.json();
    
    if (data.success && data.referrer) {
      document.getElementById('referrerReward').style.display = 'block';
      document.getElementById('referrerRewardText').innerHTML = 
        `👤 推薦人：<strong style="color: #667eea; font-size: 16px;">${data.referrer.name}</strong> (<span style="color: #999; font-size: 13px;">${referralCode}</span>)`;
    }
  } catch (error) {
    console.error('檢查推薦人失敗:', error);
  }
}

// 設定金額
function setAmount(amount) {
  if (amount > currentPoints) {
    showMessage('❤️ 公益點數不足', 'error');
    return;
  }
  document.getElementById('withdrawPoints').value = amount;
  updateWithdrawDetail();
}

// 設定全部金額
function setAmountAll() {
  if (currentPoints < 100) {
    showMessage('❤️ 公益點數不足 100 點，無法提領', 'error');
    return;
  }
  document.getElementById('withdrawPoints').value = currentPoints;
  updateWithdrawDetail();
}

// 監聽提領點數變化
document.getElementById('withdrawPoints').addEventListener('input', updateWithdrawDetail);
document.getElementById('bankName').addEventListener('input', updateWithdrawDetail);
document.getElementById('bankAccount').addEventListener('input', updateWithdrawDetail);

// 更新提領明細
function updateWithdrawDetail() {
  const points = parseInt(document.getElementById('withdrawPoints').value) || 0;
  const bankName = document.getElementById('bankName').value.trim();
  const bankAccount = document.getElementById('bankAccount').value.trim();
  
  if (points >= 100 && bankName && bankAccount) {
    // 計算實際提領金額（0.7 換算 - 15 元手續費）
    const amountBeforeFee = Math.floor(points * 0.7);
    const fee = 15;
    const actualAmount = amountBeforeFee - fee;
    
    document.getElementById('withdrawDetail').style.display = 'block';
    document.getElementById('detailPoints').textContent = points.toLocaleString() + ' 點';
    document.getElementById('detailAmount').textContent = 'NT$ ' + actualAmount.toLocaleString() + ' (已扣手續費)';
    document.getElementById('detailBank').textContent = bankName;
    
    // 顯示帳號後4碼
    if (bankAccount.length >= 4) {
      const lastFour = bankAccount.slice(-4);
      document.getElementById('detailAccount').textContent = '****' + lastFour;
    } else {
      document.getElementById('detailAccount').textContent = bankAccount;
    }
  } else {
    document.getElementById('withdrawDetail').style.display = 'none';
  }
}

// 處理提領
document.getElementById('withdrawForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const points = parseInt(document.getElementById('withdrawPoints').value);
  const bankName = document.getElementById('bankName').value.trim();
  const bankAccount = document.getElementById('bankAccount').value.trim();
  const accountName = document.getElementById('accountName').value.trim();
  const notes = document.getElementById('notes').value.trim();
  
  // 驗證
  if (points < 100) {
    showMessage('❌ 最少提領 100 點', 'error');
    return;
  }
  
  if (points > currentPoints) {
    showMessage('❤️ 公益點數不足', 'error');
    return;
  }
  
  if (accountName !== currentUserName) {
    showMessage('❌ 戶名必須與會員姓名一致', 'error');
    return;
  }
  
  // 計算實際提領金額（0.7 換算 - 15 元手續費）
  const amountBeforeFee = Math.floor(points * 0.7);
  const fee = 15;
  const actualAmount = amountBeforeFee - fee;
  
  // 確認對話框
  const confirmMsg = `確認提領資訊：\n\n` +
                     `提領點數：${points.toLocaleString()} 點\n` +
                     `換算金額：NT$ ${amountBeforeFee.toLocaleString()}\n` +
                     `手續費：NT$ ${fee}\n` +
                     `實際到帳：NT$ ${actualAmount.toLocaleString()}\n\n` +
                     `匯款銀行：${bankName}\n` +
                     `銀行帳號：${bankAccount}\n` +
                     `戶名：${accountName}\n\n` +
                     `預計 1-3 個工作天內匯款\n\n` +
                     `確定要提領嗎？`;
  
  if (!confirm(confirmMsg)) {
    return;
  }
  
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="btn-icon">⏳</span> 處理中...';
  
  try {
    // 🔐 使用安全的 POST 方式傳送敏感資料（銀行帳號）
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        action: 'withdraw',
        lineUserId: currentUserId,
        points: points,
        bankName: bankName,
        bankAccount: bankAccount,
        accountName: accountName,
        notes: notes
      })
    });
    const data = await res.json();
    
    if (data.success) {
      let successMsg = `🎉 提領申請成功！\n\n` +
                       `提領點數：${points.toLocaleString()} 點\n` +
                       `提領金額：NT$ ${points.toLocaleString()}\n` +
                       `剩餘點數：${data.points.toLocaleString()} 點\n\n` +
                       `預計 1-3 個工作天匯入您的帳戶`;
      
      if (data.referrerReward && data.referrerReward.success) {
        successMsg += `\n\n推薦人 ${data.referrerReward.referrerName} 獲得了 ${data.referrerReward.reward.toLocaleString()} 點獎勵！`;
      }
      
      showMessage(successMsg, 'success');
      
      // 清空表單
      document.getElementById('withdrawForm').reset();
      document.getElementById('accountName').value = currentUserName;
      document.getElementById('withdrawDetail').style.display = 'none';
      
      // 更新當前點數
      currentPoints = data.points;
      document.getElementById('currentPoints').innerHTML = `
        <p class="points-label" style="color: #856404; font-weight: 600;">❤️ 可提領公益點數</p>
        <p class="points-value" style="color: #FFB800; font-weight: 800;">${currentPoints.toLocaleString()} <span style="color: #856404; font-size: 20px; font-weight: 600;">點</span></p>
      `;
      
      // 3 秒後跳轉
      setTimeout(() => {
        window.location.href = 'profile.html';
      }, 3000);
    } else {
      showMessage('❌ ' + (data.message || '提領失敗'), 'error');
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span class="btn-icon">💵</span> 確認提領';
    }
  } catch (error) {
    console.error('提領錯誤:', error);
    showMessage('❌ 系統錯誤: ' + error.message, 'error');
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<span class="btn-icon">💵</span> 確認提領';
  }
});

function showMessage(msg, type) {
  const messageDiv = document.getElementById('message');
  messageDiv.textContent = msg;
  messageDiv.className = `message ${type}`;
  messageDiv.style.display = 'block';
  
  // 自動隱藏訊息
  setTimeout(() => {
    messageDiv.style.display = 'none';
  }, type === 'success' ? 5000 : 3000); // 成功5秒，錯誤3秒
}

function goBack() {
  window.location.href = 'profile.html';
}

init();
</script>
</body>
</html>

