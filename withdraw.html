<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æé ˜å…Œç¾ - å…¬ç›Šé»æ•¸ç³»çµ±</title>
<link rel="stylesheet" href="./assets/style.css">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="card-header">
      <h1>ğŸ’µ æé ˜å…Œç¾</h1>
      <p style="color: #E69500; font-weight: 600;">å°‡å…¬ç›Šé»æ•¸è½‰æ›ç‚ºå¯¦éš›çå‹µ</p>
    </div>
    
    <!-- ç•¶å‰é»æ•¸é¡¯ç¤º -->
    <div class="current-points" id="currentPoints" style="border-color: #FFB800;">
      <p class="points-label" style="color: #856404; font-weight: 600;">â¤ï¸ å¯æé ˜å…¬ç›Šé»æ•¸</p>
      <p class="points-value" style="color: #FFB800; font-weight: 800;">-- <span style="color: #856404; font-size: 20px; font-weight: 600;">é»</span></p>
    </div>
    
    <!-- æé ˜è³‡è¨Šèªªæ˜ -->
    <div style="background: linear-gradient(135deg, #E8F5E9, #C8E6C9); padding: 16px; border-radius: 12px; border: 2px solid #4CAF50; margin: 20px 0;">
      <h3 style="margin: 0 0 12px 0; color: #2E7D32; font-size: 16px; font-weight: 600;">ğŸ’¡ æé ˜èªªæ˜</h3>
      <ul style="margin: 0; padding-left: 20px; color: #1B5E20; font-size: 14px; line-height: 1.8;">
        <li>æœ€ä½æé ˜é‡‘é¡ï¼š<strong>100 é»</strong></li>
        <li>æé ˜æ¯”ä¾‹ï¼š<strong>1 é» = 0.7 å…ƒ</strong></li>
        <li>è™•ç†æ™‚é–“ï¼š<strong>1-3 å€‹å·¥ä½œå¤©</strong></li>
        <li>æ‰‹çºŒè²»ï¼š<strong>15 å…ƒ</strong></li>
      </ul>
    </div>
    
    <form id="withdrawForm">
      <div class="form-group">
        <label for="withdrawPoints">â¤ï¸ æé ˜é»æ•¸ *</label>
        <input type="number" id="withdrawPoints" name="withdrawPoints" required placeholder="è«‹è¼¸å…¥æé ˜é»æ•¸" min="100">
        <small>æœ€å°‘æé ˜ 100 é»ï¼Œå°‡è‡ªå‹•æª¢æŸ¥é¤˜é¡</small>
      </div>
      
      <!-- å¿«é€Ÿé¸æ“‡ -->
      <div class="quick-amount">
        <p style="margin: 0 0 10px 0; color: #666; font-size: 14px; font-weight: 600;">âš¡ å¿«é€Ÿé¸æ“‡ï¼š</p>
        <div class="quick-btns">
          <button type="button" class="btn-quick" onclick="setAmount(100)">
            <span style="font-size: 18px; font-weight: 800;">100</span>
          </button>
          <button type="button" class="btn-quick" onclick="setAmount(500)">
            <span style="font-size: 18px; font-weight: 800;">500</span>
          </button>
          <button type="button" class="btn-quick" onclick="setAmount(1000)">
            <span style="font-size: 18px; font-weight: 800;">1000</span>
          </button>
          <button type="button" class="btn-quick" onclick="setAmount(5000)">
            <span style="font-size: 18px; font-weight: 800;">5000</span>
          </button>
          <button type="button" class="btn-quick" onclick="setAmountAll()">
            <span style="font-size: 16px; font-weight: 800;">å…¨éƒ¨</span>
          </button>
        </div>
      </div>
      
      <div class="form-group">
        <label for="bankName">éŠ€è¡Œåç¨± *</label>
        <input type="text" id="bankName" name="bankName" required placeholder="ä¾‹å¦‚ï¼šå°ç£éŠ€è¡Œ">
      </div>
      
      <div class="form-group">
        <label for="bankAccount">éŠ€è¡Œå¸³è™Ÿ *</label>
        <input type="text" id="bankAccount" name="bankAccount" required placeholder="è«‹è¼¸å…¥å®Œæ•´å¸³è™Ÿ" maxlength="20">
      </div>
      
      <div class="form-group">
        <label for="accountName">æˆ¶å *</label>
        <input type="text" id="accountName" name="accountName" required placeholder="å¿…é ˆèˆ‡æœƒå“¡å§“åä¸€è‡´">
        <small id="nameHint" style="color: #666;">æˆ¶åå¿…é ˆèˆ‡è¨»å†Šå§“åä¸€è‡´</small>
      </div>
      
      <div class="form-group">
        <label for="notes">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
        <textarea id="notes" name="notes" placeholder="ç‰¹æ®Šéœ€æ±‚æˆ–å‚™è¨»..." rows="3" maxlength="200"></textarea>
      </div>
      
      <!-- æé ˜æ˜ç´° -->
      <div id="withdrawDetail" style="display: none; background: linear-gradient(135deg, #FFF3E0, #FFE0B2); padding: 16px; border-radius: 12px; border: 2px solid #FF9800; margin: 20px 0;">
        <h3 style="margin: 0 0 12px 0; color: #E65100; font-size: 16px; font-weight: 600;">ğŸ“‹ æé ˜æ˜ç´°</h3>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #666;">æé ˜é»æ•¸ï¼š</span>
            <span id="detailPoints" style="font-weight: 700; color: #FF6B00;">--</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #666;">æé ˜é‡‘é¡ï¼š</span>
            <span id="detailAmount" style="font-weight: 700; color: #FF6B00;">--</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #666;">åŒ¯æ¬¾éŠ€è¡Œï¼š</span>
            <span id="detailBank" style="font-weight: 700; color: #666;">--</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #666;">å¸³è™Ÿå¾Œ4ç¢¼ï¼š</span>
            <span id="detailAccount" style="font-weight: 700; color: #666;">--</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #666;">é è¨ˆåˆ°å¸³ï¼š</span>
            <span style="font-weight: 700; color: #666;">1-3 å€‹å·¥ä½œå¤©</span>
          </div>
        </div>
      </div>
      
      <button type="submit" class="btn btn-primary btn-large" id="submitBtn">
        <span class="btn-icon">ğŸ’µ</span>
        ç¢ºèªæé ˜
      </button>
    </form>
    
    <button class="btn btn-back" onclick="goBack()">
      â† è¿”å›æœƒå“¡ä¸­å¿ƒ
    </button>
    
    <div id="message" class="message" style="display:none;"></div>
  </div>
</div>

<script src="./assets/auth.js"></script>
<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzjGZOfhfd792G7hv-6wbyClTxcvD1n5zsxRQC6yfJatjKG5fTayhyz3EdhUNDDNQ96/exec';

let currentUserId = '';
let currentUserName = '';
let currentPoints = 0;

// åˆå§‹åŒ–
async function init() {
  try {
    // ä½¿ç”¨èªè­‰å·¥å…·åˆå§‹åŒ–
    const authResult = await AUTH.init();
    
    if (!authResult.success) {
      return;
    }
    
    currentUserId = authResult.user.userId;
    
    // å–å¾—æœƒå“¡è³‡æ–™
    const res = await fetch(`${API_URL}?action=profile&lineUserId=${currentUserId}`);
    const data = await res.json();
    
    if (data.success) {
      currentUserName = data.name;
      currentPoints = data.points || 0;
      
      // é¡¯ç¤ºç•¶å‰é»æ•¸
      document.getElementById('currentPoints').innerHTML = `
        <p class="points-label" style="color: #856404; font-weight: 600;">â¤ï¸ å¯æé ˜å…¬ç›Šé»æ•¸</p>
        <p class="points-value" style="color: #FFB800; font-weight: 800;">${currentPoints.toLocaleString()} <span style="color: #856404; font-size: 20px; font-weight: 600;">é»</span></p>
      `;
      
      // è¨­å®šæˆ¶åæç¤º
      document.getElementById('nameHint').textContent = `æˆ¶åå¿…é ˆæ˜¯ï¼š${currentUserName}`;
      document.getElementById('accountName').value = currentUserName;
      
      // æª¢æŸ¥æ˜¯å¦æœ‰æ¨è–¦äººï¼ˆå¾ profile è³‡æ–™åˆ¤æ–·ï¼‰
      if (data.referredBy) {
        // æŸ¥è©¢æ¨è–¦äººè©³ç´°è³‡è¨Š
        checkReferrer(data.referredBy);
      }
    }
    
  } catch (error) {
    console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
    showMessage('âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
  }
}

// æª¢æŸ¥æ¨è–¦äºº
async function checkReferrer(referralCode) {
  try {
    const res = await fetch(`${API_URL}?action=verify-referral&referralCode=${referralCode}`);
    const data = await res.json();
    
    if (data.success && data.referrer) {
      document.getElementById('referrerReward').style.display = 'block';
      document.getElementById('referrerRewardText').innerHTML = 
        `ğŸ‘¤ æ¨è–¦äººï¼š<strong style="color: #667eea; font-size: 16px;">${data.referrer.name}</strong> (<span style="color: #999; font-size: 13px;">${referralCode}</span>)`;
    }
  } catch (error) {
    console.error('æª¢æŸ¥æ¨è–¦äººå¤±æ•—:', error);
  }
}

// è¨­å®šé‡‘é¡
function setAmount(amount) {
  if (amount > currentPoints) {
    showMessage('â¤ï¸ å…¬ç›Šé»æ•¸ä¸è¶³', 'error');
    return;
  }
  document.getElementById('withdrawPoints').value = amount;
  updateWithdrawDetail();
}

// è¨­å®šå…¨éƒ¨é‡‘é¡
function setAmountAll() {
  if (currentPoints < 100) {
    showMessage('â¤ï¸ å…¬ç›Šé»æ•¸ä¸è¶³ 100 é»ï¼Œç„¡æ³•æé ˜', 'error');
    return;
  }
  document.getElementById('withdrawPoints').value = currentPoints;
  updateWithdrawDetail();
}

// ç›£è½æé ˜é»æ•¸è®ŠåŒ–
document.getElementById('withdrawPoints').addEventListener('input', updateWithdrawDetail);
document.getElementById('bankName').addEventListener('input', updateWithdrawDetail);
document.getElementById('bankAccount').addEventListener('input', updateWithdrawDetail);

// æ›´æ–°æé ˜æ˜ç´°
function updateWithdrawDetail() {
  const points = parseInt(document.getElementById('withdrawPoints').value) || 0;
  const bankName = document.getElementById('bankName').value.trim();
  const bankAccount = document.getElementById('bankAccount').value.trim();
  
  if (points >= 100 && bankName && bankAccount) {
    // è¨ˆç®—å¯¦éš›æé ˜é‡‘é¡ï¼ˆ0.7 æ›ç®— - 15 å…ƒæ‰‹çºŒè²»ï¼‰
    const amountBeforeFee = Math.floor(points * 0.7);
    const fee = 15;
    const actualAmount = amountBeforeFee - fee;
    
    document.getElementById('withdrawDetail').style.display = 'block';
    document.getElementById('detailPoints').textContent = points.toLocaleString() + ' é»';
    document.getElementById('detailAmount').textContent = 'NT$ ' + actualAmount.toLocaleString() + ' (å·²æ‰£æ‰‹çºŒè²»)';
    document.getElementById('detailBank').textContent = bankName;
    
    // é¡¯ç¤ºå¸³è™Ÿå¾Œ4ç¢¼
    if (bankAccount.length >= 4) {
      const lastFour = bankAccount.slice(-4);
      document.getElementById('detailAccount').textContent = '****' + lastFour;
    } else {
      document.getElementById('detailAccount').textContent = bankAccount;
    }
  } else {
    document.getElementById('withdrawDetail').style.display = 'none';
  }
}

// è™•ç†æé ˜
document.getElementById('withdrawForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const points = parseInt(document.getElementById('withdrawPoints').value);
  const bankName = document.getElementById('bankName').value.trim();
  const bankAccount = document.getElementById('bankAccount').value.trim();
  const accountName = document.getElementById('accountName').value.trim();
  const notes = document.getElementById('notes').value.trim();
  
  // é©—è­‰
  if (points < 100) {
    showMessage('âŒ æœ€å°‘æé ˜ 100 é»', 'error');
    return;
  }
  
  if (points > currentPoints) {
    showMessage('â¤ï¸ å…¬ç›Šé»æ•¸ä¸è¶³', 'error');
    return;
  }
  
  if (accountName !== currentUserName) {
    showMessage('âŒ æˆ¶åå¿…é ˆèˆ‡æœƒå“¡å§“åä¸€è‡´', 'error');
    return;
  }
  
  // è¨ˆç®—å¯¦éš›æé ˜é‡‘é¡ï¼ˆ0.7 æ›ç®— - 15 å…ƒæ‰‹çºŒè²»ï¼‰
  const amountBeforeFee = Math.floor(points * 0.7);
  const fee = 15;
  const actualAmount = amountBeforeFee - fee;
  
  // ç¢ºèªå°è©±æ¡†
  const confirmMsg = `ç¢ºèªæé ˜è³‡è¨Šï¼š\n\n` +
                     `æé ˜é»æ•¸ï¼š${points.toLocaleString()} é»\n` +
                     `æ›ç®—é‡‘é¡ï¼šNT$ ${amountBeforeFee.toLocaleString()}\n` +
                     `æ‰‹çºŒè²»ï¼šNT$ ${fee}\n` +
                     `å¯¦éš›åˆ°å¸³ï¼šNT$ ${actualAmount.toLocaleString()}\n\n` +
                     `åŒ¯æ¬¾éŠ€è¡Œï¼š${bankName}\n` +
                     `éŠ€è¡Œå¸³è™Ÿï¼š${bankAccount}\n` +
                     `æˆ¶åï¼š${accountName}\n\n` +
                     `é è¨ˆ 1-3 å€‹å·¥ä½œå¤©å…§åŒ¯æ¬¾\n\n` +
                     `ç¢ºå®šè¦æé ˜å—ï¼Ÿ`;
  
  if (!confirm(confirmMsg)) {
    return;
  }
  
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="btn-icon">â³</span> è™•ç†ä¸­...';
  
  try {
    // ğŸ” ä½¿ç”¨å®‰å…¨çš„ POST æ–¹å¼å‚³é€æ•æ„Ÿè³‡æ–™ï¼ˆéŠ€è¡Œå¸³è™Ÿï¼‰
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        action: 'withdraw',
        lineUserId: currentUserId,
        points: points,
        bankName: bankName,
        bankAccount: bankAccount,
        accountName: accountName,
        notes: notes
      })
    });
    const data = await res.json();
    
    if (data.success) {
      let successMsg = `ğŸ‰ æé ˜ç”³è«‹æˆåŠŸï¼\n\n` +
                       `æé ˜é»æ•¸ï¼š${points.toLocaleString()} é»\n` +
                       `æé ˜é‡‘é¡ï¼šNT$ ${points.toLocaleString()}\n` +
                       `å‰©é¤˜é»æ•¸ï¼š${data.points.toLocaleString()} é»\n\n` +
                       `é è¨ˆ 1-3 å€‹å·¥ä½œå¤©åŒ¯å…¥æ‚¨çš„å¸³æˆ¶`;
      
      if (data.referrerReward && data.referrerReward.success) {
        successMsg += `\n\næ¨è–¦äºº ${data.referrerReward.referrerName} ç²å¾—äº† ${data.referrerReward.reward.toLocaleString()} é»çå‹µï¼`;
      }
      
      showMessage(successMsg, 'success');
      
      // æ¸…ç©ºè¡¨å–®
      document.getElementById('withdrawForm').reset();
      document.getElementById('accountName').value = currentUserName;
      document.getElementById('withdrawDetail').style.display = 'none';
      
      // æ›´æ–°ç•¶å‰é»æ•¸
      currentPoints = data.points;
      document.getElementById('currentPoints').innerHTML = `
        <p class="points-label" style="color: #856404; font-weight: 600;">â¤ï¸ å¯æé ˜å…¬ç›Šé»æ•¸</p>
        <p class="points-value" style="color: #FFB800; font-weight: 800;">${currentPoints.toLocaleString()} <span style="color: #856404; font-size: 20px; font-weight: 600;">é»</span></p>
      `;
      
      // 3 ç§’å¾Œè·³è½‰
      setTimeout(() => {
        window.location.href = 'profile.html';
      }, 3000);
    } else {
      showMessage('âŒ ' + (data.message || 'æé ˜å¤±æ•—'), 'error');
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span class="btn-icon">ğŸ’µ</span> ç¢ºèªæé ˜';
    }
  } catch (error) {
    console.error('æé ˜éŒ¯èª¤:', error);
    showMessage('âŒ ç³»çµ±éŒ¯èª¤: ' + error.message, 'error');
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<span class="btn-icon">ğŸ’µ</span> ç¢ºèªæé ˜';
  }
});

function showMessage(msg, type) {
  const messageDiv = document.getElementById('message');
  messageDiv.textContent = msg;
  messageDiv.className = `message ${type}`;
  messageDiv.style.display = 'block';
  
  // è‡ªå‹•éš±è—è¨Šæ¯
  setTimeout(() => {
    messageDiv.style.display = 'none';
  }, type === 'success' ? 5000 : 3000); // æˆåŠŸ5ç§’ï¼ŒéŒ¯èª¤3ç§’
}

function goBack() {
  window.location.href = 'profile.html';
}

init();
</script>
</body>
</html>

