# 載入不成功 - 診斷檢查清單

## ✅ 步驟 1: 檢查 Google Apps Script

### 1.1 檢查 Sheet ID 是否正確
```javascript
const SHEET_ID = '1EdLfJQzYroQ9WMqVEqcDuMpGwiTPj8gxLaMnGp3umDw';
```

**如何驗證：**
1. 開啟您的 Google Sheets
2. 檢查瀏覽器網址列
3. 確認 `/d/` 和 `/edit` 之間的 ID 是否一致

---

### 1.2 測試 Apps Script 是否正常運作

在 Apps Script 編輯器中執行以下測試：

**測試 1：測試工作表連線**
```javascript
function testConnection() {
  try {
    const ss = SpreadsheetApp.openById('1EdLfJQzYroQ9WMqVEqcDuMpGwiTPj8gxLaMnGp3umDw');
    Logger.log('成功！試算表名稱：' + ss.getName());
    return true;
  } catch (error) {
    Logger.log('失敗！錯誤：' + error.toString());
    return false;
  }
}
```

**如何執行：**
1. 在 Apps Script 編輯器中，點選上方的函數選擇器
2. 選擇 `testConnection`
3. 點選「執行」(▶️)
4. 查看下方的「執行紀錄」

**預期結果：**
- ✅ 成功：顯示「成功！試算表名稱：會員系統點數移轉」
- ❌ 失敗：顯示錯誤訊息（通常是權限問題）

---

**測試 2：初始化工作表**
```javascript
function testInitialize() {
  try {
    // 初始化 Members 工作表
    const membersSheet = getSheet('Members');
    Logger.log('Members 工作表已建立，行數：' + membersSheet.getLastRow());
    
    // 初始化 Transactions 工作表
    const transSheet = getSheet('Transactions');
    Logger.log('Transactions 工作表已建立，行數：' + transSheet.getLastRow());
    
    return true;
  } catch (error) {
    Logger.log('失敗！錯誤：' + error.toString());
    return false;
  }
}
```

**執行後檢查：**
1. 回到 Google Sheets
2. 應該會看到兩個工作表：`Members` 和 `Transactions`
3. 每個工作表都有標題列（藍色或綠色背景）

---

**測試 3：建立測試資料**
```javascript
function testCreateData() {
  try {
    createSampleData();
    Logger.log('測試資料建立成功！');
    return true;
  } catch (error) {
    Logger.log('失敗！錯誤：' + error.toString());
    return false;
  }
}
```

**執行後檢查：**
- 回到 Google Sheets 的 `Members` 工作表
- 應該會看到 3 筆測試會員資料（王小明、李小華、陳大文）

---

## ✅ 步驟 2: 檢查部署設定

### 2.1 確認部署為 Web App

**檢查項目：**
1. 點選 Apps Script 上方的「部署」→「管理部署作業」
2. 檢查是否有「網頁應用程式」類型的部署
3. 檢查設定：
   - ✅ 執行身分：**我**
   - ✅ 具有應用程式存取權的使用者：**所有人**

**如果沒有部署或設定錯誤：**
1. 點選「新增部署作業」
2. 選擇類型：「網頁應用程式」
3. 設定：
   - 執行身分：**我**
   - 具有應用程式存取權的使用者：**所有人**
4. 點選「部署」
5. **複製部署的 URL**（非常重要！）

---

### 2.2 授權應用程式

**第一次部署時需要授權：**

1. 點選「授權存取權」
2. 選擇您的 Google 帳號
3. 會看到「Google 尚未驗證這個應用程式」
   - 點選「進階」
   - 點選「前往 [專案名稱] (不安全)」
4. 點選「允許」授予以下權限：
   - 查看和管理試算表
   - 連線至外部服務

---

### 2.3 測試部署的 URL

**複製部署 URL：**
```
https://script.google.com/macros/s/AKfycby.../exec
```

**在瀏覽器中測試：**
```
https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec?action=check&lineUserId=TEST001
```

**預期結果：**
```json
{
  "registered": false
}
```

**如果看到錯誤：**
- `Authorization needed` → 需要重新授權
- `Script function not found` → 部署設定錯誤
- `404 Not Found` → URL 不正確

---

## ✅ 步驟 3: 檢查前端設定

### 3.1 檢查 HTML 檔案中的設定

您需要在 HTML 檔案中替換以下內容：

**register.html, profile.html, transfer.html:**

❌ **錯誤的設定：**
```javascript
const res = await fetch('https://YOUR_N8N_URL/webhook/register', {
```

✅ **正確的設定：**
```javascript
const res = await fetch('https://script.google.com/macros/s/AKfycby.../exec?action=register', {
```

**注意：**
- URL 應該是 `script.google.com`，不是 `YOUR_N8N_URL`
- 需要加上 `?action=register` 參數
- 使用您實際的 Deployment ID

---

### 3.2 CORS 問題檢查

如果在瀏覽器 Console 看到 CORS 錯誤：

**解決方法：**
1. 確認 Apps Script 已正確部署為 Web App
2. 確認「具有應用程式存取權的使用者」設為「所有人」
3. 重新部署（建立新版本）

---

## ✅ 步驟 4: 檢查 LIFF 設定

### 4.1 檢查 LIFF ID

**在 HTML 檔案中：**
```javascript
await liff.init({ liffId: "YOUR_LIFF_ID" });
```

**替換為實際的 LIFF ID：**
```javascript
await liff.init({ liffId: "2000000001-AbCd1234" });
```

### 4.2 檢查 LIFF Endpoint URL

1. 前往 [LINE Developers Console](https://developers.line.biz/console/)
2. 找到您的 LIFF 應用
3. 確認 Endpoint URL 是否正確（必須是 HTTPS）

---

## 🐛 常見錯誤和解決方法

### 錯誤 1: "Exception: You do not have permission to call SpreadsheetApp.openById"

**原因：** 權限不足

**解決方法：**
1. 重新執行 `testConnection()` 函數
2. 會跳出授權視窗
3. 點選「允許」授權

---

### 錯誤 2: "Exception: Invalid argument: id"

**原因：** SHEET_ID 不正確

**解決方法：**
1. 檢查 SHEET_ID 是否正確複製
2. 確認沒有多餘的空格或引號
3. 確認該 Google Sheets 確實存在

---

### 錯誤 3: "一直顯示載入中..."

**原因：** API 呼叫失敗或前端設定錯誤

**解決方法：**
1. 按 F12 開啟瀏覽器開發者工具
2. 切換到 Console 分頁
3. 重新載入頁面
4. 查看錯誤訊息
5. 將錯誤訊息提供給我

---

### 錯誤 4: "LIFF init failed"

**原因：** LIFF ID 不正確或 Endpoint URL 設定錯誤

**解決方法：**
1. 檢查 LIFF ID 是否正確
2. 確認 Endpoint URL 使用 HTTPS
3. 確認網域已部署且可存取

---

## 📝 完整檢查流程

請依序執行以下步驟：

### ✅ 階段 1: Google Apps Script
- [ ] 1. 執行 `testConnection()` - 測試連線
- [ ] 2. 執行 `testInitialize()` - 初始化工作表
- [ ] 3. 執行 `testCreateData()` - 建立測試資料
- [ ] 4. 確認部署設定正確
- [ ] 5. 測試部署的 URL

### ✅ 階段 2: 前端設定
- [ ] 6. 更新所有 HTML 的 API URL
- [ ] 7. 更新 LIFF ID
- [ ] 8. 確認沒有 `YOUR_N8N_URL` 的殘留

### ✅ 階段 3: 部署和測試
- [ ] 9. 部署前端到 GitHub Pages
- [ ] 10. 更新 LIFF Endpoint URL
- [ ] 11. 在 LINE 中測試開啟 LIFF

---

## 🔍 如何查看詳細錯誤訊息

### 在 Apps Script 中：
1. 執行函數後
2. 點選下方的「執行紀錄」
3. 查看完整的錯誤訊息

### 在瀏覽器中：
1. 按 F12 開啟開發者工具
2. 切換到「Console」分頁
3. 重新載入頁面
4. 查看紅色的錯誤訊息

### 在 LINE 中：
1. 使用 LINE 的 LIFF Inspector
2. 或使用電腦版 LINE 的開發者工具

---

## 📞 需要更多協助？

請提供以下資訊：

1. **錯誤發生在哪個階段？**
   - [ ] Apps Script 執行測試時
   - [ ] 部署 Apps Script 時
   - [ ] 前端頁面載入時
   - [ ] LIFF 初始化時
   - [ ] API 呼叫時

2. **錯誤訊息是什麼？**
   - 完整的錯誤訊息（截圖或文字）

3. **您已經完成哪些步驟？**
   - [ ] 建立 Google Sheets
   - [ ] 部署 Apps Script
   - [ ] 建立 LINE LIFF
   - [ ] 部署前端
   - [ ] 更新 HTML 設定

**請將以上資訊提供給我，我會幫您進一步診斷問題！** 🔧

