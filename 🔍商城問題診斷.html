<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ” å•†åŸå•é¡Œè¨ºæ–·</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Microsoft JhengHei', sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}

.container {
  max-width: 900px;
  margin: 0 auto;
}

.card {
  background: white;
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

h1 {
  color: #667eea;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.btn {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  padding: 14px 28px;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  margin-right: 10px;
  margin-bottom: 10px;
  transition: all 0.3s;
}

.btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.btn-success {
  background: linear-gradient(135deg, #4CAF50, #388E3C);
}

.btn-danger {
  background: linear-gradient(135deg, #f44336, #d32f2f);
}

.result {
  background: #f8f9fa;
  border: 3px solid #e0e0e0;
  border-radius: 12px;
  padding: 20px;
  margin-top: 16px;
  font-family: 'Consolas', 'Courier New', monospace;
  font-size: 14px;
  white-space: pre-wrap;
  word-wrap: break-word;
  max-height: 500px;
  overflow-y: auto;
  line-height: 1.6;
}

.result.success {
  border-color: #4CAF50;
  background: #E8F5E9;
}

.result.error {
  border-color: #f44336;
  background: #FFEBEE;
}

.result.warning {
  border-color: #FF9800;
  background: #FFF3E0;
}

.step {
  background: #E3F2FD;
  border-left: 4px solid #2196F3;
  padding: 16px;
  margin: 16px 0;
  border-radius: 8px;
}

.step h3 {
  color: #1976D2;
  margin-bottom: 12px;
  font-size: 18px;
}

.check-item {
  padding: 12px;
  margin: 8px 0;
  background: white;
  border-radius: 8px;
  border: 2px solid #e0e0e0;
  display: flex;
  align-items: center;
  gap: 12px;
}

.check-item.ok {
  border-color: #4CAF50;
  background: #E8F5E9;
}

.check-item.fail {
  border-color: #f44336;
  background: #FFEBEE;
}

pre {
  background: #2d2d2d;
  color: #f8f8f2;
  padding: 16px;
  border-radius: 8px;
  overflow-x: auto;
  margin: 12px 0;
  font-size: 13px;
}

.info {
  background: #FFF9C4;
  border: 2px solid #FBC02D;
  border-radius: 8px;
  padding: 16px;
  margin: 16px 0;
}
</style>
</head>
<body>

<div class="container">
  <div class="card">
    <h1>ğŸ” å•†åŸå•é¡Œè¨ºæ–·å·¥å…·</h1>
    
    <div class="info">
      <strong>ğŸ“ é€™å€‹å·¥å…·æœƒå¹«æ‚¨æª¢æŸ¥ï¼š</strong><br>
      âœ“ API æ˜¯å¦æ­£å¸¸<br>
      âœ“ å•†å“è³‡æ–™æ˜¯å¦å­˜åœ¨<br>
      âœ“ å·¥ä½œè¡¨è¨­å®šæ˜¯å¦æ­£ç¢º<br>
      âœ“ æä¾›è§£æ±ºæ–¹æ¡ˆ
    </div>
    
    <button class="btn btn-success" onclick="startDiagnosis()">ğŸš€ é–‹å§‹è¨ºæ–·</button>
    <button class="btn" onclick="testAPI()">ğŸ§ª æ¸¬è©¦ API</button>
    <button class="btn btn-danger" onclick="clearAllCache()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰å¿«å–</button>
    
    <div id="diagnosisResult"></div>
  </div>
  
  <div class="card">
    <h2>ğŸ“‹ å¿«é€Ÿæ–°å¢æ¸¬è©¦å•†å“</h2>
    
    <div class="step">
      <h3>æ­¥é©Ÿ 1ï¼šè¤‡è£½æ¬„ä½æ¨™é¡Œ</h3>
      <p>é»æ“Šä¸‹æ–¹æ–‡å­—æ¡†æœƒè‡ªå‹•å…¨é¸ï¼Œç„¶å¾ŒæŒ‰ Ctrl+C è¤‡è£½ï¼š</p>
      <textarea readonly onclick="this.select()" style="width: 100%; height: 60px; padding: 10px; font-family: monospace; font-size: 12px; margin-top: 8px;">productId	productName	description	imageUrl	points	originalPrice	stock	category	sellerId	sellerName	sellerPhone	sellerReferralCode	isActive	soldCount	tags	createdAt	updatedAt</textarea>
      <p style="margin-top: 8px; color: #666; font-size: 13px;">è²¼åˆ° Google Sheetsã€Œå•†åŸå•†å“ã€å·¥ä½œè¡¨çš„ç¬¬1è¡Œï¼ˆA1æ ¼é–‹å§‹ï¼‰</p>
    </div>
    
    <div class="step">
      <h3>æ­¥é©Ÿ 2ï¼šè¤‡è£½å•†å“è³‡æ–™</h3>
      <p>é»æ“Šä¸‹æ–¹æ–‡å­—æ¡†æœƒè‡ªå‹•å…¨é¸ï¼Œç„¶å¾ŒæŒ‰ Ctrl+C è¤‡è£½ï¼š</p>
      <textarea readonly onclick="this.select()" style="width: 100%; height: 80px; padding: 10px; font-family: monospace; font-size: 12px; margin-top: 8px;">X7Z5P3	æ‹æ–°è	ç²å¾—æ‹æ–°èè™›æ“¬å•†å“åºè™Ÿ	https://i.postimg.cc/3R5j7t6k/Pi-News-GIF2.gif	3600	3600	-1	virtual			USER001	TRUE	0	è™›æ“¬å•†å“,åºè™Ÿ	2025-10-18	2025-10-18</textarea>
      <p style="margin-top: 8px; color: #666; font-size: 13px;">è²¼åˆ° Google Sheetsã€Œå•†åŸå•†å“ã€å·¥ä½œè¡¨çš„ç¬¬2è¡Œï¼ˆA2æ ¼é–‹å§‹ï¼‰</p>
    </div>
    
    <button class="btn btn-success" onclick="copyHeaders()">ğŸ“‹ ä¸€éµè¤‡è£½æ¬„ä½æ¨™é¡Œ</button>
    <button class="btn btn-success" onclick="copyProduct()">ğŸ“‹ ä¸€éµè¤‡è£½å•†å“è³‡æ–™</button>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzMUwqroi_W_5m7rcjVs-U-o6tEo9W0327BeMmU38Rxinmycd5d1HyyF3BnugGvNF6r/exec';

async function startDiagnosis() {
  const resultDiv = document.getElementById('diagnosisResult');
  resultDiv.innerHTML = '<div class="result">ğŸ” è¨ºæ–·ä¸­ï¼Œè«‹ç¨å€™...</div>';
  
  let report = 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
  report += 'ğŸ” å•†åŸå•é¡Œè¨ºæ–·å ±å‘Š\n';
  report += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
  
  let hasError = false;
  
  // æª¢æŸ¥ 1ï¼šAPI é€£ç·š
  report += 'ã€æª¢æŸ¥ 1ã€‘API é€£ç·šæ¸¬è©¦\n';
  report += '-----------------------------------\n';
  
  try {
    const testUrl = `${API_URL}?action=test`;
    const testRes = await fetch(testUrl);
    
    if (testRes.ok) {
      report += 'âœ… API é€£ç·šæ­£å¸¸\n';
      report += `   URL: ${API_URL}\n\n`;
    } else {
      report += `âŒ API å›æ‡‰ç•°å¸¸ (${testRes.status})\n\n`;
      hasError = true;
    }
  } catch (error) {
    report += `âŒ API é€£ç·šå¤±æ•—\n`;
    report += `   éŒ¯èª¤: ${error.message}\n\n`;
    hasError = true;
  }
  
  // æª¢æŸ¥ 2ï¼šå•†å“ API
  report += 'ã€æª¢æŸ¥ 2ã€‘å•†å“ API æ¸¬è©¦\n';
  report += '-----------------------------------\n';
  
  try {
    const url = `${API_URL}?action=mall-products`;
    const res = await fetch(url);
    const data = await res.json();
    
    report += `è«‹æ±‚ URL: ${url}\n\n`;
    
    if (data.success) {
      const products = data.products || [];
      
      if (products.length > 0) {
        report += `âœ… æˆåŠŸè¼‰å…¥ ${products.length} å€‹å•†å“\n\n`;
        report += 'å•†å“åˆ—è¡¨ï¼š\n';
        products.forEach((p, i) => {
          report += `\n${i + 1}. ${p.productName || 'æœªå‘½å'}\n`;
          report += `   ID: ${p.productId}\n`;
          report += `   é»æ•¸: ${p.points}\n`;
          report += `   ç‹€æ…‹: ${p.isActive ? 'âœ… ä¸Šæ¶ä¸­' : 'âŒ å·²ä¸‹æ¶'}\n`;
          report += `   åº«å­˜: ${p.stock === -1 ? 'ä¸é™é‡' : p.stock}\n`;
        });
        report += '\n';
      } else {
        report += 'âš ï¸ API æ­£å¸¸ï¼Œä½†å•†å“åˆ—è¡¨æ˜¯ç©ºçš„ï¼\n\n';
        report += 'å¯èƒ½åŸå› ï¼š\n';
        report += '1. ã€Œå•†åŸå•†å“ã€å·¥ä½œè¡¨æ²’æœ‰è³‡æ–™\n';
        report += '2. isActive æ¬„ä½ä¸æ˜¯ TRUE\n';
        report += '3. è³‡æ–™æ ¼å¼ä¸æ­£ç¢º\n\n';
        report += 'ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š\n';
        report += 'è«‹ä½¿ç”¨ä¸‹æ–¹çš„ã€Œè¤‡è£½å•†å“è³‡æ–™ã€åŠŸèƒ½\n';
        report += 'å°‡è³‡æ–™è²¼åˆ° Google Sheets çš„ã€Œå•†åŸå•†å“ã€å·¥ä½œè¡¨\n\n';
        hasError = true;
      }
    } else {
      report += `âŒ API å›æ‡‰å¤±æ•—\n`;
      report += `   è¨Šæ¯: ${data.message || 'æœªçŸ¥éŒ¯èª¤'}\n\n`;
      report += 'å¯èƒ½åŸå› ï¼š\n';
      report += '1. ã€Œå•†åŸå•†å“ã€å·¥ä½œè¡¨ä¸å­˜åœ¨\n';
      report += '2. å·¥ä½œè¡¨åç¨±æ‹¼å¯«éŒ¯èª¤ï¼ˆè¦ç”¨ä¸­æ–‡ï¼šå•†åŸå•†å“ï¼‰\n';
      report += '3. Apps Script æ²’æœ‰è™•ç† mall-products action\n\n';
      hasError = true;
    }
    
    report += 'å®Œæ•´ API å›æ‡‰ï¼š\n';
    report += JSON.stringify(data, null, 2) + '\n\n';
    
  } catch (error) {
    report += `âŒ è«‹æ±‚å¤±æ•—\n`;
    report += `   éŒ¯èª¤: ${error.message}\n\n`;
    hasError = true;
  }
  
  // æª¢æŸ¥ 3ï¼šå¿«å–ç‹€æ…‹
  report += 'ã€æª¢æŸ¥ 3ã€‘å¿«å–ç‹€æ…‹\n';
  report += '-----------------------------------\n';
  
  const cacheKey = 'mall_products';
  const cached = localStorage.getItem(cacheKey);
  
  if (cached) {
    try {
      const cacheData = JSON.parse(cached);
      report += `âš ï¸ ç™¼ç¾å•†å“å¿«å–\n`;
      report += `   å»ºç«‹æ™‚é–“: ${new Date(cacheData.expiry - 3*60*1000).toLocaleString()}\n`;
      report += `   éæœŸæ™‚é–“: ${new Date(cacheData.expiry).toLocaleString()}\n\n`;
      report += `ğŸ’¡ å»ºè­°ï¼šæ¸…é™¤å¿«å–å¾Œé‡æ–°æ¸¬è©¦\n\n`;
    } catch (e) {
      report += `âš ï¸ å¿«å–è³‡æ–™æå£\n\n`;
    }
  } else {
    report += `âœ… ç„¡èˆŠå¿«å–\n\n`;
  }
  
  // ç¸½çµ
  report += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
  report += 'ğŸ“Š è¨ºæ–·ç¸½çµ\n';
  report += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
  
  if (!hasError) {
    report += 'âœ… æ‰€æœ‰æª¢æŸ¥éƒ½é€šéï¼\n';
    report += '   å•†åŸæ‡‰è©²å¯ä»¥æ­£å¸¸é¡¯ç¤ºå•†å“\n\n';
    report += 'ğŸ’¡ å¦‚æœé‚„æ˜¯çœ‹ä¸åˆ°ï¼š\n';
    report += '   1. æ¸…é™¤ LINE å¿«å–\n';
    report += '   2. é‡æ–°é–‹å•Ÿå•†åŸé é¢\n';
    resultDiv.innerHTML = `<div class="result success">${report}</div>`;
  } else {
    report += 'âš ï¸ ç™¼ç¾å•é¡Œï¼\n';
    report += '   è«‹åƒè€ƒä¸Šæ–¹çš„è§£æ±ºæ–¹æ³•\n';
    resultDiv.innerHTML = `<div class="result error">${report}</div>`;
  }
}

async function testAPI() {
  const resultDiv = document.getElementById('diagnosisResult');
  resultDiv.innerHTML = '<div class="result">ğŸ§ª æ¸¬è©¦ä¸­...</div>';
  
  try {
    const url = `${API_URL}?action=mall-products`;
    console.log('æ¸¬è©¦ URL:', url);
    
    const res = await fetch(url);
    const data = await res.json();
    
    let report = 'ğŸ§ª API æ¸¬è©¦çµæœ\n\n';
    report += `è«‹æ±‚ URL:\n${url}\n\n`;
    report += `å›æ‡‰ç‹€æ…‹: ${res.status} ${res.statusText}\n\n`;
    report += `å®Œæ•´å›æ‡‰ï¼š\n`;
    report += JSON.stringify(data, null, 2);
    
    if (data.success && data.products && data.products.length > 0) {
      resultDiv.innerHTML = `<div class="result success">${report}</div>`;
    } else if (data.success && (!data.products || data.products.length === 0)) {
      resultDiv.innerHTML = `<div class="result warning">${report}\n\nâš ï¸ API æ­£å¸¸ä½†æ²’æœ‰å•†å“è³‡æ–™ï¼\nè«‹ä½¿ç”¨ä¸‹æ–¹åŠŸèƒ½æ–°å¢å•†å“ã€‚</div>`;
    } else {
      resultDiv.innerHTML = `<div class="result error">${report}</div>`;
    }
  } catch (error) {
    resultDiv.innerHTML = `<div class="result error">âŒ æ¸¬è©¦å¤±æ•—\n\néŒ¯èª¤: ${error.message}\n\nå¯èƒ½åŸå› ï¼š\n1. API URL ä¸æ­£ç¢º\n2. CORS å•é¡Œ\n3. Apps Script æœªæ­£ç¢ºéƒ¨ç½²</div>`;
  }
}

function clearAllCache() {
  const keys = Object.keys(localStorage);
  const removed = [];
  
  keys.forEach(key => {
    if (key.includes('mall') || key.includes('product')) {
      localStorage.removeItem(key);
      removed.push(key);
    }
  });
  
  if (removed.length > 0) {
    alert(`âœ… å·²æ¸…é™¤ ${removed.length} å€‹å¿«å–é …ç›®ï¼š\n\n${removed.join('\n')}\n\nè«‹é‡æ–°è¼‰å…¥é é¢ï¼`);
    location.reload();
  } else {
    alert('âœ… æ²’æœ‰å•†åŸç›¸é—œå¿«å–');
  }
}

function copyHeaders() {
  const text = 'productId\tproductName\tdescription\timageUrl\tpoints\toriginalPrice\tstock\tcategory\tsellerId\tsellerName\tsellerPhone\tsellerReferralCode\tisActive\tsoldCount\ttags\tcreatedAt\tupdatedAt';
  
  navigator.clipboard.writeText(text).then(() => {
    alert('âœ… æ¬„ä½æ¨™é¡Œå·²è¤‡è£½ï¼\n\nè«‹åˆ° Google Sheetsã€Œå•†åŸå•†å“ã€å·¥ä½œè¡¨\né»é¸ A1 æ ¼ï¼ŒæŒ‰ Ctrl+V è²¼ä¸Š');
  }).catch(() => {
    prompt('è«‹æ‰‹å‹•è¤‡è£½ï¼ˆCtrl+Cï¼‰ï¼š', text);
  });
}

function copyProduct() {
  const text = 'X7Z5P3\tæ‹æ–°è\tç²å¾—æ‹æ–°èè™›æ“¬å•†å“åºè™Ÿ\thttps://i.postimg.cc/3R5j7t6k/Pi-News-GIF2.gif\t3600\t3600\t-1\tvirtual\t\t\t\tUSER001\tTRUE\t0\tè™›æ“¬å•†å“,åºè™Ÿ\t2025-10-18\t2025-10-18';
  
  navigator.clipboard.writeText(text).then(() => {
    alert('âœ… å•†å“è³‡æ–™å·²è¤‡è£½ï¼\n\nè«‹åˆ° Google Sheetsã€Œå•†åŸå•†å“ã€å·¥ä½œè¡¨\né»é¸ A2 æ ¼ï¼ŒæŒ‰ Ctrl+V è²¼ä¸Š');
  }).catch(() => {
    prompt('è«‹æ‰‹å‹•è¤‡è£½ï¼ˆCtrl+Cï¼‰ï¼š', text);
  });
}

// è‡ªå‹•æª¢æ¸¬
window.addEventListener('load', () => {
  console.log('ğŸ” å•†åŸè¨ºæ–·å·¥å…·å·²è¼‰å…¥');
  console.log('API URL:', API_URL);
});
</script>

</body>
</html>

