<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸Šæ¶å•†å“</title>
<link rel="stylesheet" href="./assets/style.css">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="card-header">
      <h1>ğŸª ä¸Šæ¶æˆ‘çš„å•†å“</h1>
      <p style="color: #667eea; font-weight: 600;">æ¯ä½æœƒå“¡é™ä¸Šæ¶ 1 å€‹å•†å“</p>
    </div>
    
    <!-- å•†å“è¡¨å–® -->
    <form id="productForm" style="display: none;">
      <div class="form-group">
        <label>ğŸ“¦ å•†å“åç¨± *</label>
        <input type="text" id="productName" class="form-control" 
               placeholder="ä¾‹ï¼šiPhone 15 Pro Max" required maxlength="100">
      </div>
      
      <div class="form-group">
        <label>ğŸ“ å•†å“æè¿° *</label>
        <textarea id="productDesc" class="form-control" rows="4" 
                  placeholder="è«‹è©³ç´°æè¿°æ‚¨çš„å•†å“ï¼ˆè¦æ ¼ã€ç‹€æ³ã€è³¼è²·æ™‚é–“ç­‰ï¼‰" 
                  required maxlength="500"></textarea>
        <small style="color: #999;">æœ€å¤š 500 å­—</small>
      </div>
      
      <div class="form-group">
        <label>ğŸ–¼ï¸ å•†å“åœ–ç‰‡ç¶²å€ *</label>
        <input type="url" id="productImage" class="form-control" 
               placeholder="https://example.com/image.jpg" required>
        <small style="color: #999;">è«‹ä½¿ç”¨ https:// é–‹é ­çš„åœ–ç‰‡ç¶²å€</small>
      </div>
      
      <div class="form-group">
        <label>ğŸ’° å”®åƒ¹ï¼ˆé»æ•¸ï¼‰*</label>
        <input type="number" id="productPoints" class="form-control" 
               placeholder="100" required min="1" max="100000">
        <small style="color: #999;">è²·å®¶éœ€æ”¯ä»˜çš„é»æ•¸</small>
      </div>
      
      <div class="form-group">
        <label>ğŸ’µ åƒè€ƒåŸåƒ¹ï¼ˆå…ƒï¼‰</label>
        <input type="number" id="originalPrice" class="form-control" 
               placeholder="1000" min="0">
        <small style="color: #999;">é¸å¡«ï¼Œåƒ…ä¾›åƒè€ƒ</small>
      </div>
      
      <div class="form-group">
        <label>ğŸ“‚ å•†å“åˆ†é¡ *</label>
        <select id="productCategory" class="form-control" required>
          <option value="">è«‹é¸æ“‡åˆ†é¡</option>
          <option value="physical">å¯¦é«”å•†å“</option>
          <option value="virtual">è™›æ“¬å•†å“</option>
          <option value="charity">å…¬ç›Šæè´ˆ</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>ğŸ“¦ åº«å­˜æ•¸é‡ *</label>
        <input type="number" id="productStock" class="form-control" 
               placeholder="1" required min="1" max="100" value="1">
        <small style="color: #999;">è¼¸å…¥ -1 è¡¨ç¤ºä¸é™é‡</small>
      </div>
      
      <div class="form-group">
        <label>ğŸ·ï¸ å•†å“æ¨™ç±¤</label>
        <input type="text" id="productTags" class="form-control" 
               placeholder="ä¾‹ï¼šå…¨æ–°ã€æœªæ‹†å°ã€ä¿å›ºä¸­" maxlength="100">
        <small style="color: #999;">å¤šå€‹æ¨™ç±¤ç”¨é€—è™Ÿåˆ†éš”</small>
      </div>
      
      <!-- é‡è¦æç¤º -->
      <div style="background: linear-gradient(135deg, #FFF3CD, #FFE69C); border: 2px solid #FFB800; border-radius: 12px; padding: 20px; margin: 20px 0;">
        <h3 style="margin: 0 0 10px 0; color: #856404;">ğŸ“¢ é‡è¦èªªæ˜</h3>
        <ul style="margin: 0; padding-left: 20px; color: #856404;">
          <li>å•†å“ä¸Šæ¶å¾Œæœƒé¡¯ç¤ºæ‚¨çš„å§“åå’Œé›»è©±</li>
          <li>è²·å®¶è³¼è²·æ™‚ï¼Œé»æ•¸æœƒç›´æ¥è½‰åˆ°æ‚¨çš„å¸³æˆ¶</li>
          <li>è«‹ç¢ºä¿æ‚¨èƒ½æä¾›å•†å“çµ¦è²·å®¶</li>
          <li>æ¯ä½æœƒå“¡é™ä¸Šæ¶ 1 å€‹å•†å“</li>
          <li>å•†å“ä¸Šæ¶å¾Œéœ€è¦ç®¡ç†å“¡å¯©æ ¸</li>
        </ul>
      </div>
      
      <button type="submit" class="btn btn-primary btn-large">
        <span class="btn-icon">âœ…</span>
        æäº¤ä¸Šæ¶ç”³è«‹
      </button>
      
      <button type="button" class="btn btn-back" onclick="goBack()">
        â† è¿”å›æœƒå“¡ä¸­å¿ƒ
      </button>
    </form>
    
    <!-- å·²ä¸Šæ¶å•†å“é¡¯ç¤º -->
    <div id="existingProduct" style="display: none;">
      <div style="background: linear-gradient(135deg, #E8EAF6, #C5CAE9); border: 2px solid #667eea; border-radius: 12px; padding: 20px; margin: 20px 0;">
        <h3 style="margin: 0 0 15px 0; color: #667eea;">ğŸ“¦ æ‚¨çš„å•†å“</h3>
        <div id="productInfo"></div>
      </div>
      
      <button class="btn btn-secondary" onclick="editProduct()">
        <span class="btn-icon">âœï¸</span>
        ç·¨è¼¯å•†å“
      </button>
      
      <button class="btn btn-back" onclick="goBack()">
        â† è¿”å›æœƒå“¡ä¸­å¿ƒ
      </button>
    </div>
    
    <!-- è¼‰å…¥ä¸­ -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p style="margin-top: 15px; color: #666;">è¼‰å…¥ä¸­...</p>
    </div>
    
    <div id="message" class="message" style="display:none;"></div>
  </div>
</div>

<style>
.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  font-size: 15px;
  font-weight: 600;
  color: #333;
  margin-bottom: 8px;
}

.form-control {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 15px;
  transition: all 0.3s ease;
  box-sizing: border-box;
}

.form-control:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

textarea.form-control {
  resize: vertical;
  font-family: inherit;
}

select.form-control {
  cursor: pointer;
}

small {
  display: block;
  margin-top: 5px;
  font-size: 13px;
}

.product-preview {
  background: white;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
}

.product-preview img {
  width: 100%;
  max-width: 300px;
  border-radius: 8px;
  margin: 10px 0;
}

.status-badge {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 16px;
  font-size: 13px;
  font-weight: 600;
  margin: 10px 0;
}

.status-badge.pending {
  background: #fff3cd;
  color: #856404;
}

.status-badge.active {
  background: #d1e7dd;
  color: #0f5132;
}

.status-badge.rejected {
  background: #f8d7da;
  color: #721c24;
}
</style>

<script src="./assets/auth.js"></script>
<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzMUwqroi_W_5m7rcjVs-U-o6tEo9W0327BeMmU38Rxinmycd5d1HyyF3BnugGvNF6r/exec';

let currentUserId = '';
let currentUser = null;
let existingProduct = null;

async function initLiff() {
  try {
    // ä½¿ç”¨èªè­‰å·¥å…·åˆå§‹åŒ–
    const authResult = await AUTH.init();
    
    if (!authResult.success) {
      return;
    }
    
    currentUserId = authResult.user.userId;
    
    // ç²å–æœƒå“¡è³‡æ–™
    const res = await fetch(`${API_URL}?action=profile&lineUserId=${currentUserId}`);
    const data = await res.json();
    
    // ğŸ”§ æª¢æŸ¥æœƒå“¡æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨å‰‡è·³è½‰åˆ°é¦–é è¨»å†Š
    if (!data || !data.success || data.success === false) {
      console.log('âŒ æœƒå“¡ä¸å­˜åœ¨ï¼Œè·³è½‰åˆ°é¦–é è¨»å†Š');
      alert('æ‚¨é‚„ä¸æ˜¯æœƒå“¡ï¼Œè«‹å…ˆè¨»å†Šï¼\n\nå°‡ç‚ºæ‚¨è·³è½‰åˆ°è¨»å†Šé é¢...');
      window.location.href = 'index.html';
      return;
    }
    
    if (data.success) {
      currentUser = data;
      
      // æª¢æŸ¥æ˜¯å¦å·²ä¸Šæ¶å•†å“
      await checkExistingProduct();
    } else {
      showMessage('âŒ ç„¡æ³•ç²å–æœƒå“¡è³‡æ–™', 'error');
    }
    
    document.getElementById('loading').style.display = 'none';
    
  } catch (error) {
    console.error('LIFF åˆå§‹åŒ–éŒ¯èª¤:', error);
    showMessage('âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
    document.getElementById('loading').style.display = 'none';
  }
}

// æª¢æŸ¥æ˜¯å¦å·²ä¸Šæ¶å•†å“
async function checkExistingProduct() {
  try {
    const res = await fetch(`${API_URL}?action=my-product&lineUserId=${currentUserId}`);
    const data = await res.json();
    
    if (data.success && data.product) {
      // å·²æœ‰å•†å“
      existingProduct = data.product;
      displayExistingProduct(data.product);
    } else {
      // å°šæœªä¸Šæ¶ï¼Œé¡¯ç¤ºè¡¨å–®
      document.getElementById('productForm').style.display = 'block';
    }
  } catch (error) {
    console.error('æª¢æŸ¥å•†å“éŒ¯èª¤:', error);
    // å‡ºéŒ¯æ™‚é¡¯ç¤ºè¡¨å–®
    document.getElementById('productForm').style.display = 'block';
  }
}

// é¡¯ç¤ºå·²ä¸Šæ¶çš„å•†å“
function displayExistingProduct(product) {
  const container = document.getElementById('productInfo');
  
  let statusBadge = '';
  let statusText = '';
  if (product.isActive) {
    statusBadge = '<span class="status-badge active">âœ… å·²ä¸Šæ¶</span>';
    statusText = 'å•†å“å·²åœ¨å•†åŸé¡¯ç¤º';
  } else {
    statusBadge = '<span class="status-badge pending">â³ å¯©æ ¸ä¸­</span>';
    statusText = 'ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸';
  }
  
  container.innerHTML = `
    <div class="product-preview">
      <img src="${product.imageUrl}" alt="${product.productName}" onerror="this.src='https://via.placeholder.com/300x200?text=å•†å“åœ–ç‰‡'">
      
      <h3 style="margin: 10px 0;">${product.productName}</h3>
      <p style="color: #666; margin: 10px 0;">${product.description}</p>
      
      <div style="margin: 15px 0;">
        <div style="font-size: 24px; font-weight: 800; color: #FFB800;">
          ${product.points} <span style="font-size: 14px; color: #856404;">é»</span>
        </div>
        ${product.originalPrice > 0 ? `<div style="font-size: 13px; color: #999; text-decoration: line-through;">åŸåƒ¹ NT$ ${product.originalPrice}</div>` : ''}
      </div>
      
      <div style="margin: 10px 0;">
        <strong>åˆ†é¡ï¼š</strong>
        <span>${product.category === 'physical' ? 'å¯¦é«”å•†å“' : product.category === 'virtual' ? 'è™›æ“¬å•†å“' : 'å…¬ç›Šæè´ˆ'}</span>
      </div>
      
      <div style="margin: 10px 0;">
        <strong>åº«å­˜ï¼š</strong>
        <span>${product.stock === -1 ? 'ä¸é™é‡' : product.stock + ' ä»¶'}</span>
      </div>
      
      ${product.tags ? `<div style="margin: 10px 0;"><strong>æ¨™ç±¤ï¼š</strong> ${product.tags}</div>` : ''}
      
      <div style="margin: 15px 0;">
        ${statusBadge}
        <p style="color: #666; margin-top: 5px;">${statusText}</p>
      </div>
      
      <div style="margin: 15px 0; font-size: 13px; color: #999;">
        <div>å·²å”®ï¼š${product.soldCount || 0} ä»¶</div>
        <div>ä¸Šæ¶æ™‚é–“ï¼š${new Date(product.createdAt).toLocaleString('zh-TW')}</div>
      </div>
    </div>
  `;
  
  document.getElementById('existingProduct').style.display = 'block';
}

// ç·¨è¼¯å•†å“ï¼ˆé‡æ–°å¡«å¯«è¡¨å–®ï¼‰
function editProduct() {
  if (!existingProduct) return;
  
  // å¡«å…¥ç¾æœ‰è³‡æ–™
  document.getElementById('productName').value = existingProduct.productName || '';
  document.getElementById('productDesc').value = existingProduct.description || '';
  document.getElementById('productImage').value = existingProduct.imageUrl || '';
  document.getElementById('productPoints').value = existingProduct.points || '';
  document.getElementById('originalPrice').value = existingProduct.originalPrice || '';
  document.getElementById('productCategory').value = existingProduct.category || '';
  document.getElementById('productStock').value = existingProduct.stock || 1;
  document.getElementById('productTags').value = existingProduct.tags || '';
  
  // åˆ‡æ›é¡¯ç¤º
  document.getElementById('existingProduct').style.display = 'none';
  document.getElementById('productForm').style.display = 'block';
}

// æäº¤è¡¨å–®
document.getElementById('productForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  // æ”¶é›†è¡¨å–®è³‡æ–™
  const productData = {
    productName: document.getElementById('productName').value.trim(),
    description: document.getElementById('productDesc').value.trim(),
    imageUrl: document.getElementById('productImage').value.trim(),
    points: parseInt(document.getElementById('productPoints').value),
    originalPrice: parseInt(document.getElementById('originalPrice').value) || 0,
    category: document.getElementById('productCategory').value,
    stock: parseInt(document.getElementById('productStock').value),
    tags: document.getElementById('productTags').value.trim()
  };
  
  // é©—è­‰
  if (!productData.productName || productData.productName.length < 2) {
    showMessage('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„å•†å“åç¨±ï¼ˆè‡³å°‘ 2 å€‹å­—ï¼‰', 'error');
    return;
  }
  
  if (!productData.description || productData.description.length < 10) {
    showMessage('âŒ å•†å“æè¿°å¤ªçŸ­ï¼Œè«‹è©³ç´°æè¿°ï¼ˆè‡³å°‘ 10 å€‹å­—ï¼‰', 'error');
    return;
  }
  
  if (!productData.imageUrl || !productData.imageUrl.startsWith('http')) {
    showMessage('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„åœ–ç‰‡ç¶²å€', 'error');
    return;
  }
  
  if (productData.points < 1 || productData.points > 100000) {
    showMessage('âŒ å”®åƒ¹å¿…é ˆåœ¨ 1-100000 é»ä¹‹é–“', 'error');
    return;
  }
  
  if (!productData.category) {
    showMessage('âŒ è«‹é¸æ“‡å•†å“åˆ†é¡', 'error');
    return;
  }
  
  if (productData.stock < -1 || productData.stock === 0) {
    showMessage('âŒ åº«å­˜æ•¸é‡ç„¡æ•ˆï¼ˆè¼¸å…¥ -1 è¡¨ç¤ºä¸é™é‡ï¼Œæˆ–è¼¸å…¥æ­£æ•´æ•¸ï¼‰', 'error');
    return;
  }
  
  // ç¢ºèªæäº¤
  const confirmMsg = existingProduct 
    ? 'ç¢ºèªè¦æ›´æ–°å•†å“è³‡è¨Šå—ï¼Ÿ\næ›´æ–°å¾Œéœ€è¦é‡æ–°å¯©æ ¸ã€‚'
    : 'ç¢ºèªè¦ä¸Šæ¶é€™å€‹å•†å“å—ï¼Ÿ\nä¸Šæ¶å¾Œéœ€è¦ç®¡ç†å“¡å¯©æ ¸æ‰æœƒåœ¨å•†åŸé¡¯ç¤ºã€‚';
  
  if (!confirm(confirmMsg)) {
    return;
  }
  
  // æäº¤
  try {
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="btn-icon">â³</span> æäº¤ä¸­...';
    
    const params = new URLSearchParams({
      action: existingProduct ? 'update-product' : 'upload-product',
      lineUserId: currentUserId,
      ...productData
    });
    
    const res = await fetch(`${API_URL}?${params.toString()}`);
    const data = await res.json();
    
    if (data.success) {
      showMessage('ğŸ‰ ' + (existingProduct ? 'å•†å“æ›´æ–°æˆåŠŸï¼' : 'å•†å“ä¸Šæ¶æˆåŠŸï¼') + '\nç­‰å¾…ç®¡ç†å“¡å¯©æ ¸å¾Œå³å¯åœ¨å•†åŸé¡¯ç¤º', 'success');
      
      setTimeout(() => {
        location.reload();
      }, 2000);
    } else {
      showMessage('âŒ ' + (data.message || 'æäº¤å¤±æ•—'), 'error');
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span class="btn-icon">âœ…</span> ' + (existingProduct ? 'æ›´æ–°å•†å“' : 'æäº¤ä¸Šæ¶ç”³è«‹');
    }
  } catch (error) {
    console.error('æäº¤éŒ¯èª¤:', error);
    showMessage('âŒ ç³»çµ±éŒ¯èª¤: ' + error.message, 'error');
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<span class="btn-icon">âœ…</span> ' + (existingProduct ? 'æ›´æ–°å•†å“' : 'æäº¤ä¸Šæ¶ç”³è«‹');
  }
});

function showMessage(msg, type) {
  const messageDiv = document.getElementById('message');
  messageDiv.textContent = msg;
  messageDiv.className = `message ${type}`;
  messageDiv.style.display = 'block';
  
  if (type === 'success') {
    setTimeout(() => {
      messageDiv.style.display = 'none';
    }, 5000);
  }
}

function goBack() {
  window.location.href = 'profile.html';
}

initLiff();
</script>
</body>
</html>

