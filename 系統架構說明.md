# 會員註冊系統 - 系統架構說明

## 🏗️ 整體架構圖

```
┌─────────────────────────────────────────────────────────────────────┐
│                          LINE Platform                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ LIFF: 註冊   │  │ LIFF: 會員   │  │ LIFF: 轉點   │              │
│  │ 2000000001   │  │ 2000000002   │  │ 2000000003   │              │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │
└─────────┼──────────────────┼──────────────────┼──────────────────────┘
          │                  │                  │
          └──────────────────┼──────────────────┘
                             │
                    ┌────────▼────────┐
                    │   LINE LIFF SDK  │
                    │   (前端認證)      │
                    └────────┬────────┘
                             │
    ┌────────────────────────┼────────────────────────┐
    │                        │                        │
    │           前端靜態頁面 (GitHub Pages)            │
    │                                                 │
    │  ┌─────────────┐  ┌─────────────┐             │
    │  │ index.html  │  │ assets/     │             │
    │  │             │  │ style.css   │             │
    │  └─────────────┘  └─────────────┘             │
    │                                                 │
    │  ┌──────────────┐  ┌──────────────┐           │
    │  │register.html │  │ profile.html │           │
    │  │註冊頁面      │  │ 會員中心     │           │
    │  └──────┬───────┘  └──────┬───────┘           │
    │         │                  │                    │
    │  ┌──────┴───────┐  ┌──────┴───────┐           │
    │  │transfer.html │  │ config.js    │           │
    │  │轉點頁面      │  │ (選用)       │           │
    │  └──────────────┘  └──────────────┘           │
    │                                                 │
    └─────────────────────┬───────────────────────────┘
                          │ HTTPS Fetch API
                          │
            ┌─────────────▼─────────────┐
            │                            │
            │  Google Apps Script        │
            │  (Web App - Public API)    │
            │                            │
            │  ┌──────────────────────┐  │
            │  │ doGet()              │  │
            │  │ - check             │  │
            │  │ - profile           │  │
            │  │ - check-user        │  │
            │  │ - transactions      │  │
            │  └──────────────────────┘  │
            │                            │
            │  ┌──────────────────────┐  │
            │  │ doPost()             │  │
            │  │ - register          │  │
            │  │ - transfer          │  │
            │  │ - update-profile    │  │
            │  │ - adjust-points     │  │
            │  └──────────────────────┘  │
            │                            │
            │  ┌──────────────────────┐  │
            │  │ Business Logic       │  │
            │  │ - 註冊驗證          │  │
            │  │ - 點數計算          │  │
            │  │ - 交易記錄          │  │
            │  └──────────────────────┘  │
            │                            │
            └────────────┬───────────────┘
                         │ Spreadsheet API
                         │
         ┌───────────────▼───────────────┐
         │                                │
         │    Google Sheets (資料庫)       │
         │                                │
         │  ┌──────────────────────────┐  │
         │  │  Members 工作表          │  │
         │  │  ┌────────────────────┐  │  │
         │  │  │ lineUserId (PK)   │  │  │
         │  │  │ name              │  │  │
         │  │  │ phone (Unique)    │  │  │
         │  │  │ email             │  │  │
         │  │  │ birthday          │  │  │
         │  │  │ lineName          │  │  │
         │  │  │ linePicture       │  │  │
         │  │  │ points            │  │  │
         │  │  │ createdAt         │  │  │
         │  │  │ updatedAt         │  │  │
         │  │  └────────────────────┘  │  │
         │  └──────────────────────────┘  │
         │                                │
         │  ┌──────────────────────────┐  │
         │  │  Transactions 工作表     │  │
         │  │  ┌────────────────────┐  │  │
         │  │  │ id (UUID)         │  │  │
         │  │  │ type              │  │  │
         │  │  │ senderUserId      │  │  │
         │  │  │ receiverUserId    │  │  │
         │  │  │ senderName        │  │  │
         │  │  │ receiverName      │  │  │
         │  │  │ points            │  │  │
         │  │  │ message           │  │  │
         │  │  │ createdAt         │  │  │
         │  │  └────────────────────┘  │  │
         │  └──────────────────────────┘  │
         │                                │
         └────────────────────────────────┘
```

---

## 🔄 資料流程

### 1. 會員註冊流程

```
┌──────────┐      ┌──────────┐      ┌──────────┐      ┌──────────┐
│ LINE App │─────▶│ LIFF SDK │─────▶│ 前端頁面 │─────▶│ Apps     │
│          │      │ 認證     │      │ register │      │ Script   │
└──────────┘      └──────────┘      └──────────┘      └────┬─────┘
                                                            │
                                                            ▼
1. 使用者點擊註冊 LIFF                              檢查是否已註冊
2. LIFF SDK 取得 LINE User ID                       檢查手機號碼重複
3. 自動填入 LINE 顯示名稱                              │
4. 使用者填寫表單                                       │
5. 送出註冊資料                                         ▼
                                                   ┌──────────┐
                                                   │  Google  │
                                                   │  Sheets  │
                                                   └────┬─────┘
                                                        │
                                              1. 新增會員資料
                                              2. 設定初始點數 100
                                              3. 記錄註冊交易
                                                        │
                                                        ▼
                                                   回傳成功
                                                        │
┌──────────┐      ┌──────────┐                         │
│ 會員中心 │◀─────│ 跳轉     │◀────────────────────────┘
│ profile  │      │          │
└──────────┘      └──────────┘
```

### 2. 點數查詢流程

```
┌──────────┐      ┌──────────┐      ┌──────────┐      ┌──────────┐
│ LINE App │─────▶│ LIFF SDK │─────▶│ 前端頁面 │─────▶│ Apps     │
│          │      │ 認證     │      │ profile  │      │ Script   │
└──────────┘      └──────────┘      └──────────┘      └────┬─────┘
                                                            │
                                                            ▼
1. 開啟會員中心                                      根據 lineUserId
2. LIFF SDK 取得 User ID                            查詢會員資料
3. 呼叫 profile API                                       │
                                                           ▼
                                                   ┌──────────┐
                                                   │  Google  │
                                                   │  Sheets  │
                                                   └────┬─────┘
                                                        │
                                                   讀取會員資料
                                                   (含點數餘額)
                                                        │
                                                        ▼
┌──────────┐                                      回傳會員資料
│ 顯示     │◀──────────────────────────────────────────┘
│ - 姓名   │
│ - 電話   │
│ - Email  │
│ - 點數   │
└──────────┘
```

### 3. 點數轉移流程

```
┌──────────┐      ┌──────────┐      ┌──────────┐
│ 輸入     │      │ 驗證     │      │ 確認     │
│ 收款人   │─────▶│ 收款人   │─────▶│ 轉點     │
│ 手機     │      │ 是否存在 │      │          │
└──────────┘      └──────────┘      └────┬─────┘
                                         │
                                         ▼
                                    ┌──────────┐
                                    │ Apps     │
                                    │ Script   │
                                    └────┬─────┘
                                         │
                                         ▼
                               驗證轉點條件：
                               1. 點數是否足夠
                               2. 收款人是否存在
                               3. 是否轉給自己
                               4. 金額是否有效
                                         │
                                         ▼
                                    執行轉點：
                                    1. 扣除發送者點數
                                    2. 增加接收者點數
                                    3. 記錄 2 筆交易
                                    (transfer_out 和 transfer_in)
                                         │
                                         ▼
                                    ┌──────────┐
                                    │ 轉點成功 │
                                    │ 顯示剩餘 │
                                    │ 點數     │
                                    └──────────┘
```

---

## 🔐 安全性設計

### 1. 身份驗證

```
LINE User ID (唯一識別碼)
    ↓
LIFF SDK 自動取得
    ↓
每次 API 請求都帶 lineUserId
    ↓
Apps Script 驗證會員存在
```

### 2. 資料驗證

**前端驗證:**
- 手機號碼格式 (0912-345-678)
- Email 格式
- 必填欄位
- 點數範圍

**後端驗證:**
- 重複註冊檢查
- 手機號碼唯一性
- 點數餘額檢查
- 收款人存在性
- 轉點邏輯驗證

### 3. 交易安全

```
轉點交易 (Atomic)
    ├─ 1. 鎖定發送者帳戶
    ├─ 2. 檢查點數餘額
    ├─ 3. 扣除點數
    ├─ 4. 增加接收者點數
    ├─ 5. 記錄交易 (發送方)
    ├─ 6. 記錄交易 (接收方)
    └─ 7. 更新時間戳記
```

---

## 📊 資料庫設計

### Members 表結構

| 欄位名稱 | 類型 | 說明 | 索引 |
|---------|------|------|------|
| lineUserId | String | LINE User ID | Primary Key |
| name | String | 會員姓名 | |
| phone | String | 手機號碼 | Unique |
| email | String | Email | |
| birthday | String | 生日 | |
| lineName | String | LINE 顯示名稱 | |
| linePicture | String | LINE 頭像 URL | |
| points | Number | 點數餘額 | Index |
| createdAt | ISO Date | 建立時間 | Index |
| updatedAt | ISO Date | 更新時間 | |

### Transactions 表結構

| 欄位名稱 | 類型 | 說明 | 索引 |
|---------|------|------|------|
| id | UUID | 交易 ID | Primary Key |
| type | String | 交易類型 | Index |
| senderUserId | String | 發送者 ID | Index |
| receiverUserId | String | 接收者 ID | Index |
| senderName | String | 發送者姓名 | |
| receiverName | String | 接收者姓名 | |
| points | Number | 點數（+/-） | |
| message | String | 留言 | |
| createdAt | ISO Date | 交易時間 | Index |

### 交易類型 (type)

- `register` - 註冊贈送
- `transfer_out` - 轉出點數
- `transfer_in` - 收到點數
- `admin_add` - 管理員增加
- `admin_deduct` - 管理員扣除
- `purchase` - 購買點數（擴充）
- `redeem` - 兌換商品（擴充）

---

## 🚀 部署架構

### 方案 A: 基礎架構（推薦新手）

```
┌─────────────────────────────────────────┐
│  前端: GitHub Pages (免費)               │
│  - 靜態網頁託管                          │
│  - 自動 HTTPS                           │
│  - 全球 CDN                             │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  後端: Google Apps Script (免費)         │
│  - API 處理                             │
│  - 商業邏輯                             │
│  - 每日配額: 20,000 次執行               │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  資料庫: Google Sheets (免費)            │
│  - 最多 500 萬個儲存格                   │
│  - 自動備份                             │
│  - 視覺化編輯                           │
└─────────────────────────────────────────┘

總成本: $0 / 月
適用: 小型應用 (< 1000 會員)
```

### 方案 B: 進階架構（推薦進階）

```
┌─────────────────────────────────────────┐
│  前端: Vercel / Netlify (免費/付費)      │
│  - 靜態網頁託管                          │
│  - 自訂網域                             │
│  - 更快的 CDN                           │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  中間層: N8N on Zeabur (付費)            │
│  - Workflow 自動化                       │
│  - 更複雜的商業邏輯                       │
│  - 整合其他服務                          │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  後端: Google Apps Script                │
│  - 資料存取層                            │
│  - 交易處理                             │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  資料庫: Google Sheets                   │
│  或 PostgreSQL (更快速)                  │
└─────────────────────────────────────────┘

總成本: $5-20 / 月
適用: 中型應用 (1000-10000 會員)
```

### 方案 C: 企業架構

```
┌─────────────────────────────────────────┐
│  前端: Cloudflare Pages                  │
│  CDN: Cloudflare                        │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  後端: Node.js API (自架或 VPS)          │
│  - Express.js                           │
│  - Redis 快取                           │
│  - JWT 認證                             │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  資料庫: PostgreSQL + Redis              │
│  - 主資料庫                             │
│  - 快取層                               │
│  - 讀寫分離                             │
└─────────────────────────────────────────┘

總成本: $50-200 / 月
適用: 大型應用 (> 10000 會員)
```

---

## 📈 擴充性考量

### 效能指標

| 架構方案 | 同時連線 | 每日請求 | 回應時間 | 成本 |
|---------|---------|---------|---------|------|
| 方案 A  | ~100    | ~20,000 | 1-3s    | $0   |
| 方案 B  | ~500    | ~100,000| 0.5-1s  | $10  |
| 方案 C  | ~5,000  | 無限制  | <100ms  | $100 |

### 升級路徑

```
階段 1: 基礎架構 (0-1000 會員)
    ↓ 會員增長
階段 2: 加入 N8N 中間層
    ↓ 效能需求
階段 3: 遷移到 PostgreSQL
    ↓ 流量暴增
階段 4: 完整後端 API + CDN
```

---

## 🔄 整合建議

### 1. LINE Messaging API

```javascript
// 註冊成功後推播訊息
function sendWelcomeMessage(userId) {
  const url = 'https://api.line.me/v2/bot/message/push';
  const payload = {
    to: userId,
    messages: [{
      type: 'text',
      text: '歡迎加入！您已獲得 100 點獎勵 🎉'
    }]
  };
  
  UrlFetchApp.fetch(url, {
    method: 'post',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer YOUR_CHANNEL_ACCESS_TOKEN'
    },
    payload: JSON.stringify(payload)
  });
}
```

### 2. 金流整合（綠界、藍新等）

```javascript
// 購買點數
function purchasePoints(userId, amount) {
  // 1. 產生訂單
  // 2. 呼叫金流 API
  // 3. 等待付款回調
  // 4. 增加點數
}
```

### 3. CRM 整合

```javascript
// 同步到 HubSpot / Salesforce
function syncToCRM(memberData) {
  // 自動同步會員資料
}
```

---

## 🎯 最佳實踐

### 1. 錯誤處理

```javascript
try {
  // API 呼叫
} catch (error) {
  // 記錄錯誤
  Logger.log('Error:', error);
  
  // 回傳友善訊息
  return {
    success: false,
    message: '系統忙碌中，請稍後再試'
  };
}
```

### 2. 資料備份

- 定期匯出 Google Sheets
- 設定自動備份腳本
- 保留交易記錄至少 1 年

### 3. 監控告警

- Google Apps Script 執行失敗通知
- 異常交易偵測
- 點數異常變動警報

### 4. 效能優化

- 使用批次讀取減少 API 呼叫
- 快取常用資料
- 定期清理舊資料

---

**系統架構文件完成！** 📚

