<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç®¡ç†å¾Œå°</title>
<link rel="stylesheet" href="./assets/style.css">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  .admin-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 40px 30px;
    border-radius: 16px;
    margin-bottom: 30px;
    text-align: center;
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.25);
    position: relative;
    overflow: hidden;
  }
  .admin-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: pulse 10s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% {
      transform: translate(0, 0) scale(1);
    }
    50% {
      transform: translate(-10%, -10%) scale(1.1);
    }
  }
  .admin-header h1 {
    margin: 0;
    font-size: 32px;
    font-weight: 700;
    position: relative;
    z-index: 1;
  }
  .admin-header p {
    margin: 8px 0 0 0;
    opacity: 0.95;
    font-size: 15px;
    position: relative;
    z-index: 1;
  }
  .admin-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
    overflow-x: auto;
    padding: 4px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    -webkit-overflow-scrolling: touch;
  }
  .tab {
    padding: 12px 20px;
    background: transparent;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s ease;
    white-space: nowrap;
    position: relative;
  }
  .tab:hover:not(.active) {
    background: #f5f5f5;
  }
  .tab.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
    animation: fadeIn 0.3s;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .stat-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
  }
  
  /* æ¡Œé¢ç‰ˆï¼š3æ¬„ä½ˆå±€ */
  @media (min-width: 1200px) {
    .stat-cards {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  .stat-card {
    background: white;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2);
  }
  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
  }
  .stat-icon {
    font-size: 36px;
    margin-bottom: 10px;
  }
  .stat-label {
    color: #666;
    font-size: 14px;
    margin-bottom: 5px;
  }
  .stat-value {
    font-size: 32px;
    font-weight: bold;
    color: #333;
  }
  .member-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  }
  .member-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  .member-table th {
    padding: 16px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 0.5px;
  }
  .member-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #f0f0f0;
  }
  .member-table tbody tr {
    transition: all 0.2s ease;
  }
  .member-table tbody tr:hover {
    background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%);
    transform: scale(1.005);
  }
  .member-table tbody tr:last-child td {
    border-bottom: none;
  }
  .level-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
  }
  .level-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  .level-BRONZE {
    background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
    color: white;
  }
  .level-SILVER {
    background: linear-gradient(135deg, #C0C0C0 0%, #A8A8A8 100%);
    color: #333;
  }
  .level-GOLD {
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    color: #333;
  }
  .level-PLATINUM {
    background: linear-gradient(135deg, #E5E4E2 0%, #B4B4B4 100%);
    color: #333;
  }
  .action-btns {
    display: flex;
    gap: 5px;
  }
  .btn-small {
    padding: 8px 16px;
    font-size: 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    position: relative;
    overflow: hidden;
  }
  .btn-small:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
  }
  .btn-small::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
  }
  .btn-small:hover::before {
    width: 300px;
    height: 300px;
  }
  .btn-add {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
  }
  .btn-add:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
  }
  .btn-deduct {
    background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
  }
  .btn-deduct:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
  }
  .search-box {
    margin-bottom: 20px;
    position: relative;
  }
  .search-box::before {
    content: 'ğŸ”';
    position: absolute;
    left: 16px;
    top: 28px;
    font-size: 18px;
    pointer-events: none;
    z-index: 1;
  }
  .search-box input {
    width: 100%;
    padding: 14px 16px 14px 48px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 14px;
    transition: all 0.3s ease;
  }
  .search-box input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    outline: none;
  }
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .modal.active {
    display: flex;
  }
  .modal-content {
    background: white;
    padding: 30px;
    border-radius: 16px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }
  .modal h3 {
    margin-top: 0;
    color: #333;
  }
  .form-row {
    margin-bottom: 15px;
  }
  .form-row label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #333;
  }
  .form-row input,
  .form-row textarea {
    width: 100%;
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
  }
  .modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }
  
  /* æ¡Œé¢ç‰ˆä½ˆå±€å„ªåŒ– */
  @media (min-width: 1400px) {
    .container {
      max-width: 1400px;
    }
    
    /* å„€è¡¨æ¿ï¼šæ©«å‘ä½ˆå±€ */
    .dashboard-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin-top: 20px;
    }
    
    /* æœƒå“¡ç®¡ç†ï¼šå´é‚Šæ¬„ä½ˆå±€ */
    .members-layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 24px;
    }
  }
  
  @media (min-width: 1200px) {
    .container {
      max-width: 1200px;
    }
    
    /* è¡¨æ ¼å„ªåŒ–å¯¬åº¦ */
    .member-table {
      min-width: 1000px;
    }
  }
  
  /* å¹³æ¿ç‰ˆ */
  @media (min-width: 769px) and (max-width: 1199px) {
    .container {
      max-width: 95%;
    }
    
    .stat-cards {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  
  /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
  @media (max-width: 768px) {
    .admin-header {
      padding: 30px 20px;
    }
    .admin-header h1 {
      font-size: 26px;
    }
    .admin-header > div {
      flex-direction: column;
      gap: 15px;
    }
    .admin-header > div > div {
      flex: none !important;
      width: 100%;
      text-align: center !important;
    }
    .admin-tabs {
      gap: 6px;
      padding: 8px;
    }
    .tab {
      padding: 10px 16px;
      font-size: 13px;
    }
    .stat-cards {
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .stat-card {
      padding: 16px;
    }
    .stat-icon {
      font-size: 28px;
    }
    .stat-value {
      font-size: 24px;
    }
    .search-box input {
      font-size: 16px; /* é˜²æ­¢iOSè‡ªå‹•ç¸®æ”¾ */
    }
    .member-table {
      font-size: 13px;
    }
    .member-table th,
    .member-table td {
      padding: 10px 8px;
    }
  }
  
  @media (max-width: 480px) {
    .container {
      padding: 15px;
    }
    .admin-header {
      padding: 24px 16px;
      margin-bottom: 20px;
    }
    .admin-header h1 {
      font-size: 22px;
    }
    .stat-cards {
      grid-template-columns: 1fr;
      gap: 10px;
    }
  }
  
  /* è¼‰å…¥å‹•ç•«å„ªåŒ– */
  @keyframes skeletonPulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }
  
  .skeleton-loading {
    animation: skeletonPulse 1.5s ease-in-out infinite;
    background: linear-gradient(
      90deg,
      #f0f0f0 25%,
      #e0e0e0 50%,
      #f0f0f0 75%
    );
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }
  
  @keyframes shimmer {
    0% {
      background-position: -200% 0;
    }
    100% {
      background-position: 200% 0;
    }
  }
</style>
</head>
<body>
<div class="container">
  <div class="admin-header">
    <div style="display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2;">
      <div style="flex: 1;"></div>
      <div style="text-align: center; flex: 2;">
        <h1>ğŸ› ï¸ ç®¡ç†å¾Œå°</h1>
        <p>æœƒå“¡ç³»çµ±ç®¡ç†ä¸­å¿ƒ</p>
      </div>
      <div style="flex: 1; text-align: right;">
        <button onclick="logout()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s;">
          ğŸšª ç™»å‡º
        </button>
      </div>
    </div>
  </div>
  
  <!-- ç®¡ç†å“¡é©—è­‰ -->
  <div id="authCheck" class="loading" style="text-align: center; padding: 40px;">
    <div class="spinner"></div>
    <p style="margin-top: 15px; color: #666;">é©—è­‰ç®¡ç†å“¡èº«åˆ†...</p>
  </div>
  
  <!-- ä¸»å…§å®¹ -->
  <div id="mainContent" style="display: none;">
    <!-- åˆ†é æ¨™ç±¤ -->
    <div class="admin-tabs">
      <button class="tab active" onclick="switchTab('dashboard')">ğŸ“Š å„€è¡¨æ¿</button>
      <button class="tab" onclick="switchTab('members')">ğŸ‘¥ æœƒå“¡ç®¡ç†</button>
      <button class="tab" onclick="switchTab('referrals')">ğŸ æ¨è–¦çµ±è¨ˆ</button>
      <button class="tab" onclick="switchTab('points')">ğŸ’° é»æ•¸èª¿æ•´</button>
      <button class="tab" onclick="switchTab('settings')">âš™ï¸ ç³»çµ±è¨­å®š</button>
      <button class="tab" onclick="switchTab('stats')">ğŸ“ˆ çµ±è¨ˆå ±è¡¨</button>
    </div>
    
    <!-- å„€è¡¨æ¿ -->
    <div id="dashboard" class="tab-content active">
      <h2>ç³»çµ±ç¸½è¦½</h2>
      <div class="stat-cards" id="statCards">
        <div class="stat-card">
          <div class="stat-icon">ğŸ‘¥</div>
          <div class="stat-label">ç¸½æœƒå“¡æ•¸</div>
          <div class="stat-value" id="totalMembers">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-label">ç¸½é»æ•¸</div>
          <div class="stat-value" id="totalPoints">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“Š</div>
          <div class="stat-label">ç¸½äº¤æ˜“æ•¸</div>
          <div class="stat-value" id="totalTransactions">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ†•</div>
          <div class="stat-label">ä»Šæ—¥æ–°å¢</div>
          <div class="stat-value" id="todayNewMembers">--</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          <div class="stat-icon">ğŸ</div>
          <div class="stat-label" style="color: rgba(255,255,255,0.9);">æ¨è–¦äººæ•¸</div>
          <div class="stat-value" id="dashboardReferrals" style="color: white;">--</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
          <div class="stat-icon">ğŸ†</div>
          <div class="stat-label" style="color: rgba(255,255,255,0.9);">æ´»èºæ¨è–¦äºº</div>
          <div class="stat-value" id="dashboardActiveReferrers" style="color: white;">--</div>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="loadDashboard()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
    </div>
    
    <!-- æœƒå“¡ç®¡ç† -->
    <div id="members" class="tab-content">
      <h2>æœƒå“¡åˆ—è¡¨</h2>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="æœå°‹å§“åã€æ‰‹æ©Ÿè™Ÿç¢¼..." onkeyup="filterMembers()">
        <div id="memberCount" style="margin-top: 10px; color: #666; font-size: 14px;">
          è¼‰å…¥ä¸­...
        </div>
      </div>
      
      <div style="overflow-x: auto;">
        <table class="member-table">
          <thead>
            <tr>
              <th>å§“å</th>
              <th>æ‰‹æ©Ÿ</th>
              <th>é»æ•¸</th>
              <th>ç­‰ç´š</th>
              <th>æ¨è–¦ç¢¼</th>
              <th>è¢«èª°æ¨è–¦</th>
              <th>æ¨è–¦äººæ•¸</th>
              <th>ç‹€æ…‹</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="membersList">
            <tr>
              <td colspan="9" style="text-align: center; padding: 40px;">
                <div class="spinner-small"></div>
                <p>è¼‰å…¥ä¸­...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- åˆ†é æ§åˆ¶ -->
      <div id="pagination" style="display: none; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; flex-wrap: wrap;"></div>
      
      <button class="btn btn-primary" onclick="loadMembers()" style="margin-top: 20px;">ğŸ”„ é‡æ–°è¼‰å…¥</button>
    </div>
    
    <!-- ğŸ æ¨è–¦çµ±è¨ˆ -->
    <div id="referrals" class="tab-content">
      <h2>ğŸ æ¨è–¦ç³»çµ±çµ±è¨ˆ</h2>
      
      <!-- æ¨è–¦ç¸½è¦½å¡ç‰‡ -->
      <div class="stat-cards">
        <div class="stat-card">
          <div class="stat-icon">ğŸ‘¥</div>
          <div class="stat-label">ç¸½æ¨è–¦äººæ•¸</div>
          <div class="stat-value" id="totalReferrals">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ¯</div>
          <div class="stat-label">æ´»èºæ¨è–¦äºº</div>
          <div class="stat-value" id="activeReferrers">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-label">æ¨è–¦ç¸½çå‹µ</div>
          <div class="stat-value" id="totalReferralRewards">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“ˆ</div>
          <div class="stat-label">å¹³å‡æ¨è–¦æ•¸</div>
          <div class="stat-value" id="avgReferrals">--</div>
        </div>
      </div>
      
      <!-- æ¨è–¦æ’è¡Œæ¦œ -->
      <div class="register-card" style="margin-bottom: 20px;">
        <h3 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
          <span>ğŸ†</span>
          <span>æ¨è–¦æ’è¡Œæ¦œ Top 10</span>
        </h3>
        <div style="overflow-x: auto;">
          <table class="member-table">
            <thead>
              <tr>
                <th style="width: 60px;">æ’å</th>
                <th>æœƒå“¡å§“å</th>
                <th>æ¨è–¦ç¢¼</th>
                <th>æ¨è–¦äººæ•¸</th>
                <th>ç²å¾—çå‹µ</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="referralLeaderboard">
              <tr>
                <td colspan="6" style="text-align: center; padding: 40px;">
                  <div class="spinner-small"></div>
                  <p>è¼‰å…¥ä¸­...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- æœ€è¿‘æ¨è–¦è¨˜éŒ„ -->
      <div class="register-card">
        <h3 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
          <span>ğŸ“‹</span>
          <span>æœ€è¿‘æ¨è–¦è¨˜éŒ„</span>
        </h3>
        <div style="overflow-x: auto;">
          <table class="member-table">
            <thead>
              <tr>
                <th>æ¨è–¦äºº</th>
                <th>æ¨è–¦ç¢¼</th>
                <th>æ–°æœƒå“¡</th>
                <th>çå‹µé»æ•¸</th>
                <th>æ¨è–¦æ™‚é–“</th>
              </tr>
            </thead>
            <tbody id="recentReferrals">
              <tr>
                <td colspan="5" style="text-align: center; padding: 40px;">
                  <div class="spinner-small"></div>
                  <p>è¼‰å…¥ä¸­...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="loadReferralStats()" style="margin-top: 20px;">ğŸ”„ é‡æ–°è¼‰å…¥</button>
    </div>
    
    <!-- é»æ•¸èª¿æ•´ -->
    <div id="points" class="tab-content">
      <h2>èª¿æ•´æœƒå“¡é»æ•¸</h2>
      
      <form id="adjustPointsForm" class="register-card">
        <div class="form-group">
          <label for="targetPhone">æœƒå“¡æ‰‹æ©Ÿè™Ÿç¢¼ *</label>
          <input type="tel" id="targetPhone" required placeholder="0912-345-678" pattern="[0-9]{4}-[0-9]{3}-[0-9]{3}">
          <div id="memberInfo" class="receiver-info"></div>
        </div>
        
        <div class="form-group">
          <label>æ“ä½œé¡å‹ *</label>
          <div style="display: flex; gap: 10px; margin-top: 8px;">
            <label style="flex: 1;">
              <input type="radio" name="adjustType" value="add" checked>
              <span style="margin-left: 8px;">â• å¢åŠ é»æ•¸</span>
            </label>
            <label style="flex: 1;">
              <input type="radio" name="adjustType" value="deduct">
              <span style="margin-left: 8px;">â– æ‰£é™¤é»æ•¸</span>
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label for="adjustPoints">é»æ•¸æ•¸é‡ *</label>
          <input type="number" id="adjustPoints" required placeholder="è«‹è¼¸å…¥é»æ•¸" min="1">
          <div style="display: flex; gap: 8px; margin-top: 10px;">
            <button type="button" class="btn-quick" onclick="setAdjustAmount(50)">50</button>
            <button type="button" class="btn-quick" onclick="setAdjustAmount(100)">100</button>
            <button type="button" class="btn-quick" onclick="setAdjustAmount(500)">500</button>
            <button type="button" class="btn-quick" onclick="setAdjustAmount(1000)">1000</button>
          </div>
        </div>
        
        <div class="form-group">
          <label for="reason">èª¿æ•´åŸå›  *</label>
          <textarea id="reason" required placeholder="è«‹èªªæ˜èª¿æ•´é»æ•¸çš„åŸå› ..." rows="3"></textarea>
        </div>
        
        <button type="submit" class="btn btn-primary btn-large" id="adjustBtn">
          <span class="btn-icon">ğŸ’°</span>
          ç¢ºèªèª¿æ•´
        </button>
      </form>
      
      <div id="adjustMessage" class="message"></div>
    </div>
    
    <!-- ç³»çµ±è¨­å®š -->
    <div id="settings" class="tab-content">
      <h2>ç³»çµ±è¨­å®š</h2>
      
      <div class="register-card">
        <div class="form-group">
          <label>è¨»å†Šè´ˆé€é»æ•¸</label>
          <input type="number" id="settingInitialPoints" value="100">
        </div>
        
        <div class="form-group">
          <label>é»æ•¸æœ‰æ•ˆå¤©æ•¸ï¼ˆ0=æ°¸ä¹…ï¼‰</label>
          <input type="number" id="settingExpiryDays" value="365">
        </div>
        
        <div class="form-group">
          <label>æœ€å°è½‰é»æ•¸é‡</label>
          <input type="number" id="settingMinTransfer" value="1">
        </div>
        
        <div class="form-group">
          <label>æœ€å¤§è½‰é»æ•¸é‡</label>
          <input type="number" id="settingMaxTransfer" value="10000">
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="settingMaintenance">
            <span style="margin-left: 8px;">ç¶­è­·æ¨¡å¼ï¼ˆé—œé–‰è¨»å†ŠåŠŸèƒ½ï¼‰</span>
          </label>
        </div>
        
        <button class="btn btn-primary btn-large" onclick="saveSettings()">
          <span class="btn-icon">ğŸ’¾</span>
          å„²å­˜è¨­å®š
        </button>
      </div>
      
      <div id="settingsMessage" class="message"></div>
    </div>
    
    <!-- çµ±è¨ˆå ±è¡¨ -->
    <div id="stats" class="tab-content">
      <h2>æ•¸æ“šçµ±è¨ˆ</h2>
      
      <div class="register-card">
        <h3>ä»Šæ—¥æ•¸æ“š</h3>
        <div class="stat-cards">
          <div class="stat-card">
            <div class="stat-icon">ğŸ†•</div>
            <div class="stat-label">æ–°å¢æœƒå“¡</div>
            <div class="stat-value" id="statNewMembers">--</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ’¸</div>
            <div class="stat-label">äº¤æ˜“ç­†æ•¸</div>
            <div class="stat-value" id="statTransactions">--</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ“¤</div>
            <div class="stat-label">ç™¼å‡ºé»æ•¸</div>
            <div class="stat-value" id="statIssued">--</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ“¥</div>
            <div class="stat-label">æ¶ˆè²»é»æ•¸</div>
            <div class="stat-value" id="statRedeemed">--</div>
          </div>
        </div>
        
        <button class="btn btn-primary" onclick="runDailyStats()">
          <span class="btn-icon">ğŸ“Š</span>
          åŸ·è¡Œæ¯æ—¥çµ±è¨ˆ
        </button>
      </div>
      
      <div id="statsMessage" class="message"></div>
    </div>
  </div>
</div>

<!-- èª¿æ•´é»æ•¸ç¢ºèªè¦–çª— -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h3>ç¢ºèªèª¿æ•´é»æ•¸</h3>
    <div class="confirm-details">
      <p><strong>æœƒå“¡ï¼š</strong><span id="confirmMember"></span></p>
      <p><strong>ç›®å‰é»æ•¸ï¼š</strong><span id="confirmCurrentPoints"></span> é»</p>
      <p><strong>èª¿æ•´é¡å‹ï¼š</strong><span id="confirmType"></span></p>
      <p><strong>èª¿æ•´æ•¸é‡ï¼š</strong><span id="confirmAmount"></span> é»</p>
      <p><strong>èª¿æ•´å¾Œï¼š</strong><span id="confirmNewPoints"></span> é»</p>
      <p><strong>åŸå› ï¼š</strong><span id="confirmReason"></span></p>
    </div>
    <div class="modal-buttons">
      <button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="confirmAdjust()">ç¢ºèªåŸ·è¡Œ</button>
    </div>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwYbhHNlwix-1FQzB63PVKprfiV0Q3CxOLNFuGUWXXnPNPsiN3L5bvkr6id0XyITi_F/exec';

// ç®¡ç†å“¡ç™½åå–®ï¼ˆLINE User IDï¼‰
const ADMIN_USERS = [
  'YOUR_LINE_USER_ID',  // æ›¿æ›ç‚ºæ‚¨çš„ LINE User ID
  // å¯ä»¥åŠ å…¥æ›´å¤šç®¡ç†å“¡
];

let currentAdmin = null;
let allMembers = [];
let targetMember = null;
let adjustData = null;

// ==================== å¿«å–ç®¡ç† ====================
const CACHE_KEY = 'admin_session';
const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24å°æ™‚

// å„²å­˜ç®¡ç†å“¡è³‡è¨Šåˆ°å¿«å–
function saveAdminCache(profile) {
  const cacheData = {
    profile: profile,
    timestamp: Date.now()
  };
  localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
  console.log('âœ… å·²å„²å­˜ç®¡ç†å“¡å¿«å–');
}

// å–å¾—å¿«å–çš„ç®¡ç†å“¡è³‡è¨Š
function getAdminCache() {
  try {
    const cached = localStorage.getItem(CACHE_KEY);
    if (!cached) return null;
    
    const cacheData = JSON.parse(cached);
    const age = Date.now() - cacheData.timestamp;
    
    // æª¢æŸ¥å¿«å–æ˜¯å¦éæœŸ
    if (age > CACHE_DURATION) {
      console.log('â° å¿«å–å·²éæœŸï¼Œéœ€è¦é‡æ–°ç™»å…¥');
      clearAdminCache();
      return null;
    }
    
    console.log('âœ… ä½¿ç”¨å¿«å–çš„ç®¡ç†å“¡è³‡è¨Š');
    return cacheData.profile;
  } catch (error) {
    console.error('è®€å–å¿«å–éŒ¯èª¤:', error);
    return null;
  }
}

// æ¸…é™¤å¿«å–
function clearAdminCache() {
  localStorage.removeItem(CACHE_KEY);
  console.log('ğŸ—‘ï¸ å·²æ¸…é™¤ç®¡ç†å“¡å¿«å–');
}

// é¡¯ç¤ºå¿«å–è³‡è¨Šï¼ˆé–‹ç™¼ç”¨ï¼‰
function showCacheInfo() {
  const cached = localStorage.getItem(CACHE_KEY);
  if (cached) {
    const data = JSON.parse(cached);
    const age = Date.now() - data.timestamp;
    const remaining = CACHE_DURATION - age;
    console.log('ğŸ“¦ å¿«å–è³‡è¨Š:', {
      ç®¡ç†å“¡: data.profile.displayName,
      å»ºç«‹æ™‚é–“: new Date(data.timestamp).toLocaleString(),
      å‰©é¤˜æ™‚é–“: Math.floor(remaining / 1000 / 60) + ' åˆ†é˜'
    });
  } else {
    console.log('âŒ ç„¡å¿«å–è³‡æ–™');
  }
}

// ç™»å‡ºåŠŸèƒ½
function logout() {
  if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿç™»å‡ºå¾Œéœ€è¦é‡æ–°é©—è­‰èº«åˆ†ã€‚')) {
    clearAdminCache();
    alert('âœ… å·²æˆåŠŸç™»å‡ºï¼');
    location.reload();
  }
}

async function initLiff() {
  try {
    // ğŸ”¥ å„ªå…ˆæª¢æŸ¥å¿«å–
    const cachedProfile = getAdminCache();
    
    if (cachedProfile) {
      // ä½¿ç”¨å¿«å–çš„ç®¡ç†å“¡è³‡è¨Š
      currentAdmin = cachedProfile;
      
      // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
      if (!ADMIN_USERS.includes(cachedProfile.userId)) {
        document.getElementById('authCheck').innerHTML = `
          <div class="error-card">
            <div class="error-icon">ğŸš«</div>
            <h3>ç„¡æ¬Šé™è¨ªå•</h3>
            <p>æ‚¨ä¸æ˜¯ç³»çµ±ç®¡ç†å“¡</p>
            <button class="btn btn-primary" onclick="clearAdminCache(); location.reload();">é‡æ–°ç™»å…¥</button>
          </div>
        `;
        return;
      }
      
      // ç®¡ç†å“¡é©—è­‰é€šéï¼ˆä½¿ç”¨å¿«å–ï¼‰
      document.getElementById('authCheck').innerHTML = `
        <div style="text-align: center; padding: 40px; color: #28a745;">
          <div style="font-size: 48px; margin-bottom: 15px;">âœ…</div>
          <p style="font-size: 16px; margin-top: 10px;">æ­¡è¿å›ä¾†ï¼Œ${cachedProfile.displayName}ï¼</p>
          <p style="font-size: 14px; color: #666; margin-top: 5px;">ï¼ˆä½¿ç”¨å¿«å–ç™»å…¥ï¼‰</p>
        </div>
      `;
      
      setTimeout(() => {
        document.getElementById('authCheck').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        loadDashboard();
      }, 1000);
      
      return;
    }
    
    // ğŸ”¥ ç„¡å¿«å–ï¼Œé€²è¡Œ LIFF ç™»å…¥
    console.log('ğŸ” ç„¡å¿«å–ï¼Œé–‹å§‹ LIFF ç™»å…¥...');
    await liff.init({ liffId: "2008231108-2PDbO5qk" });
    
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    
    const profile = await liff.getProfile();
    currentAdmin = profile;
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
    if (!ADMIN_USERS.includes(profile.userId)) {
      document.getElementById('authCheck').innerHTML = `
        <div class="error-card">
          <div class="error-icon">ğŸš«</div>
          <h3>ç„¡æ¬Šé™è¨ªå•</h3>
          <p>æ‚¨ä¸æ˜¯ç³»çµ±ç®¡ç†å“¡</p>
          <button class="btn btn-primary" onclick="liff.closeWindow()">é—œé–‰</button>
        </div>
      `;
      return;
    }
    
    // ğŸ”¥ ç®¡ç†å“¡é©—è­‰é€šéï¼Œå„²å­˜å¿«å–
    saveAdminCache(profile);
    
    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
    document.getElementById('authCheck').innerHTML = `
      <div style="text-align: center; padding: 40px; color: #28a745;">
        <div style="font-size: 48px; margin-bottom: 15px;">âœ…</div>
        <p style="font-size: 16px; margin-top: 10px;">æ­¡è¿ï¼Œ${profile.displayName}ï¼</p>
        <p style="font-size: 14px; color: #666; margin-top: 5px;">ï¼ˆå·²å»ºç«‹å¿«å–ï¼‰</p>
      </div>
    `;
    
    setTimeout(() => {
      document.getElementById('authCheck').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      loadDashboard();
    }, 1000);
    
  } catch (error) {
    console.error('LIFF åˆå§‹åŒ–éŒ¯èª¤:', error);
    document.getElementById('authCheck').innerHTML = `
      <div class="error-card">
        <div class="error-icon">âŒ</div>
        <h3>è¼‰å…¥å¤±æ•—</h3>
        <p>${error.message}</p>
        <button class="btn btn-secondary" onclick="clearAdminCache(); location.reload();">æ¸…é™¤å¿«å–ä¸¦é‡è©¦</button>
      </div>
    `;
  }
}

// åˆ‡æ›åˆ†é 
function switchTab(tabName) {
  // æ›´æ–°æ¨™ç±¤æ¨£å¼
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  
  // æ›´æ–°å…§å®¹
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  
  // è¼‰å…¥å°æ‡‰è³‡æ–™
  if (tabName === 'dashboard') loadDashboard();
  if (tabName === 'members') loadMembers();
  if (tabName === 'referrals') loadReferralStats();
  if (tabName === 'settings') loadSettings();
}

// è¼‰å…¥å„€è¡¨æ¿
async function loadDashboard() {
  try {
    const res = await fetch(`${API_URL}?action=admin-stats`);
    const data = await res.json();
    
    if (data.success) {
      document.getElementById('totalMembers').textContent = data.stats.totalMembers || 0;
      document.getElementById('totalPoints').textContent = data.stats.totalPoints || 0;
      document.getElementById('totalTransactions').textContent = data.stats.totalTransactions || 0;
      document.getElementById('todayNewMembers').textContent = data.stats.todayNewMembers || 0;
    }
  } catch (error) {
    console.error('è¼‰å…¥å„€è¡¨æ¿éŒ¯èª¤:', error);
  }
}

// è¼‰å…¥æœƒå“¡åˆ—è¡¨
async function loadMembers() {
  const tbody = document.getElementById('membersList');
  const countDiv = document.getElementById('memberCount');
  
  try {
    // é¡¯ç¤ºè¼‰å…¥ä¸­
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;"><div class="spinner"></div><p style="margin-top:15px;color:#666;">è¼‰å…¥æœƒå“¡è³‡æ–™ä¸­...</p></td></tr>';
    if (countDiv) countDiv.innerHTML = 'è¼‰å…¥ä¸­...';
    
    const res = await fetch(`${API_URL}?action=admin-members`);
    const data = await res.json();
    
    if (data.success) {
      allMembers = data.members;
      // æ¸…ç©ºæœå°‹æ¡†
      const searchInput = document.getElementById('searchInput');
      if (searchInput) searchInput.value = '';
      // æ¸²æŸ“æœƒå“¡åˆ—è¡¨
      renderMembers(allMembers);
    } else {
      tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:#f44336;">âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦</td></tr>';
    }
  } catch (error) {
    console.error('è¼‰å…¥æœƒå“¡éŒ¯èª¤:', error);
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:#f44336;">âŒ ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£ç·š</td></tr>';
  }
}

// ==================== åˆ†é ç®¡ç† ====================
let currentPage = 1;
const itemsPerPage = 20; // æ¯é é¡¯ç¤º 20 ç­†
let filteredMembers = [];

// æ¸²æŸ“æœƒå“¡åˆ—è¡¨ï¼ˆåˆ†é å„ªåŒ–ç‰ˆï¼‰
function renderMembers(members) {
  const tbody = document.getElementById('membersList');
  
  if (!members || members.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;">æš«ç„¡æœƒå“¡è³‡æ–™</td></tr>';
    hidePagination();
    return;
  }
  
  filteredMembers = members;
  const totalPages = Math.ceil(members.length / itemsPerPage);
  
  // ç¢ºä¿ç•¶å‰é é¢åœ¨æœ‰æ•ˆç¯„åœå…§
  if (currentPage > totalPages) currentPage = totalPages;
  if (currentPage < 1) currentPage = 1;
  
  // è¨ˆç®—ç•¶å‰é é¢è¦é¡¯ç¤ºçš„è³‡æ–™
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageMembers = members.slice(startIndex, endIndex);
  
  // æ‰¹é‡ç”Ÿæˆ HTMLï¼ˆåªç”Ÿæˆç•¶å‰é ï¼‰
  const html = pageMembers.map(m => `
    <tr>
      <td>${escapeHtml(m.name)}</td>
      <td>${escapeHtml(m.phone)}</td>
      <td><strong>${m.points}</strong></td>
      <td><span class="level-badge level-${m.memberLevel || 'BRONZE'}">${getLevelIcon(m.memberLevel)} ${getLevelName(m.memberLevel)}</span></td>
      <td><code style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${m.referralCode || 'N/A'}</code></td>
      <td>${m.referredBy ? `<code style="background: #fff3cd; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: #856404;">ğŸ ${escapeHtml(m.referredBy)}</code>` : '<span style="color: #999;">-</span>'}</td>
      <td><strong style="color: #667eea;">${m.referralCount || 0}</strong> äºº</td>
      <td>${m.status === 'active' ? 'âœ… æ­£å¸¸' : 'âš ï¸ åœç”¨'}</td>
      <td class="action-btns">
        <button class="btn-small btn-add" onclick='adjustMemberPoints("${escapeHtml(m.lineUserId)}", "${escapeHtml(m.name)}", ${m.points}, "add")'>â•</button>
        <button class="btn-small btn-deduct" onclick='adjustMemberPoints("${escapeHtml(m.lineUserId)}", "${escapeHtml(m.name)}", ${m.points}, "deduct")'>â–</button>
      </td>
    </tr>
  `).join('');
  
  // ä¸€æ¬¡æ€§æ›¿æ›
  tbody.innerHTML = html;
  
  // æ›´æ–°åˆ†é è³‡è¨Š
  updateMemberCount(members.length, startIndex + 1, Math.min(endIndex, members.length));
  updatePagination(currentPage, totalPages);
}

// HTML è·³è„«å‡½æ•¸ï¼ˆé˜²æ­¢ XSSï¼‰
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// æ›´æ–°æœƒå“¡æ•¸é‡é¡¯ç¤ºï¼ˆå«åˆ†é è³‡è¨Šï¼‰
function updateMemberCount(total, start, end) {
  const countDiv = document.getElementById('memberCount');
  if (countDiv) {
    const totalAll = allMembers ? allMembers.length : 0;
    if (total === totalAll) {
      countDiv.innerHTML = `ğŸ“‹ å…± <strong>${total}</strong> ä½æœƒå“¡ | é¡¯ç¤ºç¬¬ <strong>${start}-${end}</strong> ä½`;
    } else {
      countDiv.innerHTML = `ğŸ” æœå°‹åˆ° <strong>${total}</strong> ä½æœƒå“¡ï¼ˆå…± ${totalAll} ä½ï¼‰| é¡¯ç¤ºç¬¬ <strong>${start}-${end}</strong> ä½`;
    }
  }
}

// æ›´æ–°åˆ†é æŒ‰éˆ•
function updatePagination(current, total) {
  const paginationDiv = document.getElementById('pagination');
  if (!paginationDiv) return;
  
  if (total <= 1) {
    paginationDiv.style.display = 'none';
    return;
  }
  
  paginationDiv.style.display = 'flex';
  
  let html = `
    <button class="btn-small" ${current === 1 ? 'disabled' : ''} onclick="goToPage(1)">â®ï¸ é¦–é </button>
    <button class="btn-small" ${current === 1 ? 'disabled' : ''} onclick="goToPage(${current - 1})">â—€ï¸ ä¸Šä¸€é </button>
    <span style="padding: 0 15px; font-weight: 600; color: #667eea;">ç¬¬ ${current} / ${total} é </span>
    <button class="btn-small" ${current === total ? 'disabled' : ''} onclick="goToPage(${current + 1})">ä¸‹ä¸€é  â–¶ï¸</button>
    <button class="btn-small" ${current === total ? 'disabled' : ''} onclick="goToPage(${total})">æœ«é  â­ï¸</button>
  `;
  
  paginationDiv.innerHTML = html;
}

// è·³è½‰åˆ°æŒ‡å®šé é¢
function goToPage(page) {
  currentPage = page;
  renderMembers(filteredMembers);
  // æ»¾å‹•åˆ°è¡¨æ ¼é ‚éƒ¨
  document.getElementById('members').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// éš±è—åˆ†é 
function hidePagination() {
  const paginationDiv = document.getElementById('pagination');
  if (paginationDiv) {
    paginationDiv.style.display = 'none';
  }
}

// é˜²æŠ–å‡½æ•¸ - é¿å…é »ç¹è§¸ç™¼
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// ç¯©é¸æœƒå“¡ï¼ˆå¯¦éš›åŸ·è¡Œï¼‰
function doFilterMembers() {
  const tbody = document.getElementById('membersList');
  const keyword = document.getElementById('searchInput').value.toLowerCase();
  
  // é‡ç½®åˆ°ç¬¬ä¸€é 
  currentPage = 1;
  
  // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
  if (keyword) {
    tbody.style.opacity = '0.6';
  }
  
  // ä½¿ç”¨ requestAnimationFrame å„ªåŒ–æ¸²æŸ“
  requestAnimationFrame(() => {
    const filtered = allMembers.filter(m => 
      m.name.toLowerCase().includes(keyword) || 
      m.phone.includes(keyword)
    );
    renderMembers(filtered);
    tbody.style.opacity = '1';
  });
}

// é˜²æŠ–ç‰ˆæœ¬çš„ç¯©é¸å‡½æ•¸ï¼ˆ300ms å»¶é²ï¼‰
const filterMembers = debounce(doFilterMembers, 300);

// èª¿æ•´æœƒå“¡é»æ•¸
function adjustMemberPoints(lineUserId, name, currentPoints, type) {
  document.getElementById('targetPhone').value = '';
  document.getElementById('adjustPoints').value = '';
  document.getElementById('reason').value = '';
  
  targetMember = { lineUserId, name, currentPoints, type };
  
  // åˆ‡æ›åˆ°é»æ•¸èª¿æ•´åˆ†é 
  switchTab('points');
  document.querySelectorAll('.tab')[2].click();
  
  // é å¡«è³‡è¨Š
  document.getElementById('memberInfo').innerHTML = `
    <div style="padding: 10px; background: #e3f2fd; border-radius: 8px; margin-top: 10px;">
      <strong>${name}</strong><br>
      ç›®å‰é»æ•¸ï¼š${currentPoints} é»
    </div>
  `;
  
  // è¨­å®šæ“ä½œé¡å‹
  document.querySelector(`input[value="${type}"]`).checked = true;
}

// æª¢æŸ¥æœƒå“¡
document.addEventListener('DOMContentLoaded', function() {
  const phoneInput = document.getElementById('targetPhone');
  if (phoneInput) {
    phoneInput.addEventListener('blur', async function() {
      const phone = this.value;
      if (!phone) return;
      
      try {
        const res = await fetch(`${API_URL}?action=check-user&phone=${phone}`);
        const data = await res.json();
        
        const infoDiv = document.getElementById('memberInfo');
        if (data.exists) {
          targetMember = {
            lineUserId: data.lineUserId,
            name: data.name,
            currentPoints: data.points || 0
          };
          infoDiv.innerHTML = `
            <div style="padding: 10px; background: #e8f5e9; border-radius: 8px; margin-top: 10px;">
              âœ“ <strong>${data.name}</strong><br>
              ç›®å‰é»æ•¸ï¼š${data.points || 0} é»
            </div>
          `;
        } else {
          targetMember = null;
          infoDiv.innerHTML = `
            <div style="padding: 10px; background: #ffebee; border-radius: 8px; margin-top: 10px;">
              âœ— æŸ¥ç„¡æ­¤æœƒå“¡
            </div>
          `;
        }
      } catch (error) {
        console.error('æŸ¥è©¢éŒ¯èª¤:', error);
      }
    });
    
    // æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼åŒ–
    phoneInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 10) value = value.slice(0, 10);
      
      if (value.length >= 4) {
        value = value.slice(0, 4) + '-' + value.slice(4);
      }
      if (value.length >= 8) {
        value = value.slice(0, 8) + '-' + value.slice(8);
      }
      
      e.target.value = value;
    });
  }
});

// è¨­å®šèª¿æ•´æ•¸é‡
function setAdjustAmount(amount) {
  document.getElementById('adjustPoints').value = amount;
}

// æäº¤èª¿æ•´é»æ•¸è¡¨å–®
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('adjustPointsForm');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!targetMember) {
        showMessage('adjustMessage', 'è«‹å…ˆè¼¸å…¥æœ‰æ•ˆçš„æœƒå“¡æ‰‹æ©Ÿè™Ÿç¢¼', 'error');
        return;
      }
      
      const adjustType = document.querySelector('input[name="adjustType"]:checked').value;
      const points = parseInt(document.getElementById('adjustPoints').value);
      const reason = document.getElementById('reason').value;
      
      if (!points || points < 1) {
        showMessage('adjustMessage', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é»æ•¸', 'error');
        return;
      }
      
      const actualPoints = adjustType === 'add' ? points : -points;
      const newPoints = targetMember.currentPoints + actualPoints;
      
      if (newPoints < 0) {
        showMessage('adjustMessage', 'èª¿æ•´å¾Œé»æ•¸ä¸èƒ½ç‚ºè² æ•¸', 'error');
        return;
      }
      
      // é¡¯ç¤ºç¢ºèªè¦–çª—
      adjustData = {
        lineUserId: targetMember.lineUserId,
        points: actualPoints,
        reason: reason
      };
      
      document.getElementById('confirmMember').textContent = targetMember.name;
      document.getElementById('confirmCurrentPoints').textContent = targetMember.currentPoints;
      document.getElementById('confirmType').textContent = adjustType === 'add' ? 'â• å¢åŠ ' : 'â– æ‰£é™¤';
      document.getElementById('confirmAmount').textContent = points;
      document.getElementById('confirmNewPoints').textContent = newPoints;
      document.getElementById('confirmReason').textContent = reason;
      
      document.getElementById('confirmModal').classList.add('active');
    });
  }
});

// ç¢ºèªèª¿æ•´
async function confirmAdjust() {
  closeModal();
  
  const btn = document.getElementById('adjustBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-small"></span> è™•ç†ä¸­...';
  
  try {
    const params = new URLSearchParams({
      action: 'adjust-points',
      lineUserId: adjustData.lineUserId,
      points: adjustData.points,
      reason: adjustData.reason
    });
    
    const res = await fetch(`${API_URL}?${params.toString()}`, {
      method: 'GET'
    });
    
    const data = await res.json();
    
    if (data.success) {
      showMessage('adjustMessage', 'âœ… èª¿æ•´æˆåŠŸï¼æ–°é»æ•¸ï¼š' + data.newPoints, 'success');
      
      // é‡ç½®è¡¨å–®
      document.getElementById('adjustPointsForm').reset();
      document.getElementById('memberInfo').innerHTML = '';
      targetMember = null;
      
      // å¦‚æœåœ¨æœƒå“¡åˆ—è¡¨ï¼Œé‡æ–°è¼‰å…¥
      loadMembers();
    } else {
      showMessage('adjustMessage', 'âŒ ' + (data.message || 'èª¿æ•´å¤±æ•—'), 'error');
    }
  } catch (error) {
    console.error('èª¿æ•´éŒ¯èª¤:', error);
    showMessage('adjustMessage', 'âŒ ç³»çµ±éŒ¯èª¤: ' + error.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="btn-icon">ğŸ’°</span> ç¢ºèªèª¿æ•´';
  }
}

// é—œé–‰ Modal
function closeModal() {
  document.getElementById('confirmModal').classList.remove('active');
}

// é¡¯ç¤ºè¨Šæ¯
function showMessage(elementId, msg, type) {
  const messageDiv = document.getElementById(elementId);
  messageDiv.textContent = msg;
  messageDiv.className = `message ${type}`;
  messageDiv.style.display = 'block';
  
  setTimeout(() => {
    messageDiv.style.display = 'none';
  }, 5000);
}

// ğŸ è¼‰å…¥æ¨è–¦çµ±è¨ˆ
async function loadReferralStats() {
  try {
    const res = await fetch(`${API_URL}?action=referral-stats`);
    const data = await res.json();
    
    if (data.success) {
      // æ›´æ–°ç¸½è¦½å¡ç‰‡
      document.getElementById('totalReferrals').textContent = data.totalReferrals || 0;
      document.getElementById('activeReferrers').textContent = data.activeReferrers || 0;
      document.getElementById('totalReferralRewards').textContent = (data.totalRewards || 0) + ' é»';
      document.getElementById('avgReferrals').textContent = (data.avgReferrals || 0).toFixed(1);
      
      // æ›´æ–°å„€è¡¨æ¿å¡ç‰‡
      document.getElementById('dashboardReferrals').textContent = data.totalReferrals || 0;
      document.getElementById('dashboardActiveReferrers').textContent = data.activeReferrers || 0;
      
      // æ¸²æŸ“æ¨è–¦æ’è¡Œæ¦œ
      renderReferralLeaderboard(data.leaderboard || []);
      
      // æ¸²æŸ“æœ€è¿‘æ¨è–¦è¨˜éŒ„
      renderRecentReferrals(data.recentReferrals || []);
    }
  } catch (error) {
    console.error('è¼‰å…¥æ¨è–¦çµ±è¨ˆéŒ¯èª¤:', error);
  }
}

// æ¸²æŸ“æ¨è–¦æ’è¡Œæ¦œ
function renderReferralLeaderboard(leaderboard) {
  const tbody = document.getElementById('referralLeaderboard');
  
  if (!leaderboard || leaderboard.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;">æš«ç„¡æ¨è–¦è¨˜éŒ„</td></tr>';
    return;
  }
  
  tbody.innerHTML = leaderboard.map((item, index) => {
    const rankIcon = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : (index + 1);
    return `
      <tr>
        <td style="text-align:center; font-size:20px;"><strong>${rankIcon}</strong></td>
        <td><strong>${item.name}</strong></td>
        <td><code style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${item.referralCode}</code></td>
        <td><strong style="color: #667eea; font-size: 18px;">${item.count}</strong> äºº</td>
        <td><strong style="color: #4CAF50;">${item.earned || 0}</strong> é»</td>
        <td class="action-btns">
          <button class="btn-small" style="background: #667eea; color: white;" onclick='viewMemberReferrals("${item.referralCode}", "${item.name}")'>æŸ¥çœ‹è©³æƒ…</button>
        </td>
      </tr>
    `;
  }).join('');
}

// æ¸²æŸ“æœ€è¿‘æ¨è–¦è¨˜éŒ„
function renderRecentReferrals(referrals) {
  const tbody = document.getElementById('recentReferrals');
  
  if (!referrals || referrals.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;">æš«ç„¡æ¨è–¦è¨˜éŒ„</td></tr>';
    return;
  }
  
  tbody.innerHTML = referrals.map(item => `
    <tr>
      <td><strong>${item.referrerName}</strong></td>
      <td><code style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${item.referralCode}</code></td>
      <td><strong>${item.newMemberName}</strong></td>
      <td><strong style="color: #4CAF50;">${item.rewardPoints || 50}</strong> é»</td>
      <td>${formatDate(item.createdAt)}</td>
    </tr>
  `).join('');
}

// æŸ¥çœ‹æœƒå“¡æ¨è–¦è©³æƒ…
function viewMemberReferrals(referralCode, name) {
  alert(`æŸ¥çœ‹ ${name} (${referralCode}) çš„æ¨è–¦è©³æƒ…\n\nåŠŸèƒ½é–‹ç™¼ä¸­...`);
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateString) {
  if (!dateString) return '-';
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
}

// è¼‰å…¥è¨­å®š
async function loadSettings() {
  // TODO: å¾ Settings å·¥ä½œè¡¨è®€å–
  console.log('è¼‰å…¥è¨­å®š...');
}

// å„²å­˜è¨­å®š
async function saveSettings() {
  showMessage('settingsMessage', 'è¨­å®šå„²å­˜åŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
}

// åŸ·è¡Œæ¯æ—¥çµ±è¨ˆ
async function runDailyStats() {
  showMessage('statsMessage', 'æ¯æ—¥çµ±è¨ˆåŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
}

// è¼”åŠ©å‡½æ•¸
function getLevelIcon(level) {
  const icons = {
    'BRONZE': 'ğŸ¥‰',
    'SILVER': 'ğŸ¥ˆ',
    'GOLD': 'ğŸ¥‡',
    'PLATINUM': 'ğŸ’'
  };
  return icons[level] || 'ğŸ¥‰';
}

function getLevelName(level) {
  const names = {
    'BRONZE': 'éŠ…ç´š',
    'SILVER': 'éŠ€ç´š',
    'GOLD': 'é‡‘ç´š',
    'PLATINUM': 'ç™½é‡‘'
  };
  return names[level] || 'éŠ…ç´š';
}

initLiff();
</script>
</body>
</html>

