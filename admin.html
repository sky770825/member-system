<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç®¡ç†å¾Œå°</title>
<link rel="stylesheet" href="./assets/style.css">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  .admin-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    text-align: center;
  }
  .admin-header h1 {
    margin: 0;
    font-size: 28px;
  }
  .admin-header p {
    margin: 5px 0 0 0;
    opacity: 0.9;
  }
  .admin-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    overflow-x: auto;
  }
  .tab {
    padding: 12px 24px;
    background: #f5f5f5;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    white-space: nowrap;
  }
  .tab:hover {
    background: #e0e0e0;
  }
  .tab.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
    animation: fadeIn 0.3s;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .stat-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
  }
  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    text-align: center;
  }
  .stat-icon {
    font-size: 36px;
    margin-bottom: 10px;
  }
  .stat-label {
    color: #666;
    font-size: 14px;
    margin-bottom: 5px;
  }
  .stat-value {
    font-size: 32px;
    font-weight: bold;
    color: #333;
  }
  .member-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .member-table thead {
    background: #667eea;
    color: white;
  }
  .member-table th,
  .member-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #f0f0f0;
  }
  .member-table tbody tr:hover {
    background: #f8f9fa;
  }
  .level-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }
  .level-BRONZE {
    background: #CD7F32;
    color: white;
  }
  .level-SILVER {
    background: #C0C0C0;
    color: #333;
  }
  .level-GOLD {
    background: #FFD700;
    color: #333;
  }
  .level-PLATINUM {
    background: #E5E4E2;
    color: #333;
  }
  .action-btns {
    display: flex;
    gap: 5px;
  }
  .btn-small {
    padding: 6px 12px;
    font-size: 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
  }
  .btn-add {
    background: #4CAF50;
    color: white;
  }
  .btn-deduct {
    background: #f44336;
    color: white;
  }
  .btn-small:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  .search-box {
    margin-bottom: 20px;
  }
  .search-box input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
  }
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .modal.active {
    display: flex;
  }
  .modal-content {
    background: white;
    padding: 30px;
    border-radius: 16px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }
  .modal h3 {
    margin-top: 0;
    color: #333;
  }
  .form-row {
    margin-bottom: 15px;
  }
  .form-row label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #333;
  }
  .form-row input,
  .form-row textarea {
    width: 100%;
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
  }
  .modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }
</style>
</head>
<body>
<div class="container">
  <div class="admin-header">
    <h1>ğŸ› ï¸ ç®¡ç†å¾Œå°</h1>
    <p>æœƒå“¡ç³»çµ±ç®¡ç†ä¸­å¿ƒ</p>
  </div>
  
  <!-- ç®¡ç†å“¡é©—è­‰ -->
  <div id="authCheck" class="loading" style="text-align: center; padding: 40px;">
    <div class="spinner"></div>
    <p style="margin-top: 15px; color: #666;">é©—è­‰ç®¡ç†å“¡èº«åˆ†...</p>
  </div>
  
  <!-- ä¸»å…§å®¹ -->
  <div id="mainContent" style="display: none;">
    <!-- åˆ†é æ¨™ç±¤ -->
    <div class="admin-tabs">
      <button class="tab active" onclick="switchTab('dashboard')">ğŸ“Š å„€è¡¨æ¿</button>
      <button class="tab" onclick="switchTab('members')">ğŸ‘¥ æœƒå“¡ç®¡ç†</button>
      <button class="tab" onclick="switchTab('referrals')">ğŸ æ¨è–¦çµ±è¨ˆ</button>
      <button class="tab" onclick="switchTab('points')">ğŸ’° é»æ•¸èª¿æ•´</button>
      <button class="tab" onclick="switchTab('settings')">âš™ï¸ ç³»çµ±è¨­å®š</button>
      <button class="tab" onclick="switchTab('stats')">ğŸ“ˆ çµ±è¨ˆå ±è¡¨</button>
    </div>
    
    <!-- å„€è¡¨æ¿ -->
    <div id="dashboard" class="tab-content active">
      <h2>ç³»çµ±ç¸½è¦½</h2>
      <div class="stat-cards" id="statCards">
        <div class="stat-card">
          <div class="stat-icon">ğŸ‘¥</div>
          <div class="stat-label">ç¸½æœƒå“¡æ•¸</div>
          <div class="stat-value" id="totalMembers">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-label">ç¸½é»æ•¸</div>
          <div class="stat-value" id="totalPoints">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“Š</div>
          <div class="stat-label">ç¸½äº¤æ˜“æ•¸</div>
          <div class="stat-value" id="totalTransactions">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ†•</div>
          <div class="stat-label">ä»Šæ—¥æ–°å¢</div>
          <div class="stat-value" id="todayNewMembers">--</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          <div class="stat-icon">ğŸ</div>
          <div class="stat-label" style="color: rgba(255,255,255,0.9);">æ¨è–¦äººæ•¸</div>
          <div class="stat-value" id="dashboardReferrals" style="color: white;">--</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
          <div class="stat-icon">ğŸ†</div>
          <div class="stat-label" style="color: rgba(255,255,255,0.9);">æ´»èºæ¨è–¦äºº</div>
          <div class="stat-value" id="dashboardActiveReferrers" style="color: white;">--</div>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="loadDashboard()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
    </div>
    
    <!-- æœƒå“¡ç®¡ç† -->
    <div id="members" class="tab-content">
      <h2>æœƒå“¡åˆ—è¡¨</h2>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="æœå°‹å§“åã€æ‰‹æ©Ÿè™Ÿç¢¼..." onkeyup="filterMembers()">
        <div id="memberCount" style="margin-top: 10px; color: #666; font-size: 14px;">
          è¼‰å…¥ä¸­...
        </div>
      </div>
      
      <div style="overflow-x: auto;">
        <table class="member-table">
          <thead>
            <tr>
              <th>å§“å</th>
              <th>æ‰‹æ©Ÿ</th>
              <th>é»æ•¸</th>
              <th>ç­‰ç´š</th>
              <th>æ¨è–¦ç¢¼</th>
              <th>è¢«èª°æ¨è–¦</th>
              <th>æ¨è–¦äººæ•¸</th>
              <th>ç‹€æ…‹</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="membersList">
            <tr>
              <td colspan="9" style="text-align: center; padding: 40px;">
                <div class="spinner-small"></div>
                <p>è¼‰å…¥ä¸­...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <button class="btn btn-primary" onclick="loadMembers()" style="margin-top: 20px;">ğŸ”„ é‡æ–°è¼‰å…¥</button>
    </div>
    
    <!-- ğŸ æ¨è–¦çµ±è¨ˆ -->
    <div id="referrals" class="tab-content">
      <h2>ğŸ æ¨è–¦ç³»çµ±çµ±è¨ˆ</h2>
      
      <!-- æ¨è–¦ç¸½è¦½å¡ç‰‡ -->
      <div class="stat-cards">
        <div class="stat-card">
          <div class="stat-icon">ğŸ‘¥</div>
          <div class="stat-label">ç¸½æ¨è–¦äººæ•¸</div>
          <div class="stat-value" id="totalReferrals">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ¯</div>
          <div class="stat-label">æ´»èºæ¨è–¦äºº</div>
          <div class="stat-value" id="activeReferrers">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-label">æ¨è–¦ç¸½çå‹µ</div>
          <div class="stat-value" id="totalReferralRewards">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“ˆ</div>
          <div class="stat-label">å¹³å‡æ¨è–¦æ•¸</div>
          <div class="stat-value" id="avgReferrals">--</div>
        </div>
      </div>
      
      <!-- æ¨è–¦æ’è¡Œæ¦œ -->
      <div class="register-card" style="margin-bottom: 20px;">
        <h3 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
          <span>ğŸ†</span>
          <span>æ¨è–¦æ’è¡Œæ¦œ Top 10</span>
        </h3>
        <div style="overflow-x: auto;">
          <table class="member-table">
            <thead>
              <tr>
                <th style="width: 60px;">æ’å</th>
                <th>æœƒå“¡å§“å</th>
                <th>æ¨è–¦ç¢¼</th>
                <th>æ¨è–¦äººæ•¸</th>
                <th>ç²å¾—çå‹µ</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="referralLeaderboard">
              <tr>
                <td colspan="6" style="text-align: center; padding: 40px;">
                  <div class="spinner-small"></div>
                  <p>è¼‰å…¥ä¸­...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- æœ€è¿‘æ¨è–¦è¨˜éŒ„ -->
      <div class="register-card">
        <h3 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
          <span>ğŸ“‹</span>
          <span>æœ€è¿‘æ¨è–¦è¨˜éŒ„</span>
        </h3>
        <div style="overflow-x: auto;">
          <table class="member-table">
            <thead>
              <tr>
                <th>æ¨è–¦äºº</th>
                <th>æ¨è–¦ç¢¼</th>
                <th>æ–°æœƒå“¡</th>
                <th>çå‹µé»æ•¸</th>
                <th>æ¨è–¦æ™‚é–“</th>
              </tr>
            </thead>
            <tbody id="recentReferrals">
              <tr>
                <td colspan="5" style="text-align: center; padding: 40px;">
                  <div class="spinner-small"></div>
                  <p>è¼‰å…¥ä¸­...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="loadReferralStats()" style="margin-top: 20px;">ğŸ”„ é‡æ–°è¼‰å…¥</button>
    </div>
    
    <!-- é»æ•¸èª¿æ•´ -->
    <div id="points" class="tab-content">
      <h2>èª¿æ•´æœƒå“¡é»æ•¸</h2>
      
      <form id="adjustPointsForm" class="register-card">
        <div class="form-group">
          <label for="targetPhone">æœƒå“¡æ‰‹æ©Ÿè™Ÿç¢¼ *</label>
          <input type="tel" id="targetPhone" required placeholder="0912-345-678" pattern="[0-9]{4}-[0-9]{3}-[0-9]{3}">
          <div id="memberInfo" class="receiver-info"></div>
        </div>
        
        <div class="form-group">
          <label>æ“ä½œé¡å‹ *</label>
          <div style="display: flex; gap: 10px; margin-top: 8px;">
            <label style="flex: 1;">
              <input type="radio" name="adjustType" value="add" checked>
              <span style="margin-left: 8px;">â• å¢åŠ é»æ•¸</span>
            </label>
            <label style="flex: 1;">
              <input type="radio" name="adjustType" value="deduct">
              <span style="margin-left: 8px;">â– æ‰£é™¤é»æ•¸</span>
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label for="adjustPoints">é»æ•¸æ•¸é‡ *</label>
          <input type="number" id="adjustPoints" required placeholder="è«‹è¼¸å…¥é»æ•¸" min="1">
          <div style="display: flex; gap: 8px; margin-top: 10px;">
            <button type="button" class="btn-quick" onclick="setAdjustAmount(50)">50</button>
            <button type="button" class="btn-quick" onclick="setAdjustAmount(100)">100</button>
            <button type="button" class="btn-quick" onclick="setAdjustAmount(500)">500</button>
            <button type="button" class="btn-quick" onclick="setAdjustAmount(1000)">1000</button>
          </div>
        </div>
        
        <div class="form-group">
          <label for="reason">èª¿æ•´åŸå›  *</label>
          <textarea id="reason" required placeholder="è«‹èªªæ˜èª¿æ•´é»æ•¸çš„åŸå› ..." rows="3"></textarea>
        </div>
        
        <button type="submit" class="btn btn-primary btn-large" id="adjustBtn">
          <span class="btn-icon">ğŸ’°</span>
          ç¢ºèªèª¿æ•´
        </button>
      </form>
      
      <div id="adjustMessage" class="message"></div>
    </div>
    
    <!-- ç³»çµ±è¨­å®š -->
    <div id="settings" class="tab-content">
      <h2>ç³»çµ±è¨­å®š</h2>
      
      <div class="register-card">
        <div class="form-group">
          <label>è¨»å†Šè´ˆé€é»æ•¸</label>
          <input type="number" id="settingInitialPoints" value="100">
        </div>
        
        <div class="form-group">
          <label>é»æ•¸æœ‰æ•ˆå¤©æ•¸ï¼ˆ0=æ°¸ä¹…ï¼‰</label>
          <input type="number" id="settingExpiryDays" value="365">
        </div>
        
        <div class="form-group">
          <label>æœ€å°è½‰é»æ•¸é‡</label>
          <input type="number" id="settingMinTransfer" value="1">
        </div>
        
        <div class="form-group">
          <label>æœ€å¤§è½‰é»æ•¸é‡</label>
          <input type="number" id="settingMaxTransfer" value="10000">
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="settingMaintenance">
            <span style="margin-left: 8px;">ç¶­è­·æ¨¡å¼ï¼ˆé—œé–‰è¨»å†ŠåŠŸèƒ½ï¼‰</span>
          </label>
        </div>
        
        <button class="btn btn-primary btn-large" onclick="saveSettings()">
          <span class="btn-icon">ğŸ’¾</span>
          å„²å­˜è¨­å®š
        </button>
      </div>
      
      <div id="settingsMessage" class="message"></div>
    </div>
    
    <!-- çµ±è¨ˆå ±è¡¨ -->
    <div id="stats" class="tab-content">
      <h2>æ•¸æ“šçµ±è¨ˆ</h2>
      
      <div class="register-card">
        <h3>ä»Šæ—¥æ•¸æ“š</h3>
        <div class="stat-cards">
          <div class="stat-card">
            <div class="stat-icon">ğŸ†•</div>
            <div class="stat-label">æ–°å¢æœƒå“¡</div>
            <div class="stat-value" id="statNewMembers">--</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ’¸</div>
            <div class="stat-label">äº¤æ˜“ç­†æ•¸</div>
            <div class="stat-value" id="statTransactions">--</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ“¤</div>
            <div class="stat-label">ç™¼å‡ºé»æ•¸</div>
            <div class="stat-value" id="statIssued">--</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ“¥</div>
            <div class="stat-label">æ¶ˆè²»é»æ•¸</div>
            <div class="stat-value" id="statRedeemed">--</div>
          </div>
        </div>
        
        <button class="btn btn-primary" onclick="runDailyStats()">
          <span class="btn-icon">ğŸ“Š</span>
          åŸ·è¡Œæ¯æ—¥çµ±è¨ˆ
        </button>
      </div>
      
      <div id="statsMessage" class="message"></div>
    </div>
  </div>
</div>

<!-- èª¿æ•´é»æ•¸ç¢ºèªè¦–çª— -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h3>ç¢ºèªèª¿æ•´é»æ•¸</h3>
    <div class="confirm-details">
      <p><strong>æœƒå“¡ï¼š</strong><span id="confirmMember"></span></p>
      <p><strong>ç›®å‰é»æ•¸ï¼š</strong><span id="confirmCurrentPoints"></span> é»</p>
      <p><strong>èª¿æ•´é¡å‹ï¼š</strong><span id="confirmType"></span></p>
      <p><strong>èª¿æ•´æ•¸é‡ï¼š</strong><span id="confirmAmount"></span> é»</p>
      <p><strong>èª¿æ•´å¾Œï¼š</strong><span id="confirmNewPoints"></span> é»</p>
      <p><strong>åŸå› ï¼š</strong><span id="confirmReason"></span></p>
    </div>
    <div class="modal-buttons">
      <button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="confirmAdjust()">ç¢ºèªåŸ·è¡Œ</button>
    </div>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzMUwqroi_W_5m7rcjVs-U-o6tEo9W0327BeMmU38Rxinmycd5d1HyyF3BnugGvNF6r/exec';

// ç®¡ç†å“¡ç™½åå–®ï¼ˆLINE User IDï¼‰
const ADMIN_USERS = [
  'YOUR_LINE_USER_ID',  // æ›¿æ›ç‚ºæ‚¨çš„ LINE User ID
  // å¯ä»¥åŠ å…¥æ›´å¤šç®¡ç†å“¡
];

let currentAdmin = null;
let allMembers = [];
let targetMember = null;
let adjustData = null;

async function initLiff() {
  try {
    await liff.init({ liffId: "2008231108-2PDbO5qk" }); // æš«æ™‚ä½¿ç”¨æœƒå“¡ä¸­å¿ƒçš„ LIFF ID
    
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    
    const profile = await liff.getProfile();
    currentAdmin = profile;
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
    if (!ADMIN_USERS.includes(profile.userId)) {
      document.getElementById('authCheck').innerHTML = `
        <div class="error-card">
          <div class="error-icon">ğŸš«</div>
          <h3>ç„¡æ¬Šé™è¨ªå•</h3>
          <p>æ‚¨ä¸æ˜¯ç³»çµ±ç®¡ç†å“¡</p>
          <button class="btn btn-primary" onclick="liff.closeWindow()">é—œé–‰</button>
        </div>
      `;
      return;
    }
    
    // ç®¡ç†å“¡é©—è­‰é€šé
    document.getElementById('authCheck').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    
    // è¼‰å…¥å„€è¡¨æ¿
    loadDashboard();
    
  } catch (error) {
    console.error('LIFF åˆå§‹åŒ–éŒ¯èª¤:', error);
    document.getElementById('authCheck').innerHTML = `
      <div class="error-card">
        <div class="error-icon">âŒ</div>
        <h3>è¼‰å…¥å¤±æ•—</h3>
        <p>${error.message}</p>
      </div>
    `;
  }
}

// åˆ‡æ›åˆ†é 
function switchTab(tabName) {
  // æ›´æ–°æ¨™ç±¤æ¨£å¼
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  
  // æ›´æ–°å…§å®¹
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  
  // è¼‰å…¥å°æ‡‰è³‡æ–™
  if (tabName === 'dashboard') loadDashboard();
  if (tabName === 'members') loadMembers();
  if (tabName === 'referrals') loadReferralStats();
  if (tabName === 'settings') loadSettings();
}

// è¼‰å…¥å„€è¡¨æ¿
async function loadDashboard() {
  try {
    const res = await fetch(`${API_URL}?action=admin-stats`);
    const data = await res.json();
    
    if (data.success) {
      document.getElementById('totalMembers').textContent = data.stats.totalMembers || 0;
      document.getElementById('totalPoints').textContent = data.stats.totalPoints || 0;
      document.getElementById('totalTransactions').textContent = data.stats.totalTransactions || 0;
      document.getElementById('todayNewMembers').textContent = data.stats.todayNewMembers || 0;
    }
  } catch (error) {
    console.error('è¼‰å…¥å„€è¡¨æ¿éŒ¯èª¤:', error);
  }
}

// è¼‰å…¥æœƒå“¡åˆ—è¡¨
async function loadMembers() {
  const tbody = document.getElementById('membersList');
  const countDiv = document.getElementById('memberCount');
  
  try {
    // é¡¯ç¤ºè¼‰å…¥ä¸­
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;"><div class="spinner"></div><p style="margin-top:15px;color:#666;">è¼‰å…¥æœƒå“¡è³‡æ–™ä¸­...</p></td></tr>';
    if (countDiv) countDiv.innerHTML = 'è¼‰å…¥ä¸­...';
    
    const res = await fetch(`${API_URL}?action=admin-members`);
    const data = await res.json();
    
    if (data.success) {
      allMembers = data.members;
      // æ¸…ç©ºæœå°‹æ¡†
      const searchInput = document.getElementById('searchInput');
      if (searchInput) searchInput.value = '';
      // æ¸²æŸ“æœƒå“¡åˆ—è¡¨
      renderMembers(allMembers);
    } else {
      tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:#f44336;">âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦</td></tr>';
    }
  } catch (error) {
    console.error('è¼‰å…¥æœƒå“¡éŒ¯èª¤:', error);
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:#f44336;">âŒ ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£ç·š</td></tr>';
  }
}

// æ¸²æŸ“æœƒå“¡åˆ—è¡¨ï¼ˆå„ªåŒ–ç‰ˆï¼‰
function renderMembers(members) {
  const tbody = document.getElementById('membersList');
  
  if (!members || members.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;">æš«ç„¡æœƒå“¡è³‡æ–™</td></tr>';
    return;
  }
  
  // ä½¿ç”¨ DocumentFragment æ¸›å°‘é‡æ’æ¬¡æ•¸
  const fragment = document.createDocumentFragment();
  const tempDiv = document.createElement('div');
  
  // æ‰¹é‡ç”Ÿæˆ HTML
  tempDiv.innerHTML = members.map(m => `
    <tr>
      <td>${m.name}</td>
      <td>${m.phone}</td>
      <td><strong>${m.points}</strong></td>
      <td><span class="level-badge level-${m.memberLevel || 'BRONZE'}">${getLevelIcon(m.memberLevel)} ${getLevelName(m.memberLevel)}</span></td>
      <td><code style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${m.referralCode || 'N/A'}</code></td>
      <td>${m.referredBy ? `<code style="background: #fff3cd; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: #856404;">ğŸ ${m.referredBy}</code>` : '<span style="color: #999;">-</span>'}</td>
      <td><strong style="color: #667eea;">${m.referralCount || 0}</strong> äºº</td>
      <td>${m.status === 'active' ? 'âœ… æ­£å¸¸' : 'âš ï¸ åœç”¨'}</td>
      <td class="action-btns">
        <button class="btn-small btn-add" onclick='adjustMemberPoints("${m.lineUserId}", "${m.name}", ${m.points}, "add")'>â•</button>
        <button class="btn-small btn-deduct" onclick='adjustMemberPoints("${m.lineUserId}", "${m.name}", ${m.points}, "deduct")'>â–</button>
      </td>
    </tr>
  `).join('');
  
  // ä¸€æ¬¡æ€§æ›¿æ›ï¼Œæ¸›å°‘é‡ç¹ª
  tbody.innerHTML = tempDiv.innerHTML;
  
  // é¡¯ç¤ºæœƒå“¡æ•¸é‡
  updateMemberCount(members.length);
}

// é˜²æŠ–å‡½æ•¸ - é¿å…é »ç¹è§¸ç™¼
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// ç¯©é¸æœƒå“¡ï¼ˆå¯¦éš›åŸ·è¡Œï¼‰
function doFilterMembers() {
  const tbody = document.getElementById('membersList');
  const keyword = document.getElementById('searchInput').value.toLowerCase();
  
  // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
  if (keyword) {
    tbody.style.opacity = '0.6';
  }
  
  // ä½¿ç”¨ requestAnimationFrame å„ªåŒ–æ¸²æŸ“
  requestAnimationFrame(() => {
    const filtered = allMembers.filter(m => 
      m.name.toLowerCase().includes(keyword) || 
      m.phone.includes(keyword)
    );
    renderMembers(filtered);
    tbody.style.opacity = '1';
  });
}

// é˜²æŠ–ç‰ˆæœ¬çš„ç¯©é¸å‡½æ•¸ï¼ˆ300ms å»¶é²ï¼‰
const filterMembers = debounce(doFilterMembers, 300);

// æ›´æ–°æœƒå“¡æ•¸é‡é¡¯ç¤º
function updateMemberCount(count) {
  const countDiv = document.getElementById('memberCount');
  if (countDiv) {
    const total = allMembers ? allMembers.length : 0;
    if (count === total) {
      countDiv.innerHTML = `ğŸ“‹ å…± <strong>${total}</strong> ä½æœƒå“¡`;
    } else {
      countDiv.innerHTML = `ğŸ” é¡¯ç¤º <strong>${count}</strong> ä½æœƒå“¡ï¼ˆå…± ${total} ä½ï¼‰`;
    }
  }
}

// èª¿æ•´æœƒå“¡é»æ•¸
function adjustMemberPoints(lineUserId, name, currentPoints, type) {
  document.getElementById('targetPhone').value = '';
  document.getElementById('adjustPoints').value = '';
  document.getElementById('reason').value = '';
  
  targetMember = { lineUserId, name, currentPoints, type };
  
  // åˆ‡æ›åˆ°é»æ•¸èª¿æ•´åˆ†é 
  switchTab('points');
  document.querySelectorAll('.tab')[2].click();
  
  // é å¡«è³‡è¨Š
  document.getElementById('memberInfo').innerHTML = `
    <div style="padding: 10px; background: #e3f2fd; border-radius: 8px; margin-top: 10px;">
      <strong>${name}</strong><br>
      ç›®å‰é»æ•¸ï¼š${currentPoints} é»
    </div>
  `;
  
  // è¨­å®šæ“ä½œé¡å‹
  document.querySelector(`input[value="${type}"]`).checked = true;
}

// æª¢æŸ¥æœƒå“¡
document.addEventListener('DOMContentLoaded', function() {
  const phoneInput = document.getElementById('targetPhone');
  if (phoneInput) {
    phoneInput.addEventListener('blur', async function() {
      const phone = this.value;
      if (!phone) return;
      
      try {
        const res = await fetch(`${API_URL}?action=check-user&phone=${phone}`);
        const data = await res.json();
        
        const infoDiv = document.getElementById('memberInfo');
        if (data.exists) {
          targetMember = {
            lineUserId: data.lineUserId,
            name: data.name,
            currentPoints: data.points || 0
          };
          infoDiv.innerHTML = `
            <div style="padding: 10px; background: #e8f5e9; border-radius: 8px; margin-top: 10px;">
              âœ“ <strong>${data.name}</strong><br>
              ç›®å‰é»æ•¸ï¼š${data.points || 0} é»
            </div>
          `;
        } else {
          targetMember = null;
          infoDiv.innerHTML = `
            <div style="padding: 10px; background: #ffebee; border-radius: 8px; margin-top: 10px;">
              âœ— æŸ¥ç„¡æ­¤æœƒå“¡
            </div>
          `;
        }
      } catch (error) {
        console.error('æŸ¥è©¢éŒ¯èª¤:', error);
      }
    });
    
    // æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼åŒ–
    phoneInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 10) value = value.slice(0, 10);
      
      if (value.length >= 4) {
        value = value.slice(0, 4) + '-' + value.slice(4);
      }
      if (value.length >= 8) {
        value = value.slice(0, 8) + '-' + value.slice(8);
      }
      
      e.target.value = value;
    });
  }
});

// è¨­å®šèª¿æ•´æ•¸é‡
function setAdjustAmount(amount) {
  document.getElementById('adjustPoints').value = amount;
}

// æäº¤èª¿æ•´é»æ•¸è¡¨å–®
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('adjustPointsForm');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!targetMember) {
        showMessage('adjustMessage', 'è«‹å…ˆè¼¸å…¥æœ‰æ•ˆçš„æœƒå“¡æ‰‹æ©Ÿè™Ÿç¢¼', 'error');
        return;
      }
      
      const adjustType = document.querySelector('input[name="adjustType"]:checked').value;
      const points = parseInt(document.getElementById('adjustPoints').value);
      const reason = document.getElementById('reason').value;
      
      if (!points || points < 1) {
        showMessage('adjustMessage', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é»æ•¸', 'error');
        return;
      }
      
      const actualPoints = adjustType === 'add' ? points : -points;
      const newPoints = targetMember.currentPoints + actualPoints;
      
      if (newPoints < 0) {
        showMessage('adjustMessage', 'èª¿æ•´å¾Œé»æ•¸ä¸èƒ½ç‚ºè² æ•¸', 'error');
        return;
      }
      
      // é¡¯ç¤ºç¢ºèªè¦–çª—
      adjustData = {
        lineUserId: targetMember.lineUserId,
        points: actualPoints,
        reason: reason
      };
      
      document.getElementById('confirmMember').textContent = targetMember.name;
      document.getElementById('confirmCurrentPoints').textContent = targetMember.currentPoints;
      document.getElementById('confirmType').textContent = adjustType === 'add' ? 'â• å¢åŠ ' : 'â– æ‰£é™¤';
      document.getElementById('confirmAmount').textContent = points;
      document.getElementById('confirmNewPoints').textContent = newPoints;
      document.getElementById('confirmReason').textContent = reason;
      
      document.getElementById('confirmModal').classList.add('active');
    });
  }
});

// ç¢ºèªèª¿æ•´
async function confirmAdjust() {
  closeModal();
  
  const btn = document.getElementById('adjustBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-small"></span> è™•ç†ä¸­...';
  
  try {
    const params = new URLSearchParams({
      action: 'adjust-points',
      lineUserId: adjustData.lineUserId,
      points: adjustData.points,
      reason: adjustData.reason
    });
    
    const res = await fetch(`${API_URL}?${params.toString()}`, {
      method: 'GET'
    });
    
    const data = await res.json();
    
    if (data.success) {
      showMessage('adjustMessage', 'âœ… èª¿æ•´æˆåŠŸï¼æ–°é»æ•¸ï¼š' + data.newPoints, 'success');
      
      // é‡ç½®è¡¨å–®
      document.getElementById('adjustPointsForm').reset();
      document.getElementById('memberInfo').innerHTML = '';
      targetMember = null;
      
      // å¦‚æœåœ¨æœƒå“¡åˆ—è¡¨ï¼Œé‡æ–°è¼‰å…¥
      loadMembers();
    } else {
      showMessage('adjustMessage', 'âŒ ' + (data.message || 'èª¿æ•´å¤±æ•—'), 'error');
    }
  } catch (error) {
    console.error('èª¿æ•´éŒ¯èª¤:', error);
    showMessage('adjustMessage', 'âŒ ç³»çµ±éŒ¯èª¤: ' + error.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="btn-icon">ğŸ’°</span> ç¢ºèªèª¿æ•´';
  }
}

// é—œé–‰ Modal
function closeModal() {
  document.getElementById('confirmModal').classList.remove('active');
}

// é¡¯ç¤ºè¨Šæ¯
function showMessage(elementId, msg, type) {
  const messageDiv = document.getElementById(elementId);
  messageDiv.textContent = msg;
  messageDiv.className = `message ${type}`;
  messageDiv.style.display = 'block';
  
  setTimeout(() => {
    messageDiv.style.display = 'none';
  }, 5000);
}

// ğŸ è¼‰å…¥æ¨è–¦çµ±è¨ˆ
async function loadReferralStats() {
  try {
    const res = await fetch(`${API_URL}?action=referral-stats`);
    const data = await res.json();
    
    if (data.success) {
      // æ›´æ–°ç¸½è¦½å¡ç‰‡
      document.getElementById('totalReferrals').textContent = data.totalReferrals || 0;
      document.getElementById('activeReferrers').textContent = data.activeReferrers || 0;
      document.getElementById('totalReferralRewards').textContent = (data.totalRewards || 0) + ' é»';
      document.getElementById('avgReferrals').textContent = (data.avgReferrals || 0).toFixed(1);
      
      // æ›´æ–°å„€è¡¨æ¿å¡ç‰‡
      document.getElementById('dashboardReferrals').textContent = data.totalReferrals || 0;
      document.getElementById('dashboardActiveReferrers').textContent = data.activeReferrers || 0;
      
      // æ¸²æŸ“æ¨è–¦æ’è¡Œæ¦œ
      renderReferralLeaderboard(data.leaderboard || []);
      
      // æ¸²æŸ“æœ€è¿‘æ¨è–¦è¨˜éŒ„
      renderRecentReferrals(data.recentReferrals || []);
    }
  } catch (error) {
    console.error('è¼‰å…¥æ¨è–¦çµ±è¨ˆéŒ¯èª¤:', error);
  }
}

// æ¸²æŸ“æ¨è–¦æ’è¡Œæ¦œ
function renderReferralLeaderboard(leaderboard) {
  const tbody = document.getElementById('referralLeaderboard');
  
  if (!leaderboard || leaderboard.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;">æš«ç„¡æ¨è–¦è¨˜éŒ„</td></tr>';
    return;
  }
  
  tbody.innerHTML = leaderboard.map((item, index) => {
    const rankIcon = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : (index + 1);
    return `
      <tr>
        <td style="text-align:center; font-size:20px;"><strong>${rankIcon}</strong></td>
        <td><strong>${item.name}</strong></td>
        <td><code style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${item.referralCode}</code></td>
        <td><strong style="color: #667eea; font-size: 18px;">${item.count}</strong> äºº</td>
        <td><strong style="color: #4CAF50;">${item.earned || 0}</strong> é»</td>
        <td class="action-btns">
          <button class="btn-small" style="background: #667eea; color: white;" onclick='viewMemberReferrals("${item.referralCode}", "${item.name}")'>æŸ¥çœ‹è©³æƒ…</button>
        </td>
      </tr>
    `;
  }).join('');
}

// æ¸²æŸ“æœ€è¿‘æ¨è–¦è¨˜éŒ„
function renderRecentReferrals(referrals) {
  const tbody = document.getElementById('recentReferrals');
  
  if (!referrals || referrals.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;">æš«ç„¡æ¨è–¦è¨˜éŒ„</td></tr>';
    return;
  }
  
  tbody.innerHTML = referrals.map(item => `
    <tr>
      <td><strong>${item.referrerName}</strong></td>
      <td><code style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${item.referralCode}</code></td>
      <td><strong>${item.newMemberName}</strong></td>
      <td><strong style="color: #4CAF50;">${item.rewardPoints || 50}</strong> é»</td>
      <td>${formatDate(item.createdAt)}</td>
    </tr>
  `).join('');
}

// æŸ¥çœ‹æœƒå“¡æ¨è–¦è©³æƒ…
function viewMemberReferrals(referralCode, name) {
  alert(`æŸ¥çœ‹ ${name} (${referralCode}) çš„æ¨è–¦è©³æƒ…\n\nåŠŸèƒ½é–‹ç™¼ä¸­...`);
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateString) {
  if (!dateString) return '-';
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
}

// è¼‰å…¥è¨­å®š
async function loadSettings() {
  // TODO: å¾ Settings å·¥ä½œè¡¨è®€å–
  console.log('è¼‰å…¥è¨­å®š...');
}

// å„²å­˜è¨­å®š
async function saveSettings() {
  showMessage('settingsMessage', 'è¨­å®šå„²å­˜åŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
}

// åŸ·è¡Œæ¯æ—¥çµ±è¨ˆ
async function runDailyStats() {
  showMessage('statsMessage', 'æ¯æ—¥çµ±è¨ˆåŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
}

// è¼”åŠ©å‡½æ•¸
function getLevelIcon(level) {
  const icons = {
    'BRONZE': 'ğŸ¥‰',
    'SILVER': 'ğŸ¥ˆ',
    'GOLD': 'ğŸ¥‡',
    'PLATINUM': 'ğŸ’'
  };
  return icons[level] || 'ğŸ¥‰';
}

function getLevelName(level) {
  const names = {
    'BRONZE': 'éŠ…ç´š',
    'SILVER': 'éŠ€ç´š',
    'GOLD': 'é‡‘ç´š',
    'PLATINUM': 'ç™½é‡‘'
  };
  return names[level] || 'éŠ…ç´š';
}

initLiff();
</script>
</body>
</html>

