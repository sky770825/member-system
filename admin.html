<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>管理後台</title>
<link rel="stylesheet" href="./assets/style.css">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  .admin-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 40px 30px;
    border-radius: 16px;
    margin-bottom: 30px;
    text-align: center;
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.25);
    position: relative;
    overflow: hidden;
  }
  .admin-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: pulse 10s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% {
      transform: translate(0, 0) scale(1);
    }
    50% {
      transform: translate(-10%, -10%) scale(1.1);
    }
  }
  .admin-header h1 {
    margin: 0;
    font-size: 32px;
    font-weight: 700;
    position: relative;
    z-index: 1;
  }
  .admin-header p {
    margin: 8px 0 0 0;
    opacity: 0.95;
    font-size: 15px;
    position: relative;
    z-index: 1;
  }
  .admin-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
    overflow-x: auto;
    padding: 4px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    -webkit-overflow-scrolling: touch;
  }
  .tab {
    padding: 12px 20px;
    background: transparent;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s ease;
    white-space: nowrap;
    position: relative;
  }
  .tab:hover:not(.active) {
    background: #f5f5f5;
  }
  .tab.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
    animation: fadeIn 0.3s;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .stat-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
  }
  
  /* 桌面版：3欄佈局 */
  @media (min-width: 1200px) {
    .stat-cards {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  .stat-card {
    background: white;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2);
  }
  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
  }
  .stat-icon {
    font-size: 36px;
    margin-bottom: 10px;
  }
  .stat-label {
    color: #666;
    font-size: 14px;
    margin-bottom: 5px;
  }
  .stat-value {
    font-size: 32px;
    font-weight: bold;
    color: #333;
  }
  .member-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  }
  .member-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  .member-table th {
    padding: 16px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 0.5px;
  }
  .member-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #f0f0f0;
  }
  .member-table tbody tr {
    transition: all 0.2s ease;
  }
  .member-table tbody tr:hover {
    background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%);
    transform: scale(1.005);
  }
  .member-table tbody tr:last-child td {
    border-bottom: none;
  }
  .level-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
  }
  .level-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  .level-BRONZE {
    background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
    color: white;
  }
  .level-SILVER {
    background: linear-gradient(135deg, #C0C0C0 0%, #A8A8A8 100%);
    color: #333;
  }
  .level-GOLD {
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    color: #333;
  }
  .level-PLATINUM {
    background: linear-gradient(135deg, #E5E4E2 0%, #B4B4B4 100%);
    color: #333;
  }
  .action-btns {
    display: flex;
    gap: 5px;
  }
  .btn-small {
    padding: 8px 16px;
    font-size: 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    position: relative;
    overflow: hidden;
  }
  .btn-small:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
  }
  .btn-small::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
  }
  .btn-small:hover::before {
    width: 300px;
    height: 300px;
  }
  .btn-add {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
  }
  .btn-add:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
  }
  .btn-deduct {
    background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
  }
  .btn-deduct:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
  }
  .search-box {
    margin-bottom: 20px;
    position: relative;
  }
  .search-box::before {
    content: '🔍';
    position: absolute;
    left: 16px;
    top: 28px;
    font-size: 18px;
    pointer-events: none;
    z-index: 1;
  }
  .search-box input {
    width: 100%;
    padding: 14px 16px 14px 48px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 14px;
    transition: all 0.3s ease;
  }
  .search-box input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    outline: none;
  }
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .modal.active {
    display: flex;
  }
  .modal-content {
    background: white;
    padding: 30px;
    border-radius: 16px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }
  .modal h3 {
    margin-top: 0;
    color: #333;
  }
  .form-row {
    margin-bottom: 15px;
  }
  .form-row label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #333;
  }
  .form-row input,
  .form-row textarea {
    width: 100%;
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
  }
  .modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }
  
  /* 桌面版佈局優化 */
  @media (min-width: 1400px) {
    .container {
      max-width: 1400px;
    }
    
    /* 儀表板：橫向佈局 */
    .dashboard-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin-top: 20px;
    }
    
    /* 會員管理：側邊欄佈局 */
    .members-layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 24px;
    }
  }
  
  @media (min-width: 1200px) {
    .container {
      max-width: 1200px;
    }
    
    /* 表格優化寬度 */
    .member-table {
      min-width: 1000px;
    }
  }
  
  /* 平板版 */
  @media (min-width: 769px) and (max-width: 1199px) {
    .container {
      max-width: 95%;
    }
    
    .stat-cards {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  
  /* 手機版優化 */
  @media (max-width: 768px) {
    .admin-header {
      padding: 30px 20px;
    }
    .admin-header h1 {
      font-size: 26px;
    }
    .admin-header > div {
      flex-direction: column;
      gap: 15px;
    }
    .admin-header > div > div {
      flex: none !important;
      width: 100%;
      text-align: center !important;
    }
    .admin-tabs {
      gap: 6px;
      padding: 8px;
    }
    .tab {
      padding: 10px 16px;
      font-size: 13px;
    }
    .stat-cards {
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .stat-card {
      padding: 16px;
    }
    .stat-icon {
      font-size: 28px;
    }
    .stat-value {
      font-size: 24px;
    }
    .search-box input {
      font-size: 16px; /* 防止iOS自動縮放 */
    }
    .member-table {
      font-size: 13px;
    }
    .member-table th,
    .member-table td {
      padding: 10px 8px;
    }
  }
  
  @media (max-width: 480px) {
    .container {
      padding: 15px;
    }
    .admin-header {
      padding: 24px 16px;
      margin-bottom: 20px;
    }
    .admin-header h1 {
      font-size: 22px;
    }
    .stat-cards {
      grid-template-columns: 1fr;
      gap: 10px;
    }
  }
  
  /* 載入動畫優化 */
  @keyframes skeletonPulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }
  
  .skeleton-loading {
    animation: skeletonPulse 1.5s ease-in-out infinite;
    background: linear-gradient(
      90deg,
      #f0f0f0 25%,
      #e0e0e0 50%,
      #f0f0f0 75%
    );
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }
  
  @keyframes shimmer {
    0% {
      background-position: -200% 0;
    }
    100% {
      background-position: 200% 0;
    }
  }
</style>
</head>
<body>
<div class="container">
  <div class="admin-header">
    <div style="display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2;">
      <div style="flex: 1;"></div>
      <div style="text-align: center; flex: 2;">
        <h1>🛠️ 管理後台</h1>
        <p>會員系統管理中心</p>
      </div>
      <div style="flex: 1; text-align: right;">
        <button onclick="logout()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s;">
          🚪 登出
        </button>
      </div>
    </div>
  </div>
  
  <!-- 管理員驗證 -->
  <div id="authCheck" class="loading" style="text-align: center; padding: 40px;">
    <div class="spinner"></div>
    <p style="margin-top: 15px; color: #666;">驗證管理員身分...</p>
  </div>
  
  <!-- 主內容 -->
  <div id="mainContent" style="display: none;">
    <!-- 分頁標籤 -->
    <div class="admin-tabs">
      <button class="tab active" onclick="switchTab('dashboard')">📊 儀表板</button>
      <button class="tab" onclick="switchTab('members')">👥 會員管理</button>
      <button class="tab" onclick="switchTab('referrals')">🎁 推薦統計</button>
      <button class="tab" onclick="switchTab('points')">💰 點數調整</button>
      <button class="tab" onclick="switchTab('settings')">⚙️ 系統設定</button>
      <button class="tab" onclick="switchTab('stats')">📈 統計報表</button>
    </div>
    
    <!-- 儀表板 -->
    <div id="dashboard" class="tab-content active">
      <h2>系統總覽</h2>
      <div class="stat-cards" id="statCards">
        <div class="stat-card">
          <div class="stat-icon">👥</div>
          <div class="stat-label">總會員數</div>
          <div class="stat-value" id="totalMembers">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">💰</div>
          <div class="stat-label">總點數</div>
          <div class="stat-value" id="totalPoints">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">📊</div>
          <div class="stat-label">總交易數</div>
          <div class="stat-value" id="totalTransactions">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">🆕</div>
          <div class="stat-label">今日新增</div>
          <div class="stat-value" id="todayNewMembers">--</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          <div class="stat-icon">🎁</div>
          <div class="stat-label" style="color: rgba(255,255,255,0.9);">推薦人數</div>
          <div class="stat-value" id="dashboardReferrals" style="color: white;">--</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
          <div class="stat-icon">🏆</div>
          <div class="stat-label" style="color: rgba(255,255,255,0.9);">活躍推薦人</div>
          <div class="stat-value" id="dashboardActiveReferrers" style="color: white;">--</div>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="loadDashboard()">🔄 重新載入</button>
    </div>
    
    <!-- 會員管理 -->
    <div id="members" class="tab-content">
      <h2>會員列表</h2>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="搜尋姓名、手機號碼..." onkeyup="filterMembers()">
        <div id="memberCount" style="margin-top: 10px; color: #666; font-size: 14px;">
          載入中...
        </div>
      </div>
      
      <div style="overflow-x: auto;">
        <table class="member-table">
          <thead>
            <tr>
              <th>姓名</th>
              <th>手機</th>
              <th>點數</th>
              <th>等級</th>
              <th>推薦碼</th>
              <th>被誰推薦</th>
              <th>推薦人數</th>
              <th>狀態</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="membersList">
            <tr>
              <td colspan="9" style="text-align: center; padding: 40px;">
                <div class="spinner-small"></div>
                <p>載入中...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- 分頁控制 -->
      <div id="pagination" style="display: none; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; flex-wrap: wrap;"></div>
      
      <button class="btn btn-primary" onclick="loadMembers()" style="margin-top: 20px;">🔄 重新載入</button>
    </div>
    
    <!-- 🎁 推薦統計 -->
    <div id="referrals" class="tab-content">
      <h2>🎁 推薦系統統計</h2>
      
      <!-- 推薦總覽卡片 -->
      <div class="stat-cards">
        <div class="stat-card">
          <div class="stat-icon">👥</div>
          <div class="stat-label">總推薦人數</div>
          <div class="stat-value" id="totalReferrals">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">🎯</div>
          <div class="stat-label">活躍推薦人</div>
          <div class="stat-value" id="activeReferrers">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">💰</div>
          <div class="stat-label">推薦總獎勵</div>
          <div class="stat-value" id="totalReferralRewards">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">📈</div>
          <div class="stat-label">平均推薦數</div>
          <div class="stat-value" id="avgReferrals">--</div>
        </div>
      </div>
      
      <!-- 推薦排行榜 -->
      <div class="register-card" style="margin-bottom: 20px;">
        <h3 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
          <span>🏆</span>
          <span>推薦排行榜 Top 10</span>
        </h3>
        <div style="overflow-x: auto;">
          <table class="member-table">
            <thead>
              <tr>
                <th style="width: 60px;">排名</th>
                <th>會員姓名</th>
                <th>推薦碼</th>
                <th>推薦人數</th>
                <th>獲得獎勵</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="referralLeaderboard">
              <tr>
                <td colspan="6" style="text-align: center; padding: 40px;">
                  <div class="spinner-small"></div>
                  <p>載入中...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- 最近推薦記錄 -->
      <div class="register-card">
        <h3 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
          <span>📋</span>
          <span>最近推薦記錄</span>
        </h3>
        <div style="overflow-x: auto;">
          <table class="member-table">
            <thead>
              <tr>
                <th>推薦人</th>
                <th>推薦碼</th>
                <th>新會員</th>
                <th>獎勵點數</th>
                <th>推薦時間</th>
              </tr>
            </thead>
            <tbody id="recentReferrals">
              <tr>
                <td colspan="5" style="text-align: center; padding: 40px;">
                  <div class="spinner-small"></div>
                  <p>載入中...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="loadReferralStats()" style="margin-top: 20px;">🔄 重新載入</button>
    </div>
    
    <!-- 點數調整 -->
    <div id="points" class="tab-content">
      <h2>調整會員點數</h2>
      
      <form id="adjustPointsForm" class="register-card">
        <div class="form-group">
          <label for="targetPhone">會員手機號碼 *</label>
          <input type="tel" id="targetPhone" required placeholder="0912-345-678" pattern="[0-9]{4}-[0-9]{3}-[0-9]{3}">
          <div id="memberInfo" class="receiver-info"></div>
        </div>
        
        <div class="form-group">
          <label>操作類型 *</label>
          <div style="display: flex; gap: 10px; margin-top: 8px;">
            <label style="flex: 1;">
              <input type="radio" name="adjustType" value="add" checked>
              <span style="margin-left: 8px;">➕ 增加點數</span>
            </label>
            <label style="flex: 1;">
              <input type="radio" name="adjustType" value="deduct">
              <span style="margin-left: 8px;">➖ 扣除點數</span>
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label for="adjustPoints">點數數量 *</label>
          <input type="number" id="adjustPoints" required placeholder="請輸入點數" min="1">
          <div style="display: flex; gap: 8px; margin-top: 10px;">
            <button type="button" class="btn-quick" onclick="setAdjustAmount(50)">50</button>
            <button type="button" class="btn-quick" onclick="setAdjustAmount(100)">100</button>
            <button type="button" class="btn-quick" onclick="setAdjustAmount(500)">500</button>
            <button type="button" class="btn-quick" onclick="setAdjustAmount(1000)">1000</button>
          </div>
        </div>
        
        <div class="form-group">
          <label for="reason">調整原因 *</label>
          <textarea id="reason" required placeholder="請說明調整點數的原因..." rows="3"></textarea>
        </div>
        
        <button type="submit" class="btn btn-primary btn-large" id="adjustBtn">
          <span class="btn-icon">💰</span>
          確認調整
        </button>
      </form>
      
      <div id="adjustMessage" class="message"></div>
    </div>
    
    <!-- 系統設定 -->
    <div id="settings" class="tab-content">
      <h2>系統設定</h2>
      
      <div class="register-card">
        <div class="form-group">
          <label>註冊贈送點數</label>
          <input type="number" id="settingInitialPoints" value="100">
        </div>
        
        <div class="form-group">
          <label>點數有效天數（0=永久）</label>
          <input type="number" id="settingExpiryDays" value="365">
        </div>
        
        <div class="form-group">
          <label>最小轉點數量</label>
          <input type="number" id="settingMinTransfer" value="1">
        </div>
        
        <div class="form-group">
          <label>最大轉點數量</label>
          <input type="number" id="settingMaxTransfer" value="10000">
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="settingMaintenance">
            <span style="margin-left: 8px;">維護模式（關閉註冊功能）</span>
          </label>
        </div>
        
        <button class="btn btn-primary btn-large" onclick="saveSettings()">
          <span class="btn-icon">💾</span>
          儲存設定
        </button>
      </div>
      
      <div id="settingsMessage" class="message"></div>
    </div>
    
    <!-- 統計報表 -->
    <div id="stats" class="tab-content">
      <h2>數據統計</h2>
      
      <div class="register-card">
        <h3>今日數據</h3>
        <div class="stat-cards">
          <div class="stat-card">
            <div class="stat-icon">🆕</div>
            <div class="stat-label">新增會員</div>
            <div class="stat-value" id="statNewMembers">--</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">💸</div>
            <div class="stat-label">交易筆數</div>
            <div class="stat-value" id="statTransactions">--</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">📤</div>
            <div class="stat-label">發出點數</div>
            <div class="stat-value" id="statIssued">--</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">📥</div>
            <div class="stat-label">消費點數</div>
            <div class="stat-value" id="statRedeemed">--</div>
          </div>
        </div>
        
        <button class="btn btn-primary" onclick="runDailyStats()">
          <span class="btn-icon">📊</span>
          執行每日統計
        </button>
      </div>
      
      <div id="statsMessage" class="message"></div>
    </div>
  </div>
</div>

<!-- 調整點數確認視窗 -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h3>確認調整點數</h3>
    <div class="confirm-details">
      <p><strong>會員：</strong><span id="confirmMember"></span></p>
      <p><strong>目前點數：</strong><span id="confirmCurrentPoints"></span> 點</p>
      <p><strong>調整類型：</strong><span id="confirmType"></span></p>
      <p><strong>調整數量：</strong><span id="confirmAmount"></span> 點</p>
      <p><strong>調整後：</strong><span id="confirmNewPoints"></span> 點</p>
      <p><strong>原因：</strong><span id="confirmReason"></span></p>
    </div>
    <div class="modal-buttons">
      <button class="btn btn-outline" onclick="closeModal()">取消</button>
      <button class="btn btn-primary" onclick="confirmAdjust()">確認執行</button>
    </div>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwYbhHNlwix-1FQzB63PVKprfiV0Q3CxOLNFuGUWXXnPNPsiN3L5bvkr6id0XyITi_F/exec';

// 管理員白名單（LINE User ID）
const ADMIN_USERS = [
  'YOUR_LINE_USER_ID',  // 替換為您的 LINE User ID
  // 可以加入更多管理員
];

let currentAdmin = null;
let allMembers = [];
let targetMember = null;
let adjustData = null;

// ==================== 快取管理 ====================
const CACHE_KEY = 'admin_session';
const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24小時

// 儲存管理員資訊到快取
function saveAdminCache(profile) {
  const cacheData = {
    profile: profile,
    timestamp: Date.now()
  };
  localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
  console.log('✅ 已儲存管理員快取');
}

// 取得快取的管理員資訊
function getAdminCache() {
  try {
    const cached = localStorage.getItem(CACHE_KEY);
    if (!cached) return null;
    
    const cacheData = JSON.parse(cached);
    const age = Date.now() - cacheData.timestamp;
    
    // 檢查快取是否過期
    if (age > CACHE_DURATION) {
      console.log('⏰ 快取已過期，需要重新登入');
      clearAdminCache();
      return null;
    }
    
    console.log('✅ 使用快取的管理員資訊');
    return cacheData.profile;
  } catch (error) {
    console.error('讀取快取錯誤:', error);
    return null;
  }
}

// 清除快取
function clearAdminCache() {
  localStorage.removeItem(CACHE_KEY);
  console.log('🗑️ 已清除管理員快取');
}

// 顯示快取資訊（開發用）
function showCacheInfo() {
  const cached = localStorage.getItem(CACHE_KEY);
  if (cached) {
    const data = JSON.parse(cached);
    const age = Date.now() - data.timestamp;
    const remaining = CACHE_DURATION - age;
    console.log('📦 快取資訊:', {
      管理員: data.profile.displayName,
      建立時間: new Date(data.timestamp).toLocaleString(),
      剩餘時間: Math.floor(remaining / 1000 / 60) + ' 分鐘'
    });
  } else {
    console.log('❌ 無快取資料');
  }
}

// 登出功能
function logout() {
  if (confirm('確定要登出嗎？登出後需要重新驗證身分。')) {
    clearAdminCache();
    alert('✅ 已成功登出！');
    location.reload();
  }
}

async function initLiff() {
  try {
    // 🔥 優先檢查快取
    const cachedProfile = getAdminCache();
    
    if (cachedProfile) {
      // 使用快取的管理員資訊
      currentAdmin = cachedProfile;
      
      // 檢查是否為管理員
      if (!ADMIN_USERS.includes(cachedProfile.userId)) {
        document.getElementById('authCheck').innerHTML = `
          <div class="error-card">
            <div class="error-icon">🚫</div>
            <h3>無權限訪問</h3>
            <p>您不是系統管理員</p>
            <button class="btn btn-primary" onclick="clearAdminCache(); location.reload();">重新登入</button>
          </div>
        `;
        return;
      }
      
      // 管理員驗證通過（使用快取）
      document.getElementById('authCheck').innerHTML = `
        <div style="text-align: center; padding: 40px; color: #28a745;">
          <div style="font-size: 48px; margin-bottom: 15px;">✅</div>
          <p style="font-size: 16px; margin-top: 10px;">歡迎回來，${cachedProfile.displayName}！</p>
          <p style="font-size: 14px; color: #666; margin-top: 5px;">（使用快取登入）</p>
        </div>
      `;
      
      setTimeout(() => {
        document.getElementById('authCheck').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        loadDashboard();
      }, 1000);
      
      return;
    }
    
    // 🔥 無快取，進行 LIFF 登入
    console.log('🔐 無快取，開始 LIFF 登入...');
    await liff.init({ liffId: "2008231108-2PDbO5qk" });
    
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    
    const profile = await liff.getProfile();
    currentAdmin = profile;
    
    // 檢查是否為管理員
    if (!ADMIN_USERS.includes(profile.userId)) {
      document.getElementById('authCheck').innerHTML = `
        <div class="error-card">
          <div class="error-icon">🚫</div>
          <h3>無權限訪問</h3>
          <p>您不是系統管理員</p>
          <button class="btn btn-primary" onclick="liff.closeWindow()">關閉</button>
        </div>
      `;
      return;
    }
    
    // 🔥 管理員驗證通過，儲存快取
    saveAdminCache(profile);
    
    // 顯示成功訊息
    document.getElementById('authCheck').innerHTML = `
      <div style="text-align: center; padding: 40px; color: #28a745;">
        <div style="font-size: 48px; margin-bottom: 15px;">✅</div>
        <p style="font-size: 16px; margin-top: 10px;">歡迎，${profile.displayName}！</p>
        <p style="font-size: 14px; color: #666; margin-top: 5px;">（已建立快取）</p>
      </div>
    `;
    
    setTimeout(() => {
      document.getElementById('authCheck').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      loadDashboard();
    }, 1000);
    
  } catch (error) {
    console.error('LIFF 初始化錯誤:', error);
    document.getElementById('authCheck').innerHTML = `
      <div class="error-card">
        <div class="error-icon">❌</div>
        <h3>載入失敗</h3>
        <p>${error.message}</p>
        <button class="btn btn-secondary" onclick="clearAdminCache(); location.reload();">清除快取並重試</button>
      </div>
    `;
  }
}

// 切換分頁
function switchTab(tabName) {
  // 更新標籤樣式
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  
  // 更新內容
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  
  // 載入對應資料
  if (tabName === 'dashboard') loadDashboard();
  if (tabName === 'members') loadMembers();
  if (tabName === 'referrals') loadReferralStats();
  if (tabName === 'settings') loadSettings();
}

// 載入儀表板
async function loadDashboard() {
  try {
    const res = await fetch(`${API_URL}?action=admin-stats`);
    const data = await res.json();
    
    if (data.success) {
      document.getElementById('totalMembers').textContent = data.stats.totalMembers || 0;
      document.getElementById('totalPoints').textContent = data.stats.totalPoints || 0;
      document.getElementById('totalTransactions').textContent = data.stats.totalTransactions || 0;
      document.getElementById('todayNewMembers').textContent = data.stats.todayNewMembers || 0;
    }
  } catch (error) {
    console.error('載入儀表板錯誤:', error);
  }
}

// 載入會員列表
async function loadMembers() {
  const tbody = document.getElementById('membersList');
  const countDiv = document.getElementById('memberCount');
  
  try {
    // 顯示載入中
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;"><div class="spinner"></div><p style="margin-top:15px;color:#666;">載入會員資料中...</p></td></tr>';
    if (countDiv) countDiv.innerHTML = '載入中...';
    
    const res = await fetch(`${API_URL}?action=admin-members`);
    const data = await res.json();
    
    if (data.success) {
      allMembers = data.members;
      // 清空搜尋框
      const searchInput = document.getElementById('searchInput');
      if (searchInput) searchInput.value = '';
      // 渲染會員列表
      renderMembers(allMembers);
    } else {
      tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:#f44336;">❌ 載入失敗，請重試</td></tr>';
    }
  } catch (error) {
    console.error('載入會員錯誤:', error);
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:#f44336;">❌ 網路錯誤，請檢查連線</td></tr>';
  }
}

// ==================== 分頁管理 ====================
let currentPage = 1;
const itemsPerPage = 20; // 每頁顯示 20 筆
let filteredMembers = [];

// 渲染會員列表（分頁優化版）
function renderMembers(members) {
  const tbody = document.getElementById('membersList');
  
  if (!members || members.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;">暫無會員資料</td></tr>';
    hidePagination();
    return;
  }
  
  filteredMembers = members;
  const totalPages = Math.ceil(members.length / itemsPerPage);
  
  // 確保當前頁面在有效範圍內
  if (currentPage > totalPages) currentPage = totalPages;
  if (currentPage < 1) currentPage = 1;
  
  // 計算當前頁面要顯示的資料
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageMembers = members.slice(startIndex, endIndex);
  
  // 批量生成 HTML（只生成當前頁）
  const html = pageMembers.map(m => `
    <tr>
      <td>${escapeHtml(m.name)}</td>
      <td>${escapeHtml(m.phone)}</td>
      <td><strong>${m.points}</strong></td>
      <td><span class="level-badge level-${m.memberLevel || 'BRONZE'}">${getLevelIcon(m.memberLevel)} ${getLevelName(m.memberLevel)}</span></td>
      <td><code style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${m.referralCode || 'N/A'}</code></td>
      <td>${m.referredBy ? `<code style="background: #fff3cd; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: #856404;">🎁 ${escapeHtml(m.referredBy)}</code>` : '<span style="color: #999;">-</span>'}</td>
      <td><strong style="color: #667eea;">${m.referralCount || 0}</strong> 人</td>
      <td>${m.status === 'active' ? '✅ 正常' : '⚠️ 停用'}</td>
      <td class="action-btns">
        <button class="btn-small btn-add" onclick='adjustMemberPoints("${escapeHtml(m.lineUserId)}", "${escapeHtml(m.name)}", ${m.points}, "add")'>➕</button>
        <button class="btn-small btn-deduct" onclick='adjustMemberPoints("${escapeHtml(m.lineUserId)}", "${escapeHtml(m.name)}", ${m.points}, "deduct")'>➖</button>
      </td>
    </tr>
  `).join('');
  
  // 一次性替換
  tbody.innerHTML = html;
  
  // 更新分頁資訊
  updateMemberCount(members.length, startIndex + 1, Math.min(endIndex, members.length));
  updatePagination(currentPage, totalPages);
}

// HTML 跳脫函數（防止 XSS）
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// 更新會員數量顯示（含分頁資訊）
function updateMemberCount(total, start, end) {
  const countDiv = document.getElementById('memberCount');
  if (countDiv) {
    const totalAll = allMembers ? allMembers.length : 0;
    if (total === totalAll) {
      countDiv.innerHTML = `📋 共 <strong>${total}</strong> 位會員 | 顯示第 <strong>${start}-${end}</strong> 位`;
    } else {
      countDiv.innerHTML = `🔍 搜尋到 <strong>${total}</strong> 位會員（共 ${totalAll} 位）| 顯示第 <strong>${start}-${end}</strong> 位`;
    }
  }
}

// 更新分頁按鈕
function updatePagination(current, total) {
  const paginationDiv = document.getElementById('pagination');
  if (!paginationDiv) return;
  
  if (total <= 1) {
    paginationDiv.style.display = 'none';
    return;
  }
  
  paginationDiv.style.display = 'flex';
  
  let html = `
    <button class="btn-small" ${current === 1 ? 'disabled' : ''} onclick="goToPage(1)">⏮️ 首頁</button>
    <button class="btn-small" ${current === 1 ? 'disabled' : ''} onclick="goToPage(${current - 1})">◀️ 上一頁</button>
    <span style="padding: 0 15px; font-weight: 600; color: #667eea;">第 ${current} / ${total} 頁</span>
    <button class="btn-small" ${current === total ? 'disabled' : ''} onclick="goToPage(${current + 1})">下一頁 ▶️</button>
    <button class="btn-small" ${current === total ? 'disabled' : ''} onclick="goToPage(${total})">末頁 ⏭️</button>
  `;
  
  paginationDiv.innerHTML = html;
}

// 跳轉到指定頁面
function goToPage(page) {
  currentPage = page;
  renderMembers(filteredMembers);
  // 滾動到表格頂部
  document.getElementById('members').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// 隱藏分頁
function hidePagination() {
  const paginationDiv = document.getElementById('pagination');
  if (paginationDiv) {
    paginationDiv.style.display = 'none';
  }
}

// 防抖函數 - 避免頻繁觸發
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// 篩選會員（實際執行）
function doFilterMembers() {
  const tbody = document.getElementById('membersList');
  const keyword = document.getElementById('searchInput').value.toLowerCase();
  
  // 重置到第一頁
  currentPage = 1;
  
  // 顯示載入狀態
  if (keyword) {
    tbody.style.opacity = '0.6';
  }
  
  // 使用 requestAnimationFrame 優化渲染
  requestAnimationFrame(() => {
    const filtered = allMembers.filter(m => 
      m.name.toLowerCase().includes(keyword) || 
      m.phone.includes(keyword)
    );
    renderMembers(filtered);
    tbody.style.opacity = '1';
  });
}

// 防抖版本的篩選函數（300ms 延遲）
const filterMembers = debounce(doFilterMembers, 300);

// 調整會員點數
function adjustMemberPoints(lineUserId, name, currentPoints, type) {
  document.getElementById('targetPhone').value = '';
  document.getElementById('adjustPoints').value = '';
  document.getElementById('reason').value = '';
  
  targetMember = { lineUserId, name, currentPoints, type };
  
  // 切換到點數調整分頁
  switchTab('points');
  document.querySelectorAll('.tab')[2].click();
  
  // 預填資訊
  document.getElementById('memberInfo').innerHTML = `
    <div style="padding: 10px; background: #e3f2fd; border-radius: 8px; margin-top: 10px;">
      <strong>${name}</strong><br>
      目前點數：${currentPoints} 點
    </div>
  `;
  
  // 設定操作類型
  document.querySelector(`input[value="${type}"]`).checked = true;
}

// 檢查會員
document.addEventListener('DOMContentLoaded', function() {
  const phoneInput = document.getElementById('targetPhone');
  if (phoneInput) {
    phoneInput.addEventListener('blur', async function() {
      const phone = this.value;
      if (!phone) return;
      
      try {
        const res = await fetch(`${API_URL}?action=check-user&phone=${phone}`);
        const data = await res.json();
        
        const infoDiv = document.getElementById('memberInfo');
        if (data.exists) {
          targetMember = {
            lineUserId: data.lineUserId,
            name: data.name,
            currentPoints: data.points || 0
          };
          infoDiv.innerHTML = `
            <div style="padding: 10px; background: #e8f5e9; border-radius: 8px; margin-top: 10px;">
              ✓ <strong>${data.name}</strong><br>
              目前點數：${data.points || 0} 點
            </div>
          `;
        } else {
          targetMember = null;
          infoDiv.innerHTML = `
            <div style="padding: 10px; background: #ffebee; border-radius: 8px; margin-top: 10px;">
              ✗ 查無此會員
            </div>
          `;
        }
      } catch (error) {
        console.error('查詢錯誤:', error);
      }
    });
    
    // 手機號碼格式化
    phoneInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 10) value = value.slice(0, 10);
      
      if (value.length >= 4) {
        value = value.slice(0, 4) + '-' + value.slice(4);
      }
      if (value.length >= 8) {
        value = value.slice(0, 8) + '-' + value.slice(8);
      }
      
      e.target.value = value;
    });
  }
});

// 設定調整數量
function setAdjustAmount(amount) {
  document.getElementById('adjustPoints').value = amount;
}

// 提交調整點數表單
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('adjustPointsForm');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!targetMember) {
        showMessage('adjustMessage', '請先輸入有效的會員手機號碼', 'error');
        return;
      }
      
      const adjustType = document.querySelector('input[name="adjustType"]:checked').value;
      const points = parseInt(document.getElementById('adjustPoints').value);
      const reason = document.getElementById('reason').value;
      
      if (!points || points < 1) {
        showMessage('adjustMessage', '請輸入有效的點數', 'error');
        return;
      }
      
      const actualPoints = adjustType === 'add' ? points : -points;
      const newPoints = targetMember.currentPoints + actualPoints;
      
      if (newPoints < 0) {
        showMessage('adjustMessage', '調整後點數不能為負數', 'error');
        return;
      }
      
      // 顯示確認視窗
      adjustData = {
        lineUserId: targetMember.lineUserId,
        points: actualPoints,
        reason: reason
      };
      
      document.getElementById('confirmMember').textContent = targetMember.name;
      document.getElementById('confirmCurrentPoints').textContent = targetMember.currentPoints;
      document.getElementById('confirmType').textContent = adjustType === 'add' ? '➕ 增加' : '➖ 扣除';
      document.getElementById('confirmAmount').textContent = points;
      document.getElementById('confirmNewPoints').textContent = newPoints;
      document.getElementById('confirmReason').textContent = reason;
      
      document.getElementById('confirmModal').classList.add('active');
    });
  }
});

// 確認調整
async function confirmAdjust() {
  closeModal();
  
  const btn = document.getElementById('adjustBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-small"></span> 處理中...';
  
  try {
    const params = new URLSearchParams({
      action: 'adjust-points',
      lineUserId: adjustData.lineUserId,
      points: adjustData.points,
      reason: adjustData.reason
    });
    
    const res = await fetch(`${API_URL}?${params.toString()}`, {
      method: 'GET'
    });
    
    const data = await res.json();
    
    if (data.success) {
      showMessage('adjustMessage', '✅ 調整成功！新點數：' + data.newPoints, 'success');
      
      // 重置表單
      document.getElementById('adjustPointsForm').reset();
      document.getElementById('memberInfo').innerHTML = '';
      targetMember = null;
      
      // 如果在會員列表，重新載入
      loadMembers();
    } else {
      showMessage('adjustMessage', '❌ ' + (data.message || '調整失敗'), 'error');
    }
  } catch (error) {
    console.error('調整錯誤:', error);
    showMessage('adjustMessage', '❌ 系統錯誤: ' + error.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="btn-icon">💰</span> 確認調整';
  }
}

// 關閉 Modal
function closeModal() {
  document.getElementById('confirmModal').classList.remove('active');
}

// 顯示訊息
function showMessage(elementId, msg, type) {
  const messageDiv = document.getElementById(elementId);
  messageDiv.textContent = msg;
  messageDiv.className = `message ${type}`;
  messageDiv.style.display = 'block';
  
  setTimeout(() => {
    messageDiv.style.display = 'none';
  }, 5000);
}

// 🎁 載入推薦統計
async function loadReferralStats() {
  try {
    const res = await fetch(`${API_URL}?action=referral-stats`);
    const data = await res.json();
    
    if (data.success) {
      // 更新總覽卡片
      document.getElementById('totalReferrals').textContent = data.totalReferrals || 0;
      document.getElementById('activeReferrers').textContent = data.activeReferrers || 0;
      document.getElementById('totalReferralRewards').textContent = (data.totalRewards || 0) + ' 點';
      document.getElementById('avgReferrals').textContent = (data.avgReferrals || 0).toFixed(1);
      
      // 更新儀表板卡片
      document.getElementById('dashboardReferrals').textContent = data.totalReferrals || 0;
      document.getElementById('dashboardActiveReferrers').textContent = data.activeReferrers || 0;
      
      // 渲染推薦排行榜
      renderReferralLeaderboard(data.leaderboard || []);
      
      // 渲染最近推薦記錄
      renderRecentReferrals(data.recentReferrals || []);
    }
  } catch (error) {
    console.error('載入推薦統計錯誤:', error);
  }
}

// 渲染推薦排行榜
function renderReferralLeaderboard(leaderboard) {
  const tbody = document.getElementById('referralLeaderboard');
  
  if (!leaderboard || leaderboard.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;">暫無推薦記錄</td></tr>';
    return;
  }
  
  tbody.innerHTML = leaderboard.map((item, index) => {
    const rankIcon = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : (index + 1);
    return `
      <tr>
        <td style="text-align:center; font-size:20px;"><strong>${rankIcon}</strong></td>
        <td><strong>${item.name}</strong></td>
        <td><code style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${item.referralCode}</code></td>
        <td><strong style="color: #667eea; font-size: 18px;">${item.count}</strong> 人</td>
        <td><strong style="color: #4CAF50;">${item.earned || 0}</strong> 點</td>
        <td class="action-btns">
          <button class="btn-small" style="background: #667eea; color: white;" onclick='viewMemberReferrals("${item.referralCode}", "${item.name}")'>查看詳情</button>
        </td>
      </tr>
    `;
  }).join('');
}

// 渲染最近推薦記錄
function renderRecentReferrals(referrals) {
  const tbody = document.getElementById('recentReferrals');
  
  if (!referrals || referrals.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;">暫無推薦記錄</td></tr>';
    return;
  }
  
  tbody.innerHTML = referrals.map(item => `
    <tr>
      <td><strong>${item.referrerName}</strong></td>
      <td><code style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${item.referralCode}</code></td>
      <td><strong>${item.newMemberName}</strong></td>
      <td><strong style="color: #4CAF50;">${item.rewardPoints || 50}</strong> 點</td>
      <td>${formatDate(item.createdAt)}</td>
    </tr>
  `).join('');
}

// 查看會員推薦詳情
function viewMemberReferrals(referralCode, name) {
  alert(`查看 ${name} (${referralCode}) 的推薦詳情\n\n功能開發中...`);
}

// 格式化日期
function formatDate(dateString) {
  if (!dateString) return '-';
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
}

// 載入設定
async function loadSettings() {
  // TODO: 從 Settings 工作表讀取
  console.log('載入設定...');
}

// 儲存設定
async function saveSettings() {
  showMessage('settingsMessage', '設定儲存功能開發中...', 'info');
}

// 執行每日統計
async function runDailyStats() {
  showMessage('statsMessage', '每日統計功能開發中...', 'info');
}

// 輔助函數
function getLevelIcon(level) {
  const icons = {
    'BRONZE': '🥉',
    'SILVER': '🥈',
    'GOLD': '🥇',
    'PLATINUM': '💎'
  };
  return icons[level] || '🥉';
}

function getLevelName(level) {
  const names = {
    'BRONZE': '銅級',
    'SILVER': '銀級',
    'GOLD': '金級',
    'PLATINUM': '白金'
  };
  return names[level] || '銅級';
}

initLiff();
</script>
</body>
</html>

