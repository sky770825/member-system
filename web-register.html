<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¨»å†Š - å…¬ç›Šæ…ˆå–„æœƒå“¡ç³»çµ±</title>
<link rel="stylesheet" href="./assets/style.css">
<style>
  body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
  }
  
  .register-container {
    max-width: 520px;
    margin: 0 auto;
  }
  
  .register-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    overflow: hidden;
  }
  
  .register-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 32px 24px;
    text-align: center;
  }
  
  .register-header h1 {
    margin: 0 0 8px 0;
    font-size: 28px;
  }
  
  .register-header p {
    margin: 0;
    font-size: 14px;
    opacity: 0.95;
    font-weight: 600;
  }
  
  .register-body {
    padding: 32px 24px;
  }
  
  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
  }
  
  @media (max-width: 600px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
  }
  
  .form-group-full {
    grid-column: 1 / -1;
  }
  
  .btn-register {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #FFB800, #E69500);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 8px;
  }
  
  .btn-register:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 184, 0, 0.4);
  }
  
  .btn-register:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  .login-link {
    text-align: center;
    margin-top: 20px;
    font-size: 14px;
    color: #666;
  }
  
  .login-link a {
    color: #667eea;
    font-weight: 600;
    text-decoration: none;
  }
  
  .password-strength {
    font-size: 12px;
    margin-top: 4px;
  }
  
  .password-strength.weak { color: #ff5252; }
  .password-strength.medium { color: #ffa726; }
  .password-strength.strong { color: #66bb6a; }
</style>
</head>
<body>
  <div class="register-container">
    <div class="register-card">
      <div class="register-header">
        <h1>æœƒå“¡è¨»å†Š</h1>
        <p>â¤ï¸ å®Œæˆè¨»å†Šå³è´ˆé€ <span style="color: #FFD700; font-weight: 800;">100</span> å…¬ç›Šé»æ•¸</p>
      </div>
      
      <div class="register-body">
        <div id="message" class="message"></div>
        
        <!-- æ¨è–¦ç¢¼å€åŸŸ -->
        <div class="form-group form-group-full" id="referralGroup" style="display: none;">
          <label>æ¨è–¦ç¢¼</label>
          <div style="display: flex; align-items: center; gap: 10px;">
            <input type="text" id="referralCode" readonly style="background: #f0f0f0;">
            <span id="referralStatus" style="color: #4CAF50; font-weight: bold;">âœ“ å·²ç¶å®š</span>
          </div>
          <div id="referralInfo" style="margin-top: 8px; font-size: 13px; color: #667eea;"></div>
        </div>
        
        <form id="registerForm" onsubmit="handleRegister(event)">
          <div class="form-grid">
            <div class="form-group">
              <label for="name">å§“å *</label>
              <input type="text" id="name" required placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
            </div>
            
            <div class="form-group">
              <label for="phone">æ‰‹æ©Ÿè™Ÿç¢¼ *</label>
              <input type="tel" id="phone" required placeholder="0912-345-678" pattern="[0-9]{4}-[0-9]{3}-[0-9]{3}">
            </div>
            
            <div class="form-group form-group-full">
              <label for="email">é›»å­éƒµä»¶ *</label>
              <input type="email" id="email" required placeholder="example@email.com">
            </div>
            
            <div class="form-group form-group-full">
              <label for="username">ç™»å…¥å¸³è™Ÿ *</label>
              <input type="text" id="username" required placeholder="è‡³å°‘ 4 å€‹å­—å…ƒ" minlength="4" autocomplete="username">
              <small>ç”¨æ–¼ç™»å…¥ï¼Œå»ºè­°ä½¿ç”¨è‹±æ–‡æˆ–æ•¸å­—çµ„åˆ</small>
            </div>
            
            <div class="form-group form-group-full">
              <label for="password">è¨­å®šå¯†ç¢¼ *</label>
              <input type="password" id="password" required placeholder="è‡³å°‘ 6 å€‹å­—å…ƒ" minlength="6" autocomplete="new-password" oninput="checkPasswordStrength()">
              <div id="passwordStrength" class="password-strength"></div>
            </div>
            
            <div class="form-group form-group-full">
              <label for="confirmPassword">ç¢ºèªå¯†ç¢¼ *</label>
              <input type="password" id="confirmPassword" required placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼" minlength="6" autocomplete="new-password">
            </div>
            
            <div class="form-group">
              <label for="birthday">ç”Ÿæ—¥ï¼ˆé¸å¡«ï¼‰</label>
              <input type="date" id="birthday">
            </div>
          </div>
          
          <button type="submit" class="btn-register" id="registerBtn">
            <span>âœ¨</span> å®Œæˆè¨»å†Š
          </button>
        </form>
        
        <div class="login-link">
          å·²ç¶“æœ‰å¸³è™Ÿäº†ï¼Ÿ<a href="login.html">ç«‹å³ç™»å…¥</a>
        </div>
      </div>
    </div>
  </div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzjGZOfhfd792G7hv-6wbyClTxcvD1n5zsxRQC6yfJatjKG5fTayhyz3EdhUNDDNQ96/exec';

let referralCode = '';

// æª¢æŸ¥ URL åƒæ•¸ä¸­çš„æ¨è–¦ç¢¼
window.addEventListener('load', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const ref = urlParams.get('ref');
  
  if (ref) {
    console.log('æª¢æ¸¬åˆ°æ¨è–¦ç¢¼:', ref);
    referralCode = ref;
    
    document.getElementById('referralGroup').style.display = 'block';
    document.getElementById('referralCode').value = ref;
    
    // é©—è­‰æ¨è–¦ç¢¼
    verifyReferralCode(ref);
  }
  
  // æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼åŒ–
  document.getElementById('phone').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 10) value = value.slice(0, 10);
    
    if (value.length >= 4) {
      value = value.slice(0, 4) + '-' + value.slice(4);
    }
    if (value.length >= 8) {
      value = value.slice(0, 8) + '-' + value.slice(8);
    }
    
    e.target.value = value;
  });
});

// é©—è­‰æ¨è–¦ç¢¼
async function verifyReferralCode(code) {
  try {
    const res = await fetch(`${API_URL}?action=verify-referral&referralCode=${code}`);
    const data = await res.json();
    
    if (data.success && data.referrer) {
      document.getElementById('referralInfo').innerHTML = 
        `â¤ï¸ ç”± <strong style="color: #667eea;">${data.referrer.name}</strong> æ¨è–¦åŠ å…¥å…¬ç›Šè¡Œåˆ—`;
    } else {
      document.getElementById('referralStatus').innerHTML = 'âš ï¸ ç„¡æ•ˆ';
      document.getElementById('referralStatus').style.color = '#FF6B6B';
      document.getElementById('referralInfo').innerHTML = 'æ¨è–¦ç¢¼ç„¡æ•ˆï¼Œå°‡ä»¥ä¸€èˆ¬æœƒå“¡èº«åˆ†åŠ å…¥';
    }
  } catch (error) {
    console.error('é©—è­‰æ¨è–¦ç¢¼å¤±æ•—:', error);
  }
}

// æª¢æŸ¥å¯†ç¢¼å¼·åº¦
function checkPasswordStrength() {
  const password = document.getElementById('password').value;
  const strengthDiv = document.getElementById('passwordStrength');
  
  if (password.length === 0) {
    strengthDiv.textContent = '';
    return;
  }
  
  let strength = 0;
  
  if (password.length >= 6) strength++;
  if (password.length >= 8) strength++;
  if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
  if (/[0-9]/.test(password)) strength++;
  if (/[^A-Za-z0-9]/.test(password)) strength++;
  
  if (strength <= 2) {
    strengthDiv.textContent = 'å¯†ç¢¼å¼·åº¦ï¼šå¼±';
    strengthDiv.className = 'password-strength weak';
  } else if (strength <= 4) {
    strengthDiv.textContent = 'å¯†ç¢¼å¼·åº¦ï¼šä¸­';
    strengthDiv.className = 'password-strength medium';
  } else {
    strengthDiv.textContent = 'å¯†ç¢¼å¼·åº¦ï¼šå¼·';
    strengthDiv.className = 'password-strength strong';
  }
}

// è™•ç†è¨»å†Š
async function handleRegister(event) {
  event.preventDefault();
  
  const password = document.getElementById('password').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  // æª¢æŸ¥å¯†ç¢¼æ˜¯å¦ä¸€è‡´
  if (password !== confirmPassword) {
    showMessage('å…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´', 'error');
    return;
  }
  
  const formData = {
    name: document.getElementById('name').value.trim(),
    phone: document.getElementById('phone').value.trim(),
    email: document.getElementById('email').value.trim(),
    birthday: document.getElementById('birthday').value,
    username: document.getElementById('username').value.trim(),
    password: password,
    referralCode: referralCode
  };
  
  const btn = document.getElementById('registerBtn');
  btn.disabled = true;
  btn.innerHTML = '<span>â³</span> è¨»å†Šä¸­...';
  
  try {
    // ğŸ” ä½¿ç”¨å®‰å…¨çš„ POST æ–¹å¼å‚³é€æ•æ„Ÿè³‡æ–™
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        action: 'register-password',
        name: formData.name,
        phone: formData.phone,
        email: formData.email,
        birthday: formData.birthday,
        username: formData.username,
        password: formData.password,
        referralCode: formData.referralCode
      })
    });
    const data = await res.json();
    
    if (data.success) {
      // å„²å­˜ Session
      localStorage.setItem('sessionToken', data.sessionToken);
      localStorage.setItem('user', JSON.stringify(data.user));
      localStorage.setItem('loginType', 'password');
      
      showMessage('ğŸ‰ è¨»å†ŠæˆåŠŸï¼å·²è´ˆé€ 100 å…¬ç›Šé»æ•¸ï¼Œæ­£åœ¨è·³è½‰...', 'success');
      
      setTimeout(() => {
        window.location.href = 'profile.html';
      }, 2000);
    } else {
      showMessage(data.message || 'è¨»å†Šå¤±æ•—', 'error');
      btn.disabled = false;
      btn.innerHTML = '<span>âœ¨</span> å®Œæˆè¨»å†Š';
    }
  } catch (error) {
    console.error('è¨»å†ŠéŒ¯èª¤:', error);
    showMessage('ç³»çµ±éŒ¯èª¤ï¼š' + error.message, 'error');
    btn.disabled = false;
    btn.innerHTML = '<span>âœ¨</span> å®Œæˆè¨»å†Š';
  }
}

function showMessage(msg, type) {
  const messageDiv = document.getElementById('message');
  messageDiv.textContent = msg;
  messageDiv.className = `message ${type}`;
  messageDiv.style.display = 'block';
  
  if (type === 'success') {
    setTimeout(() => {
      messageDiv.style.display = 'none';
    }, 3000);
  }
}
</script>
</body>
</html>

