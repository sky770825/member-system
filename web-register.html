<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>註冊 - 公益慈善會員系統</title>
<link rel="stylesheet" href="./assets/style.css">
<style>
  body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
  }
  
  .register-container {
    max-width: 520px;
    margin: 0 auto;
  }
  
  .register-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    overflow: hidden;
  }
  
  .register-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 32px 24px;
    text-align: center;
  }
  
  .register-header h1 {
    margin: 0 0 8px 0;
    font-size: 28px;
  }
  
  .register-header p {
    margin: 0;
    font-size: 14px;
    opacity: 0.95;
    font-weight: 600;
  }
  
  .register-body {
    padding: 32px 24px;
  }
  
  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
  }
  
  @media (max-width: 600px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
  }
  
  .form-group-full {
    grid-column: 1 / -1;
  }
  
  .btn-register {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #FFB800, #E69500);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 8px;
  }
  
  .btn-register:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 184, 0, 0.4);
  }
  
  .btn-register:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  .login-link {
    text-align: center;
    margin-top: 20px;
    font-size: 14px;
    color: #666;
  }
  
  .login-link a {
    color: #667eea;
    font-weight: 600;
    text-decoration: none;
  }
  
  .password-strength {
    font-size: 12px;
    margin-top: 4px;
  }
  
  .password-strength.weak { color: #ff5252; }
  .password-strength.medium { color: #ffa726; }
  .password-strength.strong { color: #66bb6a; }
</style>
</head>
<body>
  <div class="register-container">
    <div class="register-card">
      <div class="register-header">
        <h1>會員註冊</h1>
        <p>❤️ 完成註冊即贈送 <span style="color: #FFD700; font-weight: 800;">100</span> 公益點數</p>
      </div>
      
      <div class="register-body">
        <div id="message" class="message"></div>
        
        <!-- 推薦碼區域 -->
        <div class="form-group form-group-full" id="referralGroup" style="display: none;">
          <label>推薦碼</label>
          <div style="display: flex; align-items: center; gap: 10px;">
            <input type="text" id="referralCode" readonly style="background: #f0f0f0;">
            <span id="referralStatus" style="color: #4CAF50; font-weight: bold;">✓ 已綁定</span>
          </div>
          <div id="referralInfo" style="margin-top: 8px; font-size: 13px; color: #667eea;"></div>
        </div>
        
        <form id="registerForm" onsubmit="handleRegister(event)">
          <div class="form-grid">
            <div class="form-group">
              <label for="name">姓名 *</label>
              <input type="text" id="name" required placeholder="請輸入真實姓名">
            </div>
            
            <div class="form-group">
              <label for="phone">手機號碼 *</label>
              <input type="tel" id="phone" required placeholder="0912-345-678" pattern="[0-9]{4}-[0-9]{3}-[0-9]{3}">
            </div>
            
            <div class="form-group form-group-full">
              <label for="email">電子郵件 *</label>
              <input type="email" id="email" required placeholder="example@email.com">
            </div>
            
            <div class="form-group form-group-full">
              <label for="username">登入帳號 *</label>
              <input type="text" id="username" required placeholder="至少 4 個字元" minlength="4" autocomplete="username">
              <small>用於登入，建議使用英文或數字組合</small>
            </div>
            
            <div class="form-group form-group-full">
              <label for="password">設定密碼 *</label>
              <input type="password" id="password" required placeholder="至少 6 個字元" minlength="6" autocomplete="new-password" oninput="checkPasswordStrength()">
              <div id="passwordStrength" class="password-strength"></div>
            </div>
            
            <div class="form-group form-group-full">
              <label for="confirmPassword">確認密碼 *</label>
              <input type="password" id="confirmPassword" required placeholder="再次輸入密碼" minlength="6" autocomplete="new-password">
            </div>
            
            <div class="form-group">
              <label for="birthday">生日（選填）</label>
              <input type="date" id="birthday">
            </div>
          </div>
          
          <button type="submit" class="btn-register" id="registerBtn">
            <span>✨</span> 完成註冊
          </button>
        </form>
        
        <div class="login-link">
          已經有帳號了？<a href="login.html">立即登入</a>
        </div>
      </div>
    </div>
  </div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzjGZOfhfd792G7hv-6wbyClTxcvD1n5zsxRQC6yfJatjKG5fTayhyz3EdhUNDDNQ96/exec';

let referralCode = '';

// 檢查 URL 參數中的推薦碼
window.addEventListener('load', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const ref = urlParams.get('ref');
  
  if (ref) {
    console.log('檢測到推薦碼:', ref);
    referralCode = ref;
    
    document.getElementById('referralGroup').style.display = 'block';
    document.getElementById('referralCode').value = ref;
    
    // 驗證推薦碼
    verifyReferralCode(ref);
  }
  
  // 手機號碼格式化
  document.getElementById('phone').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 10) value = value.slice(0, 10);
    
    if (value.length >= 4) {
      value = value.slice(0, 4) + '-' + value.slice(4);
    }
    if (value.length >= 8) {
      value = value.slice(0, 8) + '-' + value.slice(8);
    }
    
    e.target.value = value;
  });
});

// 驗證推薦碼
async function verifyReferralCode(code) {
  try {
    const res = await fetch(`${API_URL}?action=verify-referral&referralCode=${code}`);
    const data = await res.json();
    
    if (data.success && data.referrer) {
      document.getElementById('referralInfo').innerHTML = 
        `❤️ 由 <strong style="color: #667eea;">${data.referrer.name}</strong> 推薦加入公益行列`;
    } else {
      document.getElementById('referralStatus').innerHTML = '⚠️ 無效';
      document.getElementById('referralStatus').style.color = '#FF6B6B';
      document.getElementById('referralInfo').innerHTML = '推薦碼無效，將以一般會員身分加入';
    }
  } catch (error) {
    console.error('驗證推薦碼失敗:', error);
  }
}

// 檢查密碼強度
function checkPasswordStrength() {
  const password = document.getElementById('password').value;
  const strengthDiv = document.getElementById('passwordStrength');
  
  if (password.length === 0) {
    strengthDiv.textContent = '';
    return;
  }
  
  let strength = 0;
  
  if (password.length >= 6) strength++;
  if (password.length >= 8) strength++;
  if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
  if (/[0-9]/.test(password)) strength++;
  if (/[^A-Za-z0-9]/.test(password)) strength++;
  
  if (strength <= 2) {
    strengthDiv.textContent = '密碼強度：弱';
    strengthDiv.className = 'password-strength weak';
  } else if (strength <= 4) {
    strengthDiv.textContent = '密碼強度：中';
    strengthDiv.className = 'password-strength medium';
  } else {
    strengthDiv.textContent = '密碼強度：強';
    strengthDiv.className = 'password-strength strong';
  }
}

// 處理註冊
async function handleRegister(event) {
  event.preventDefault();
  
  const password = document.getElementById('password').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  // 檢查密碼是否一致
  if (password !== confirmPassword) {
    showMessage('兩次密碼輸入不一致', 'error');
    return;
  }
  
  const formData = {
    name: document.getElementById('name').value.trim(),
    phone: document.getElementById('phone').value.trim(),
    email: document.getElementById('email').value.trim(),
    birthday: document.getElementById('birthday').value,
    username: document.getElementById('username').value.trim(),
    password: password,
    referralCode: referralCode
  };
  
  const btn = document.getElementById('registerBtn');
  btn.disabled = true;
  btn.innerHTML = '<span>⏳</span> 註冊中...';
  
  try {
    // 🔐 使用安全的 POST 方式傳送敏感資料
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        action: 'register-password',
        name: formData.name,
        phone: formData.phone,
        email: formData.email,
        birthday: formData.birthday,
        username: formData.username,
        password: formData.password,
        referralCode: formData.referralCode
      })
    });
    const data = await res.json();
    
    if (data.success) {
      // 儲存 Session
      localStorage.setItem('sessionToken', data.sessionToken);
      localStorage.setItem('user', JSON.stringify(data.user));
      localStorage.setItem('loginType', 'password');
      
      showMessage('🎉 註冊成功！已贈送 100 公益點數，正在跳轉...', 'success');
      
      setTimeout(() => {
        window.location.href = 'profile.html';
      }, 2000);
    } else {
      showMessage(data.message || '註冊失敗', 'error');
      btn.disabled = false;
      btn.innerHTML = '<span>✨</span> 完成註冊';
    }
  } catch (error) {
    console.error('註冊錯誤:', error);
    showMessage('系統錯誤：' + error.message, 'error');
    btn.disabled = false;
    btn.innerHTML = '<span>✨</span> 完成註冊';
  }
}

function showMessage(msg, type) {
  const messageDiv = document.getElementById('message');
  messageDiv.textContent = msg;
  messageDiv.className = `message ${type}`;
  messageDiv.style.display = 'block';
  
  if (type === 'success') {
    setTimeout(() => {
      messageDiv.style.display = 'none';
    }, 3000);
  }
}
</script>
</body>
</html>

